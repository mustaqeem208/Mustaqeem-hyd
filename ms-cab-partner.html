<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MS Partner - Professional</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* ---------- Base Styles & Smooth Look ---------- */
        body { margin:0; font-family: 'Segoe UI', Roboto, Arial, sans-serif; height:100vh; overflow:hidden; background:#0a0a0a; color:#f0f0f0; }

        /* Login Screen */
        #dLoginScreen { position:fixed; inset:0; background:#0a0a0a; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; }
        .logo { font-size: 3rem; color: #d4af37; font-weight: 900; margin-bottom: 30px; letter-spacing: 2px; }
        .d-inp { 
            width:80%; padding:18px; border-radius:10px; border:1px solid #444; 
            background:#181818; color:#fff; text-align:center; margin-bottom:20px; 
            font-size:1.2rem; font-weight: bold;
        }
        .d-btn { 
            width:85%; padding:18px; border-radius:10px; border:none; 
            background:#d4af37; color:#000; font-weight:bold; cursor:pointer; 
            font-size:1.2rem; transition: background 0.3s;
        }

        #dApp { display:none; height:100vh; width:100%; flex-direction:column; }
        #map { height:100%; width:100%; background: #ffffff; }

        /* Vehicle Icons */
        .driver-icon-container {
            width:56px; height:56px; border-radius:14px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.6), inset 0 -6px 10px rgba(0,0,0,0.08); 
            font-size:28px; transform: translateY(-6px); 
            border: 2px solid rgba(0,0,0,0.6); 
            background: linear-gradient(180deg, #FFF4B0 0%, #FFC843 60%); 
            position: relative; display:flex; align-items:center; justify-content:center;
        }

        .request-icon-container {
            width: 50px; height: 50px; border-radius: 50%;
            background: #007bff; color: white; font-size: 26px;
            border: 3px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            display: flex; align-items: center; justify-content: center;
        }

        /* Online/Offline Button (Professional Border) */
        #toggleDutyBtn {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2002;
            padding: 14px 25px; border-radius: 50px; font-weight: bold; cursor: pointer;
            transition: background 0.4s ease-in-out, border 0.4s; box-shadow: 0 6px 15px rgba(0,0,0,0.6);
            border: 2px solid; min-width: 150px;
        }

        .online-btn { background: linear-gradient(145deg, #2ecc71, #27ae60); color: white; border-color: #f0f0f0; }
        .offline-btn { background: linear-gradient(145deg, #e74c3c, #c0392b); color: white; border-color: #d4af37; }

        .recenter-btn { position: absolute; bottom: 300px; right: 20px; width: 48px; height: 48px; background: white; color: black; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.6rem; cursor: pointer; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        .card { 
            position: absolute; left:10px; right:10px; bottom:20px; 
            background: rgba(20,20,20,0.95); border-radius:20px; padding:20px; 
            z-index:1001; border:1px solid #333; display:none; 
            box-shadow: 0 15px 50px rgba(0,0,0,0.8); backdrop-filter: blur(15px); 
        }
        
        .fare-txt { font-size: 3.2rem; font-weight: 800; color: #d4af37; margin-bottom: 5px; }
        
        /* Pickup Card/OTP Section Styles (Large and Clear) */
        .otp-box { margin-top: 15px; background: #111; padding: 20px; border-radius: 10px; border: 1px solid #d4af37; }
        .otp-row { display: flex; gap: 15px; margin-top: 10px; align-items: center; }
        .otp-inp { 
            flex: 1; padding: 15px; height: 60px; text-align: center; 
            font-size: 1.8rem; letter-spacing: 5px; background: #000; 
            border: 2px solid #d4af37; color: white; border-radius: 8px; 
            font-weight: bold;
        }
        .go-btn { padding: 0 30px; background: #d4af37; color: black; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; height: 60px; font-size: 1.2rem; }

        /* Pickup/Drop card button styles */
        .map-nav-btn {
            display:block; background: linear-gradient(145deg, #007bff, #0056b3); color:white; 
            text-align:center; padding:12px; border-radius:10px; text-decoration:none; 
            font-weight:bold; margin-bottom:10px; font-size:1.1rem; border: none; 
            width: 100%; cursor: pointer; box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }
        
        .contact-btn {
            display:block; background: linear-gradient(145deg, #2ecc71, #27ae60); color:white; 
            text-align:center; padding:15px; border-radius:10px; text-decoration:none; 
            font-weight:bold; margin-bottom:10px; font-size:1.1rem; border: none; 
            width: 100%; cursor: pointer; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
        }

        .finish-btn { display:block; background:#000; color:#d4af37; border: 1px solid #d4af37; text-align:center; padding:12px; border-radius:10px; font-weight:bold; font-size:1.1rem; width: 100%; cursor: pointer;}
        
        /* Menu/SOS styles */
        #mainMenuBtn { position: absolute; top: 18px; left: 18px; z-index: 2001; background: rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.06); padding:12px 14px; border-radius:12px; cursor:pointer; color:#fff; font-weight:800; }
        #menuBox { position: absolute; top: 70px; left: 18px; z-index: 2001; display:none; background:rgba(8,8,8,0.95); border:1px solid rgba(255,255,255,0.04); padding:10px; border-radius:12px; width:240px; }
        .menu-item { padding:10px 12px; border-radius:8px; cursor:pointer; color:#d4af37; font-weight:700; margin-bottom:6px; background:rgba(255,255,255,0.03); }
        .menu-sub { font-size:0.9rem; color:#aaa; font-weight:500; margin-left:6px; }

        .help-btn { position: absolute; top: 20px; right: 20px; background: red; color: white; font-weight: bold; padding: 8px 15px; border-radius: 50px; z-index: 2000; display: none; border: 2px solid white; cursor: pointer; }

        /* Emergency Modal Fixes (Clean Look) */
        .call-opt {
            display: block; background: #f0f0f0; color: #222; text-align: center; padding: 15px; 
            border-radius: 10px; text-decoration: none; font-weight: bold; margin-bottom: 15px; 
            font-size: 1.2rem; border: 2px solid; transition: background 0.2s;
        }
        
        /* History Modal Styles (Scrollable & Centered) */
        #histModal { position: fixed; inset: 0; display:none; align-items:center; justify-content:center; z-index:3000; background: rgba(0,0,0,0.8); }
        #histModal .modal-card { 
            background: #1f1f1f; padding:25px; border-radius:15px; width:90%; max-width:550px; 
            border:1px solid #444; color:#fff; max-height: 80vh; display: flex; flex-direction: column;
        }
        .modal-list { overflow-y: auto; margin-top:15px; flex-grow: 1; padding-right: 5px; }
        .hist-row { padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; gap:10px; align-items: center; }
        .hist-row:last-child { border-bottom: none; }


        /* Bill Modal Styles */
        #billModal { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .bill-box { 
            background: linear-gradient(160deg, #1f1f1f 0%, #0a0a0a 100%); 
            color: #fff; padding: 40px 30px; border-radius: 20px; width: 85%; max-width: 400px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8), inset 0 0 0 3px #d4af37; 
            border: 1px solid #444;
            animation: fadeIn 0.5s ease-out;
        }
        .total-fare { font-size: 4.5rem; font-weight: 900; color: #2ecc71; margin: 20px 0 35px 0; text-shadow: 0 0 10px rgba(46, 204, 113, 0.6); letter-spacing: -2px; }
        
        /* Footer Style */
        #footer {
            position: absolute; bottom: 0; left: 0; right: 0; text-align: center;
            padding: 8px 0; background: rgba(0,0,0,0.8); color: #d4af37;
            font-size: 0.8rem; z-index: 1000; font-weight: 500; letter-spacing: 1px;
        }

    </style>
</head>
<body>

    <audio id="ringtone" src="https://media.geeksforgeeks.org/wp-content/uploads/20190531135120/beep.mp3" loop></audio>

    <div id="helpBtn" class="help-btn" onclick="openHelp()">üÜò HELP</div>

    <div id="helpModal" class="modal">
        <div class="help-box modal-card">
            <h2 style="color:red; margin-top:0;">üö® EMERGENCY HELP üö®</h2>
            <a href="tel:100" class="call-opt" style="border-color:#3498db; color:#3498db; background:#ecf0f1;">üëÆ POLICE (100)</a>
            <a href="tel:9381667208" class="call-opt" style="border-color:#d4af37; color:#d4af37; background:#fcf8e3;">üë§ MUSTAQEEM (Founder)</a>
            <button onclick="closeHelp()" style="margin-top:15px; padding:12px 30px; background:#333; color:white; border:none; border-radius:10px; font-size:1rem;">CLOSE</button>
        </div>
    </div>

    <div id="dLoginScreen">
        <div class="logo">MS PARTNER</div>
        <input id="dPhone" class="d-inp" type="tel" placeholder="Enter Mobile Number"> 
        <button class="d-btn" onclick="startDuty()">START DUTY</button>
        <p style="color:#999; font-size:0.9rem; margin-top:15px;">One-time login ‚Äî will keep you logged in until you choose to Logout (Clear).</p>
    </div>

    <div id="dApp">
        <div id="mainMenuBtn" onclick="toggleMenu()">‚ò∞ MENU</div>
        
        <button id="toggleDutyBtn" class="offline-btn" onclick="toggleDuty()">GO ONLINE</button>

        <div id="menuBox">
            <div class="menu-item" onclick="showTodayEarnings()">Today Earnings <span class="menu-sub" id="earnTodaySub"></span></div>
            <div class="menu-item" onclick="showPartnerHistory()">History</div>
            <div class="menu-item" onclick="openVehicleChange()">Change Vehicle</div>
            <div class="menu-item" onclick="logoutAndClear()">Logout (Clear)</div> 
        </div>

        <div id="map"></div>
        <div class="recenter-btn" onclick="recenterMap()">üéØ</div>

        <div id="reqPopup" class="card">
            <div style="color:#fff; font-weight:bold; margin-bottom:5px;">NEW RIDE REQUEST üîî</div>
            <div class="fare-txt">‚Çπ<span id="fareDisplay">0</span></div>
            <div class="info-row">
                <div class="info-col"><div class="lbl">PICKUP DIST</div><div class="val" id="pickupDist">...</div></div>
                <div class="info-col"><div class="lbl">TRIP DIST</div><div class="val" id="tripDist">...</div></div>
            </div>
            <div class="btn-row">
                <button class="skip-btn" onclick="skipRide()">SKIP ‚úï</button>
                <button class="accept-btn" onclick="tryAcceptRide()">ACCEPT ‚úì</button>
            </div>
        </div>

        <div id="pickupCard" class="card" style="border-top: 4px solid yellow;">
            <div style="color:yellow; font-weight:bold; margin-bottom:5px;">HEADING TO PICKUP üü°</div>
            <div style="color:#aaa; font-size:0.8rem;">CUSTOMER MOBILE</div>
            <div id="custMobDisp" style="font-size:1.4rem; font-weight:bold; color:white; margin-bottom:10px;">...</div>
            
            <button id="mapNavBtnPickup" class="map-nav-btn" onclick="openPickupMap()">üó∫Ô∏è GO TO PICKUP</button>
            <button id="callBtn" class="contact-btn" onclick="callCustomer()">üìû CALL CUSTOMER</button>
            
            <div class="otp-box">
                <div style="color:#d4af37; font-size:1rem; font-weight: bold; margin-bottom: 5px;">ENTER OTP TO START TRIP</div>
                <div class="otp-row">
                    <input type="number" id="otpIn" class="otp-inp" placeholder="XXXX">
                    <button class="go-btn" onclick="verifyOtp()">START</button>
                </div>
            </div>

            <button onclick="cancelRide()" style="width:100%; margin-top:15px; background:red; color:white; border:none; padding:12px; font-weight:bold; border-radius:10px;">CANCEL RIDE</button>
        </div>

        <div id="dropCard" class="card" style="border-top: 4px solid green;">
            <div style="color:green; font-weight:bold; margin-bottom:5px;">ON TRIP üü¢</div>
            <p style="color:#ccc;">Navigating to Drop Location...</p>
            <h2 style="color:#d4af37; margin:10px 0;">Follow Map Route</h2>
            <button id="mapNavBtnDrop" class="map-nav-btn" onclick="openDropMap()">üó∫Ô∏è GO TO DROP</button>
            <button class="finish-btn" onclick="completeRide()">END TRIP & GET BILL</button>
        </div>

        <div id="vehicleModal" class="modal">
            <div class="modal-card">
                <h3 style="margin:0 0 15px 0; color:#d4af37;">Select Vehicle Type</h3>
                <div style="display:flex;gap:12px;">
                    <button class="accept-btn" onclick="chooseVehicle('car')">Car üöó</button>
                    <button class="accept-btn" onclick="chooseVehicle('auto')">Auto üõ∫</button>
                    <button class="accept-btn" onclick="chooseVehicle('bike')">Bike üèçÔ∏è</button>
                </div>
                <div style="margin-top:15px; text-align:right;">
                    <button onclick="closeVehicleModal()" class="skip-btn">CLOSE</button>
                </div>
            </div>
        </div>

        <div id="earnModal" class="modal">
            <div class="modal-card">
                <h3 style="margin:0 0 10px 0; color:#d4af37;">Today's Earnings</h3>
                <div id="earnContent" style="font-size:1.6rem; font-weight:800; margin-top:12px;">‚Çπ0</div>
                <div style="margin-top:14px; text-align:right;">
                    <button onclick="closeEarnModal()" class="skip-btn">CLOSE</button>
                </div>
            </div>
        </div>

        <div id="histModal" class="modal">
            <div class="modal-card">
                <h3 style="margin:0 0 10px 0; color:#d4af37;">My Rides History</h3>
                <div id="histList" class="modal-list"></div>
                <div style="margin-top:15px; text-align:center;">
                    <button onclick="closeHistModal()" class="skip-btn" style="width:100%;">CLOSE</button>
                </div>
            </div>
        </div>

    </div>

    <div id="billModal" style="display:none;">
        <div class="bill-box">
            <h2>TRIP COMPLETED ‚úÖ</h2>
            <p style="color:#aaa; font-size:1.1rem; font-weight:500;">Collect Cash from Customer</p>
            <div class="total-fare" id="billAmount">‚Çπ0</div> 
            <button class="accept-btn" onclick="closeBillAndNext()">COMPLETE & NEXT</button>
        </div>
    </div>

    <div id="footer">
        Design by ·ó∞·ëå·îïT·ó©·ë´EE·ó∞
    </div>


    <div id="customDialog" style="display:none; position:fixed; inset:0; z-index:6000; background: rgba(0,0,0,0.45); align-items:center; justify-content:center;">
      <div id="customDialogCard" style="width:90%; max-width:420px; background:#fff; padding:18px; border-radius:12px; box-shadow:0 15px 40px rgba(0,0,0,0.6); color:#000;">
        <div id="customDialogTitle" style="font-weight:800; color:#222; margin-bottom:8px; font-size:16px;">Message</div>
        <div id="customDialogMessage" style="color:#333; line-height:1.4; white-space:pre-wrap; margin-bottom:18px;">Body</div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
          <button id="customDialogCancel" style="background:transparent; border:none; color:#007bff; font-weight:700; padding:8px 12px; border-radius:6px;">CANCEL</button>
          <button id="customDialogOk" style="background:#007bff; border:none; color:#fff; font-weight:800; padding:8px 12px; border-radius:6px;">OK</button>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCJpo25tYCN_fXP8aCckgA4WrD962KCsQ8",
        authDomain: "hyd-texi.firebaseapp.com",
        projectId: "hyd-texi",
        storageBucket: "hyd-texi.firebasestorage.app",
        messagingSenderId: "807048727786",
        appId: "1:807048727786:web:7ef03573876c70b76e1b93",
        databaseURL: "https://hyd-texi-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let map, driverMarker, driverLat, driverLng, driverMobile;
    let currentReqKey, currentReqData, routeLine, pickupMarker, dropMarker, reqVehicleMarker;
    let followDriver = true;
    let gpsWatchId = null;
    let isRequesting = false;
    let partnerObj = null; 
    let isOnline = false;

    // --- Utility Helpers (Dialogs and Speech) ---
    const customDialog = document.getElementById('customDialog');
    const customDialogTitle = document.getElementById('customDialogTitle');
    const customDialogMessage = document.getElementById('customDialogMessage');
    const customDialogOk = document.getElementById('customDialogOk');
    const customDialogCancel = document.getElementById('customDialogCancel');

    function showCustomConfirm(title, message, onOk, onCancel) {
        customDialogTitle.innerText = title || 'Confirm';
        customDialogMessage.innerText = message || '';
        customDialog.style.display = 'flex';
        customDialogOk.style.display = 'inline-block';
        customDialogCancel.style.display = 'inline-block';
        function cleanup() { customDialog.style.display = 'none'; customDialogOk.removeEventListener('click', okHandler); customDialogCancel.removeEventListener('click', cancelHandler); }
        function okHandler() { cleanup(); if (onOk) onOk(); }
        function cancelHandler() { cleanup(); if (onCancel) onCancel(); }
        customDialogOk.addEventListener('click', okHandler);
        customDialogCancel.addEventListener('click', cancelHandler);
    }
    function showCustomAlert(title, message, onOk) {
        customDialogTitle.innerText = title || 'Alert';
        customDialogMessage.innerText = message || '';
        customDialog.style.display = 'flex';
        customDialogCancel.style.display = 'none';
        customDialogOk.style.display = 'inline-block';
        function cleanup() { customDialog.style.display = 'none'; customDialogOk.removeEventListener('click', okHandler); }
        function okHandler() { cleanup(); if (onOk) onOk(); }
        customDialogOk.addEventListener('click', okHandler);
    }
    function speak(text) {
        try { if (window.Android && typeof window.Android.speak === 'function') { window.Android.speak(text); return; } } catch(e){}
        if ('speechSynthesis' in window) { try { window.speechSynthesis.cancel(); const ut = new SpeechSynthesisUtterance(text); ut.lang = 'en-US'; ut.rate = 1.0; ut.pitch = 1.0; window.speechSynthesis.speak(ut); return; } catch(err){} }
        try { const r = document.getElementById('ringtone'); if (r) { r.play().catch(()=>{}); setTimeout(()=>{ try{ r.pause(); r.currentTime=0; }catch(e){} },1400); } } catch(e){}
    }
    
    // Get Emoji based on vehicle type
    function getVehicleEmoji(type, isReq = false) {
        let emoji = 'üöó';
        switch (type) {
            case 'car': emoji = 'üöó'; break;
            case 'auto': emoji = 'üõ∫'; break;
            case 'bike': emoji = 'üèçÔ∏è'; break;
        }
        if (isReq) return `<div class='request-icon-container'>${emoji}</div>`;
        return `<div class='driver-icon-container'>${emoji}</div>`;
    }

    // Update driver marker with current vehicle type
    function updateDriverIcon() {
        if (!map) return;
        const vType = partnerObj && partnerObj.vehicleType ? partnerObj.vehicleType : 'car';
        const carHtml = getVehicleEmoji(vType, false);
        const carDivIcon = L.divIcon({ html: carHtml, className: '', iconSize: [56,56], iconAnchor: [28,56], popupAnchor: [0,-40] });
        if (driverMarker) {
            driverMarker.setIcon(carDivIcon);
            driverMarker.getPopup().setContent(`Your ${vType.toUpperCase()} ${getVehicleEmoji(vType, false)}`);
        }
    }


    // Autologin Check and Default Number Setup
    async function checkAutoLogin() {
        const saved = localStorage.getItem('msPartnerMobile');
        const dPhoneInput = document.getElementById('dPhone');
        
        if (saved) {
            dPhoneInput.value = saved; 
            driverMobile = saved;
            
            document.getElementById('dLoginScreen').style.display = 'none';
            document.getElementById('dApp').style.display = 'flex';
            document.getElementById('helpBtn').style.display = 'block';
            
            initializeMap([17.3850, 78.4867], 13);
            startGPSCheck();
            await loadPartnerProfile(saved);

        } else {
            dPhoneInput.placeholder = "Enter Mobile Number (e.g., 9381667208)";
        }
    }

    // Load Profile (Used in startDuty and checkAutoLogin)
    async function loadPartnerProfile(mobile) {
        try {
            const snap = await db.ref('partners/' + mobile).once('value');
            const data = snap.val();
            
            if (!data || !data.vehicleType || !data.partnerId) {
                partnerObj = data || {};
                partnerObj.partnerId = partnerObj.partnerId || ('P' + (Math.floor(100000 + Math.random()*900000)));
                partnerObj.mobile = mobile;
                partnerObj.vehicleType = partnerObj.vehicleType || 'car';
                await db.ref('partners/' + mobile).update(partnerObj);
                updateDriverIcon();
            } else {
                partnerObj = data;
                updateDriverIcon();
                isOnline = partnerObj.isOnline || false; 

                if(isOnline) {
                    toggleDutyBtn.classList.remove('offline-btn'); toggleDutyBtn.classList.add('online-btn');
                    toggleDutyBtn.innerText = 'GO OFFLINE';
                    startListening();
                    speak("Service started. Welcome back partner. You are currently ONLINE.");
                } else {
                    speak("Service started. Welcome back partner. You are currently OFFLINE. Tap the button to GO ONLINE.");
                }
            }

        } catch(err){
            console.warn("Profile load err", err);
            partnerObj = { partnerId: 'P' + (Math.floor(100000 + Math.random()*900000)), mobile: mobile, vehicleType: 'car' };
            db.ref('partners/' + mobile).set(partnerObj);
            updateDriverIcon();
        }
    }

    // START DUTY: login + profile load + GPS + listen
    async function startDuty() {
        const num = document.getElementById('dPhone').value.trim();
        if (num.length < 10) return showCustomAlert('Invalid', 'Enter a valid mobile number');
        driverMobile = num;
        localStorage.setItem('msPartnerMobile', driverMobile); // Save for permanent login

        document.getElementById('dLoginScreen').style.display = 'none';
        document.getElementById('dApp').style.display = 'flex';
        document.getElementById('helpBtn').style.display = 'block';
        initializeMap([17.3850, 78.4867], 13);
        startGPSCheck();
        
        await loadPartnerProfile(driverMobile);
        // If vehicle type is still missing after loading profile, prompt user
        if (!partnerObj || !partnerObj.vehicleType) {
             openVehicleModal();
        }
    }
    
    // Call auto-login check when script loads
    checkAutoLogin();

    // NEW: Toggle Online/Offline
    const toggleDutyBtn = document.getElementById('toggleDutyBtn');
    function toggleDuty() {
        if (!partnerObj || !partnerObj.vehicleType) {
            speak("Please select your vehicle type first.");
            return openVehicleModal();
        }

        isOnline = !isOnline;
        if (isOnline) {
            // GO ONLINE
            db.ref('partners/' + driverMobile + '/isOnline').set(true);
            toggleDutyBtn.classList.remove('offline-btn');
            toggleDutyBtn.classList.add('online-btn');
            toggleDutyBtn.innerText = 'GO OFFLINE';
            startListening();
            speak("You are now ONLINE. Waiting for requests.");
        } else {
            // GO OFFLINE
            db.ref('partners/' + driverMobile + '/isOnline').set(false);
            toggleDutyBtn.classList.remove('online-btn');
            toggleDutyBtn.classList.add('offline-btn');
            toggleDutyBtn.innerText = 'GO ONLINE';
            stopListening();
            if(isRequesting) skipRide(); 
            speak("You are now OFFLINE. Duty ended.");
        }
    }

    // MAP init
    function initializeMap(initialLatlng, initialZoom) {
        if (map) return;
        const carHtml = getVehicleEmoji(partnerObj ? partnerObj.vehicleType : 'car', false);
        const carDivIcon = L.divIcon({ html: carHtml, className: '', iconSize: [56,56], iconAnchor: [28,56], popupAnchor: [0,-40] });
        map = L.map('map', {zoomControl: false}).setView(initialLatlng, initialZoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);
        driverMarker = L.marker(initialLatlng, {icon: carDivIcon, draggable: true}).addTo(map).bindPopup("Your Vehicle");
        driverMarker.on('dragend', (e) => {
            const newLoc = driverMarker.getLatLng();
            driverLat = newLoc.lat; driverLng = newLoc.lng; followDriver = false; speak("Location set.");
            if (driverMobile) db.ref('partners/' + driverMobile + '/lastSeen').set({lat:driverLat,lng:driverLng,ts:Date.now()});
        });
        map.on('dragstart', () => { followDriver = false; });
        driverLat = initialLatlng[0]; driverLng = initialLatlng[1];
    }

    const GPS_HELP_TEXT = "Your GPS location cannot be accessed. Don't worry ‚Äî just drag the car icon to where you are and you will start receiving bookings.";

    function startGPSCheck() {
        if (!navigator.geolocation) {
            showCustomAlert('GPS Not Supported', GPS_HELP_TEXT); speak(GPS_HELP_TEXT); return;
        }
        navigator.geolocation.getCurrentPosition((pos) => {
            const lat = pos.coords.latitude; const lng = pos.coords.longitude;
            driverLat = lat; driverLng = lng; if(driverMarker) driverMarker.setLatLng([lat,lng]); if(map) map.setView([lat,lng],16);
            if (!gpsWatchId) gpsWatchId = navigator.geolocation.watchPosition(onPositionUpdate, onGPSError, {enableHighAccuracy:true});
        }, (err) => {
            console.warn("GPS initial error:", err);
            showCustomAlert('GPS Unavailable', GPS_HELP_TEXT); speak(GPS_HELP_TEXT);
            if (!gpsWatchId) gpsWatchId = navigator.geolocation.watchPosition(onPositionUpdate, onGPSError, {enableHighAccuracy:true});
        }, {enableHighAccuracy:true, timeout:5000});
    }

    function onPositionUpdate(pos) {
        driverLat = pos.coords.latitude; driverLng = pos.coords.longitude;
        if(driverMarker) driverMarker.setLatLng([driverLat, driverLng]);
        if(followDriver && map) map.panTo([driverLat, driverLng]);
        if (driverMobile) db.ref('partners/' + driverMobile + '/lastSeen').set({lat:driverLat,lng:driverLng,ts:Date.now()});
    }

    function onGPSError(err) {
        console.error("GPS watch error:", err);
        followDriver = false;
        if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; }
        showCustomAlert('GPS Signal Lost', GPS_HELP_TEXT);
        speak(GPS_HELP_TEXT);
    }

    function recenterMap() {
        followDriver = true;
        if(driverLat && driverLng) { const newZoom = map.getZoom() < 14 ? 16 : map.getZoom(); map.setView([driverLat, driverLng], newZoom); speak("Centered on your location."); }
        else { const center = map.getCenter(); driverLat = center.lat; driverLng = center.lng; if(driverMarker) driverMarker.setLatLng([driverLat, driverLng]); map.setView([driverLat, driverLng], map.getZoom()); speak("Location set to map center."); }
    }
    
    // Map opening function for Pickup
    function openPickupMap() {
        if (!currentReqData || !driverLat || !driverLng) return showCustomAlert('Error', 'Location data missing.');
        const pLat = currentReqData.pickupLat; const pLng = currentReqData.pickupLng;
        const navUrl = `https://www.google.com/maps/dir/${driverLat},${driverLng}/${pLat},${pLng}/data=!4m2!4m1!3e0`;
        window.open(navUrl, '_blank'); speak("Opening navigation to customer pickup location.");
    }

    // Map opening function for Drop
    function openDropMap() {
        if (!currentReqData || !currentReqData.dropLat || !currentReqData.dropLng) return showCustomAlert('Error', 'Drop location is missing.');
        const dLat = currentReqData.dropLat; const dLng = currentReqData.dropLng;
        const navUrl = `https://www.google.com/maps/dir/${driverLat},${driverLng}/${dLat},${dLng}/data=!4m2!4m1!3e0`;
        window.open(navUrl, '_blank'); speak("Opening navigation to drop location.");
    }
    
    // Call function
    function callCustomer() {
        if (!currentReqData || !currentReqData.customerMobile) return showCustomAlert('Error', 'Customer mobile number missing.');
        window.location.href = `tel:${currentReqData.customerMobile}`;
        speak("Calling customer.");
    }


    // -------------------- REQUEST LISTENING --------------------
    function requestListener(snap) {
        if (isRequesting || !isOnline) return;
        const data = snap.val();
        if(!data) return;
        if(data.status === "pending") {
            if (!driverLat || !driverLng) return console.log("Waiting for location.");
            
            const reqVehicle = (data.vehicleType || 'car').toString().toLowerCase();
            const myVehicle = (partnerObj && partnerObj.vehicleType) ? partnerObj.vehicleType.toString().toLowerCase() : null;
            
            if (myVehicle && reqVehicle !== myVehicle) return; 

            let dist = getDist(driverLat, driverLng, data.pickupLat, data.pickupLng);
            if (dist <= 2.0) {
                isRequesting = true;
                try { document.getElementById('ringtone').play().catch(()=>{}); } catch(e){}
                speak("A new request has arrived for a " + reqVehicle + ". The fare is " + (data.price || 0) + " rupees. Pickup distance " + dist.toFixed(1) + " kilometers.");
                showRequest(data, snap.key, dist.toFixed(1), reqVehicle);
            }
        }
    }

    function startListening() {
        if(!isOnline) return; 
        db.ref('requests').limitToLast(10).on('child_added', requestListener);
        db.ref('requests').limitToLast(10).on('child_changed', requestListener);
    }

    function stopListening() {
        db.ref('requests').limitToLast(10).off('child_added', requestListener);
        db.ref('requests').limitToLast(10).off('child_changed', requestListener);
    }

    function showRequest(data, key, pKM, reqVehicle) {
        currentReqKey = key; currentReqData = data;
        document.getElementById('reqPopup').style.display = 'block';
        document.getElementById('fareDisplay').innerText = data.price || 0;
        document.getElementById('pickupDist').innerText = pKM + " KM";
        document.getElementById('tripDist').innerText = data.distance || '‚Äî';
        
        // Use request vehicle icon
        const reqIconHtml = getVehicleEmoji(reqVehicle, true);
        const reqDivIcon = L.divIcon({ html: reqIconHtml, className: '', iconSize: [50,50], iconAnchor: [25,50], popupAnchor: [0,-30] });

        if (reqVehicleMarker) map.removeLayer(reqVehicleMarker);
        reqVehicleMarker = L.marker([data.pickupLat, data.pickupLng], {icon: reqDivIcon}).addTo(map).bindPopup(reqVehicle.toUpperCase() + " PICKUP");

        if (pickupMarker) map.removeLayer(pickupMarker);
        pickupMarker = reqVehicleMarker; 

        map.setView([data.pickupLat, data.pickupLng], 15);
    }

    // Accept with transaction + extra driverVehicle field
    function tryAcceptRide() {
        try { document.getElementById('ringtone').pause(); } catch(e){}
        stopListening(); 

        if (!partnerObj || !partnerObj.vehicleType) {
            partnerObj = partnerObj || { vehicleType: null };
            speak("Please choose vehicle before accepting. Opening selection.");
            openVehicleModal(); 
            if(isOnline) startListening(); 
            isRequesting = false;
            return;
        }

        db.ref('requests/' + currentReqKey).transaction(function(curr) {
            if (curr === null) return curr;
            if (curr.status === 'pending') {
                return { 
                    ...curr, 
                    status: 'accepted', 
                    driverMobile: driverMobile, 
                    driverVehicle: partnerObj.vehicleType || 'unknown',
                    driverId: partnerObj.partnerId || driverMobile,
                    acceptedAt: Date.now()
                };
            } else return;
        }, function(error, committed, snapshot) {
            if (!committed) {
                showCustomAlert('Booking Missed', 'Booking missed by another driver or customer cancelled.');
                document.getElementById('reqPopup').style.display = 'none';
                if (pickupMarker) map.removeLayer(pickupMarker);
                isRequesting = false;
                if(isOnline) startListening();
            } else {
                currentReqData = snapshot.val();
                speak("Booking accepted. Proceed to pickup.");
                
                db.ref('partners/' + driverMobile + '/history').push({
                    reqId: currentReqKey,
                    price: currentReqData.price || 0,
                    status: 'accepted',
                    ts: Date.now()
                });
                
                if (!partnerObj || !partnerObj.partnerId) {
                    const pid = 'P' + (Math.floor(100000 + Math.random()*900000));
                    partnerObj = partnerObj || {};
                    partnerObj.partnerId = pid;
                    partnerObj.mobile = driverMobile;
                    partnerObj.vehicleType = partnerObj.vehicleType || 'car';
                    db.ref('partners/' + driverMobile).set(partnerObj);
                }
                rideSecured();
            }
        });
    }

    function rideSecured() {
        document.getElementById('reqPopup').style.display = 'none';
        document.getElementById('pickupCard').style.display = 'block';
        document.getElementById('custMobDisp').innerText = currentReqData.customerMobile || '‚Äî';
        drawRoute(driverLat, driverLng, currentReqData.pickupLat, currentReqData.pickupLng, '#d4af37');
        if (pickupMarker) pickupMarker.openPopup();
    }
</script>
    
<script>
    
    // OTP verify + start trip
    function verifyOtp() {
        const entered = document.getElementById('otpIn').value;
        if (!currentReqData) { showCustomAlert('Error', 'No request data.'); speak("No request data."); return; }
        
        // --- FIXED OTP CHECK ---
        const correctOtp = (currentReqData.otp || '').toString();
        
        if (entered === correctOtp && entered.length > 0) { 
            speak("OTP verified. Starting the trip now. Drive safely.");
            try { db.ref('requests/' + currentReqKey).update({ status: "started", startedAt: Date.now() }); } catch(e) { console.warn("DB update failed:", e); }
            document.getElementById('pickupCard').style.display = 'none';
            document.getElementById('dropCard').style.display = 'block';
            if (pickupMarker) map.removeLayer(pickupMarker);
            if (reqVehicleMarker) map.removeLayer(reqVehicleMarker); 
            
            if (currentReqData.dropLat && currentReqData.dropLng) {
                // Set current location to pickup location for drop navigation calculation
                driverLat = currentReqData.pickupLat;
                driverLng = currentReqData.pickupLng;
                
                drawRoute(driverLat, driverLng, currentReqData.dropLat, currentReqData.dropLng, '#2ecc71');
                var dropIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41] });
                if (dropMarker) map.removeLayer(dropMarker);
                dropMarker = L.marker([currentReqData.dropLat, currentReqData.dropLng], {icon: dropIcon}).addTo(map).bindPopup("DROP");
                document.getElementById('mapNavBtnDrop').style.display = 'block';
            } else {
                speak("Drop location was not provided. Ask passenger for drop location and navigate manually.");
                showCustomAlert('Drop Missing', 'Drop coordinates not available. Ask passenger for drop location and navigate manually.');
                document.getElementById('mapNavBtnDrop').style.display = 'none';
            }
        } else {
            speak("Incorrect OTP.");
            showCustomAlert('Wrong OTP', 'The OTP entered is incorrect. Please ask the passenger to re-check.');
        }
    }

    // complete ride -> update request completed + partner history
    function completeRide() {
        if (!currentReqKey || !currentReqData) return;
        db.ref('requests/' + currentReqKey).update({ status: "completed", completedAt: Date.now() }).then(()=>{
            document.getElementById('dropCard').style.display = 'none';
            document.getElementById('billModal').style.display = 'flex';
            document.getElementById('billAmount').innerText = "‚Çπ" + (currentReqData.price || 0); 
            speak("Trip complete. Cash collect and move to next ride.");
            
            if (driverMobile) db.ref('partners/' + driverMobile + '/history').push({ reqId: currentReqKey, price: currentReqData.price || 0, status: 'completed', ts: Date.now() });
            
            // cleanup state
            if(routeLine) map.removeLayer(routeLine);
            if(pickupMarker) map.removeLayer(pickupMarker);
            if(dropMarker) map.removeLayer(dropMarker);
            if(reqVehicleMarker) map.removeLayer(reqVehicleMarker);
            currentReqData = null; currentReqKey = null; isRequesting = false;
            if(isOnline) startListening();
        }).catch(err=>{ console.warn("complete update err",err); showCustomAlert('Error','Could not mark completed'); });
    }

    function closeBillAndNext() {
        document.getElementById('billModal').style.display = 'none';
        isRequesting = false;
        if(isOnline) startListening();
    }

    function skipRide() {
        try{ document.getElementById('ringtone').pause(); }catch(e){}
        document.getElementById('reqPopup').style.display = 'none';
        if (pickupMarker) map.removeLayer(pickupMarker);
        if (reqVehicleMarker) map.removeLayer(reqVehicleMarker);
        isRequesting = false;
        speak("Request skipped.");
        if(isOnline) startListening();
    }

    function cancelRide() {
        showCustomConfirm('Cancel Ride', 'Are you sure you want to cancel this ride?', function ok() {
            if (!currentReqKey) return showCustomAlert('No ride', 'No active ride to cancel.');
            db.ref('requests/' + currentReqKey).update({ status: "cancelled" }).then(()=> {
                isRequesting = false; location.reload();
            }).catch(()=> showCustomAlert('Error','Cancel failed'));
        }, function cancel(){});
    }

    // utility route drawing
    function drawRoute(lat1, lng1, lat2, lng2, color) {
        if(routeLine) map.removeLayer(routeLine);
        var latlngs = [[lat1, lng1], [lat2, lng2]];
        routeLine = L.polyline(latlngs, {color: color, weight: 5}).addTo(map);
        map.fitBounds(routeLine.getBounds(), {padding:[40,40]});
    }

    function getDist(lat1,lon1,lat2,lon2) {
        var R = 6371; var dLat = (lat2-lat1)*(Math.PI/180); var dLon = (lon2-lon1)*(Math.PI/180);
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    // -------- MENU & MODALS --------
    function toggleMenu(){ const m = document.getElementById('menuBox'); m.style.display = (m.style.display==='block') ? 'none':'block'; }
    function openVehicleModal(){ document.getElementById('vehicleModal').style.display='flex'; }
    function closeVehicleModal(){ document.getElementById('vehicleModal').style.display='none'; }
    function chooseVehicle(v){
        partnerObj = partnerObj || {};
        partnerObj.vehicleType = v;
        partnerObj.mobile = driverMobile;
        partnerObj.partnerId = partnerObj.partnerId || ('P' + (Math.floor(100000 + Math.random()*900000)));
        
        db.ref('partners/' + driverMobile).update({ vehicleType: v, partnerId: partnerObj.partnerId, mobile: driverMobile, updatedAt: Date.now() }).then(()=>{
            showCustomAlert('Saved', 'Vehicle set to ' + v.toUpperCase());
            updateDriverIcon(); 
            closeVehicleModal();
        }).catch(err=>{ console.warn("save vehicle err",err); showCustomAlert('Error','Could not save vehicle'); });
    }

    function openVehicleChange(){
        openVehicleModal();
    }

    // Earnings: sum of completed rides for today for this driver
    async function showTodayEarnings(){
        if (!driverMobile) return showCustomAlert('Login', 'Please login first.');
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        const snap = await db.ref('requests').orderByChild('driverMobile').equalTo(driverMobile).once('value');
        const data = snap.val() || {};
        let total = 0;
        Object.values(data).forEach(r=>{
            if (r.status === 'completed' && r.completedAt && r.completedAt >= start) total += Number(r.price || 0);
        });
        document.getElementById('earnContent').innerText = '‚Çπ' + total;
        document.getElementById('earnModal').style.display = 'flex';
        document.getElementById('earnTodaySub').innerText = '‚Çπ' + total;
    }
    function closeEarnModal(){ document.getElementById('earnModal').style.display='none'; }

    // Partner history modal (recent requests involving this driver)
    async function showPartnerHistory(){
        if (!driverMobile) return showCustomAlert('Login', 'Please login first.');
        const snap = await db.ref('requests').orderByChild('driverMobile').equalTo(driverMobile).limitToLast(50).once('value');
        const data = snap.val() || {};
        const listDom = document.getElementById('histList'); listDom.innerHTML = '';
        const items = Object.keys(data).map(k=>({id:k, val:data[k]})).sort((a,b)=> (b.val.timestamp||b.val.completedAt||0) - (a.val.timestamp||a.val.completedAt||0));
        if (items.length===0) listDom.innerHTML = '<div style="padding:12px;color:#aaa">No rides yet</div>';
        items.forEach(it=>{
            const v = it.val;
            const row = document.createElement('div'); row.className='hist-row';
            row.innerHTML = `<div style="flex:1">
                <div style="font-weight:800">‚Çπ${v.price||0} ‚Ä¢ ${v.vehicleType||''}</div>
                <div style="color:#888; font-size:0.9rem">${v.status||'‚Äî'}</div>
                <div style="color:#666; font-size:0.85rem">${v.customerMobile || ''}</div>
            </div>
            <div style="text-align:right">
                <div style="font-size:0.8rem; color:#999">${v.completedAt? new Date(v.completedAt).toLocaleString() : (v.timestamp? new Date(v.timestamp).toLocaleString():'‚Äî')}</div>
                <div style="margin-top:8px"><button class="smallBtn" onclick="console.log(${JSON.stringify(it)})">DETAILS</button></div>
            </div>`;
            listDom.appendChild(row);
        });
        document.getElementById('histModal').style.display = 'flex';
    }
    // --- FIXED HISTORY MODAL CLOSURE ---
    function closeHistModal(){ document.getElementById('histModal').style.display='none'; }


    // Logout & clear localStorage
    function logoutAndClear(){
        showCustomConfirm('Logout', 'Clear saved mobile and logout?', function ok(){
            localStorage.removeItem('msPartnerMobile');
            if (driverMobile) db.ref('partners/' + driverMobile + '/isOnline').set(false);
            location.reload();
        }, function cancel(){});
    }

    // helper wrappers
    window.openVehicleChange = openVehicleChange;
    window.showTodayEarnings = showTodayEarnings;
    window.showPartnerHistory = showPartnerHistory;
    window.toggleMenu = toggleMenu;
    window.openHelp = function(){ document.getElementById('helpModal').style.display='flex'; speak("Help opened."); };
    window.closeHelp = function(){ document.getElementById('helpModal').style.display='none'; speak("Help closed."); };
    window.toggleDuty = toggleDuty; 
    window.openPickupMap = openPickupMap;
    window.openDropMap = openDropMap;
    window.callCustomer = callCustomer;
    window.closeHistModal = closeHistModal;


    // onUnload: set offline
    window.addEventListener('beforeunload', ()=> {
        if (driverMobile) db.ref('partners/' + driverMobile + '/isOnline').set(false);
        stopListening();
    });

    window.openPartnerHistory = showPartnerHistory;
</script>
    
</body>
</html>
    
