<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MS Partner - Fixed</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin:0; font-family: 'Segoe UI', sans-serif; height:100vh; overflow:hidden; background:#000; color:#fff; }

        /* LOGIN */
        #dLoginScreen { position:fixed; inset:0; background:#000; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; }
        .logo { font-size: 2rem; color: #d4af37; font-weight: bold; margin-bottom: 10px; letter-spacing: 2px; }
        .d-inp { width:80%; padding:15px; border-radius:8px; border:1px solid #333; background:#111; color:#fff; text-align:center; margin-bottom:15px; font-size:1.1rem; }
        .d-btn { width:85%; padding:15px; border-radius:8px; border:none; background:#d4af37; color:#000; font-weight:bold; cursor:pointer; font-size:1.1rem; }

        /* MAP */
        #dApp { display:none; height:100vh; width:100%; flex-direction:column; }
        #map { height:100%; width:100%; background: #ffffff; } /* MAP BACKGROUND: White */

        /* RECENTER BUTTON */
        .recenter-btn {
            position: absolute; bottom: 300px; right: 20px;
            width: 45px; height: 45px; background: white; color: black;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; cursor: pointer; z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* CARDS */
        .card { 
            position: absolute; left:10px; right:10px; bottom:20px; 
            background: rgba(20, 20, 20, 0.95);
            border-radius:15px; padding:20px; z-index:1001; 
            border:1px solid #333; display:none; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
        }
        
        .fare-txt { font-size: 2.8rem; font-weight: 800; color: #d4af37; margin-bottom: 5px; }
        .info-row { display:flex; justify-content:space-between; margin-bottom:15px; background:#000; padding:10px; border-radius:8px; border:1px solid #333; }
        .info-col { text-align:center; width:48%; }
        .lbl { font-size:0.7rem; color:#888; }
        .val { font-size:1.1rem; font-weight:bold; color:white; }

        /* BUTTONS FIX */
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        .accept-btn { flex: 1; padding: 15px; background: #d4af37; color:black; font-weight:bold; border:none; border-radius:8px; cursor:pointer; font-size:1.1rem; }
        .skip-btn { flex: 1; padding: 15px; background: #333; color:#aaa; font-weight:bold; border:1px solid #555; border-radius:8px; cursor:pointer; font-size:1.1rem; }
        
        /* Fixed Call & Complete Buttons */
        .contact-btn { display:block; background:#2ecc71; color:white; text-align:center; padding:12px; border-radius:8px; text-decoration:none; font-weight:bold; margin-bottom:10px; font-size:1.1rem; border: none; width: 100%; cursor: pointer;}
        .finish-btn { display:block; background:#000; color:#d4af37; border: 1px solid #d4af37; text-align:center; padding:12px; border-radius:8px; font-weight:bold; font-size:1.1rem; width: 100%; cursor: pointer;}

        /* OTP SECTION */
        .otp-box { margin-top: 15px; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #444; }
        .otp-row { display: flex; gap: 10px; margin-top: 5px; }
        .otp-inp { flex: 1; padding: 10px; text-align: center; font-size: 1.3rem; letter-spacing: 5px; background: #000; border: 1px solid #d4af37; color: white; border-radius: 5px; }
        .go-btn { padding: 0 20px; background: #d4af37; color: black; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; }

        /* HELP BUTTON */
        .help-btn { position: absolute; top: 20px; right: 20px; background: red; color: white; font-weight: bold; padding: 8px 15px; border-radius: 50px; z-index: 2000; border: 2px solid white; cursor: pointer; display: none; }

        /* HELP MODAL */
        #helpModal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .help-box { background: #222; padding: 25px; border-radius: 15px; width: 80%; text-align: center; border: 1px solid #d4af37; }
        .call-opt { display: block; background: #333; color: white; padding: 15px; margin: 10px 0; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; border: 1px solid #555; }

        /* BILL MODAL */
        #billModal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .bill-box { background: white; color: black; padding: 30px; border-radius: 15px; width: 85%; max-width: 400px; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .total-fare { font-size: 4rem; font-weight: 900; color: green; margin: 10px 0; }

    </style>
</head>
<body>

    <audio id="ringtone" src="https://media.geeksforgeeks.org/wp-content/uploads/20190531135120/beep.mp3" loop></audio>

    <div id="helpBtn" class="help-btn" onclick="openHelp()">üÜò HELP</div>

    <div id="helpModal">
        <div class="help-box">
            <h2 style="color:red; margin-top:0;">EMERGENCY HELP</h2>
            <a href="tel:100" class="call-opt" style="border-color:red;">üëÆ POLICE (100)</a>
            <a href="tel:9381667208" class="call-opt" style="border-color:#d4af37; color:#d4af37;">üë§ MUSTAQEEM (Founder)</a>
            <button onclick="closeHelp()" style="margin-top:15px; padding:10px 30px; background:#333; color:white; border:none; border-radius:5px;">CLOSE</button>
        </div>
    </div>

    <div id="dLoginScreen">
        <div class="logo">MS PARTNER</div>
        <input id="dPhone" class="d-inp" type="tel" placeholder="Enter Mobile Number">
        <button class="d-btn" onclick="startDuty()">START DUTY</button>
    </div>

    <div id="dApp">
        <div id="map"></div>
        <div class="recenter-btn" onclick="recenterMap()">üéØ</div>

        <div id="reqPopup" class="card">
            <div style="color:#fff; font-weight:bold; margin-bottom:5px;">NEW RIDE REQUEST üîî</div>
            <div class="fare-txt">‚Çπ<span id="fareDisplay">0</span></div>
            
            <div class="info-row">
                <div class="info-col"><div class="lbl">PICKUP DIST</div><div class="val" id="pickupDist">...</div></div>
                <div class="info-col"><div class="lbl">TRIP DIST</div><div class="val" id="tripDist">...</div></div>
            </div>
            
            <div class="btn-row">
                <button class="skip-btn" onclick="skipRide()">SKIP ‚úï</button>
                <button class="accept-btn" onclick="tryAcceptRide()">ACCEPT ‚úì</button>
            </div>
        </div>

        <div id="pickupCard" class="card" style="border-top: 4px solid yellow;">
            <div style="color:yellow; font-weight:bold; margin-bottom:5px;">HEADING TO PICKUP üü°</div>
            
            <div style="color:#aaa; font-size:0.8rem;">CUSTOMER MOBILE</div>
            <div id="custMobDisp" style="font-size:1.4rem; font-weight:bold; color:white; margin-bottom:10px;">...</div>
            
            <a id="callBtn" href="#" class="contact-btn">üìû CALL CUSTOMER</a>

            <div class="otp-box">
                <div style="color:#888; font-size:0.7rem;">ENTER OTP TO START TRIP</div>
                <div class="otp-row">
                    <input type="number" id="otpIn" class="otp-inp" placeholder="XXXX">
                    <button class="go-btn" onclick="verifyOtp()">START</button>
                </div>
            </div>

            <button onclick="cancelRide()" style="width:100%; margin-top:10px; background:red; color:white; border:none; padding:10px; font-weight:bold; border-radius:8px;">CANCEL RIDE</button>
        </div>

        <div id="dropCard" class="card" style="border-top: 4px solid green;">
            <div style="color:green; font-weight:bold; margin-bottom:5px;">ON TRIP üü¢</div>
            <p style="color:#ccc;">Navigating to Drop Location...</p>
            <h2 style="color:#d4af37; margin:10px 0;">Follow Map Route</h2>
            <button class="finish-btn" onclick="completeRide()">END TRIP & GET BILL</button>
        </div>
    </div>

    <div id="billModal">
        <div class="bill-box">
            <h2>TRIP COMPLETED ‚úÖ</h2>
            <p style="color:#555;">Collect Cash from Customer</p>
            <div class="total-fare" id="billAmount">‚Çπ0</div>
            <button class="accept-btn" onclick="location.reload()">COMPLETE & NEXT</button>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
        <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCJpo25tYCN_fXP8aCckgA4WrD962KCsQ8",
            authDomain: "hyd-texi.firebaseapp.com",
            projectId: "hyd-texi",
            storageBucket: "hyd-texi.firebasestorage.app",
            messagingSenderId: "807048727786",
            appId: "1:807048727786:web:7ef03573876c70b76e1b93",
            databaseURL: "https://hyd-texi-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let map, driverMarker, driverLat, driverLng, driverMobile;
        let currentReqKey, currentReqData, routeLine;
        let followDriver = true;
        let gpsWatchId = null; 

        // --- FIX 1: Voice/SpeechSynthesis fallback for APK ---
        function speak(text) {
            if ('speechSynthesis' in window) {
                const s = new SpeechSynthesisUtterance(text);
                s.lang = 'en-US'; 
                window.speechSynthesis.speak(s);
            } else {
                console.log("SPEAKING (Voice attempt failed): " + text);
                // APK ‡§Æ‡•á‡§Ç, ‡§Ö‡§ó‡§∞ ‡§∏‡•ç‡§™‡•Ä‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§ö‡§≤‡•Ä, ‡§§‡•ã ‡§π‡§Æ ‡§á‡§∏‡•á ‡§ö‡•Å‡§™‡§ö‡§æ‡§™ ‡§∞‡§π‡§®‡•á ‡§¶‡•á‡§§‡•á ‡§π‡•à‡§Ç‡•§
            }
        }

        function startDuty() {
            const num = document.getElementById('dPhone').value;
            if(num.length < 10) return alert("Valid Number Dalo!");
            localStorage.setItem('msDriverPremium', num);
            driverMobile = num;
            document.getElementById('dLoginScreen').style.display = 'none';
            
            // * Instant Open: ‡§§‡•Å‡§∞‡§®‡•ç‡§§ ‡§Æ‡•à‡§™ ‡§ñ‡•ã‡§≤‡•á‡§Ç ‡§î‡§∞ ‡§°‡§ø‡§´‡§º‡•â‡§≤‡•ç‡§ü ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§™‡§∞ ‡§á‡§®‡§ø‡§∂‡§ø‡§Ø‡§≤‡§æ‡§á‡§ú‡§º ‡§ï‡§∞‡•á‡§Ç
            document.getElementById('dApp').style.display = 'flex';
            document.getElementById('helpBtn').style.display = 'block';
            initializeMap([17.3850, 78.4867], 13); // Default Hyderabad
            
            // GPS ‡§ö‡•á‡§ï ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç (‡§Ø‡§π ‡§¨‡•à‡§ï‡§ó‡•ç‡§∞‡§æ‡§â‡§Ç‡§° ‡§Æ‡•á‡§Ç ‡§ö‡§≤‡§§‡§æ ‡§∞‡§π‡•á‡§ó‡§æ)
            startGPSCheck();
            startListening();
        }

        function initializeMap(initialLatlng, initialZoom) {
            if (map) return; 
            
            // --- Yellow Cab Icon (Base64) ---
            const yellowCarIcon = L.icon({
                // This is a Base64 image of a simple yellow car icon.
                iconUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAABHklEQVR4nO2ZwU3DQBBFj934tQf53dKAUQGaIGCAYQfBBhAFsYJ/p0hW04oM+k57Vp733Xv3wM+ZfP0/t8898144R7gP3F5N620j9p4Q26k1/zVwHTh4577bUf9OaG0jdlP9GgN5gN2l2H/d00J83a7Ffp2hS3C6rUjT67xGg80W3hN7X3hY642TzG6f/8C5Y6JdK4gH5jRj6QhV42jFvK/80T0oX23hD9K0kM+bYm0jtlO76+FwTzDb0b/bA9/0jT63p+s8RocK/u0hB/XQnzdrkR+naEFsYpYxawihhVXC9M/48vBf4u1Q+i/P4Q/S1M9T+qI3n7i51b6pP4YwR/kC5/0FwA635J/2k08AAAAAElFTkSuQmCC',
                iconSize: [45, 45], iconAnchor: [22, 22]
            });

            map = L.map('map', {zoomControl: false}).setView(initialLatlng, initialZoom);
            
            // Map Tile Layer (Light/White background)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Marker is ALWAYS draggable, for manual location setting
            driverMarker = L.marker(initialLatlng, {icon: yellowCarIcon, draggable: true}).addTo(map).bindPopup("Your Cab");
            
            // Update location when driver drags the marker (just like customer app)
            driverMarker.on('dragend', (e) => {
                const newLoc = driverMarker.getLatLng();
                driverLat = newLoc.lat;
                driverLng = newLoc.lng;
                followDriver = false; // Stop auto-follow if manually dragged
                speak("Location set by drag.");
            });

            map.on('dragstart', () => { followDriver = false; });
            
            // Set initial driver location (before GPS response)
            driverLat = initialLatlng[0]; 
            driverLng = initialLatlng[1];
        }

        function startGPSCheck() {
            if (!navigator.geolocation) {
                alert("GPS Not Supported"); 
                speak("GPS is not supported. Please drag your cab marker to set your current location.");
                return;
            }
            
            // First attempt to get current location (for quick update)
            navigator.geolocation.getCurrentPosition(
                // Success: GPS Location Found
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    
                    // Update marker and map to actual location
                    driverLat = lat;
                    driverLng = lng;
                    driverMarker.setLatLng([lat, lng]);
                    map.setView([lat, lng], 16);
                    
                    // Start continuous watching for real-time updates
                    if (!gpsWatchId) {
                        gpsWatchId = navigator.geolocation.watchPosition(onPositionUpdate, onGPSError, {enableHighAccuracy: true});
                    }
                },
                // Error: GPS Not Enabled or denied
                (err) => {
                    console.error("GPS Initial Error:", err);
                    // Voice Prompt for dragging location
                    speak("GPS is not enabled. Please drag your cab marker to set your current location.");
                    alert("GPS Enable nahi hai! Kripya map par cab marker ko drag karke apni location set karen.");
                },
                {enableHighAccuracy: true, timeout: 5000} 
            );
        }
        
        function onPositionUpdate(pos) {
            driverLat = pos.coords.latitude;
            driverLng = pos.coords.longitude;
            driverMarker.setLatLng([driverLat, driverLng]);
            // Only follow if the driver hasn't manually dragged the map away
            if(followDriver) map.panTo([driverLat, driverLng]);
        }

        function onGPSError(err) {
             console.error("GPS Watch Error:", err);
             followDriver = false; 
             // Stop watching, so we rely only on the manually set location
             if (gpsWatchId) {
                 navigator.geolocation.clearWatch(gpsWatchId);
                 gpsWatchId = null;
             }
             alert("GPS Signal Lost! Relying on manual location. Check your settings.");
        }


        function recenterMap() {
            followDriver = true;
            if(driverLat) {
                // Recenter to the last known GPS location or manually dragged location
                map.setView([driverLat, driverLng], map.getZoom() < 14 ? 16 : map.getZoom());
                speak("Recenter to current location.");
            } else {
                // Fallback: Set marker to the current map center
                const center = map.getCenter();
                driverLat = center.lat;
                driverLng = center.lng;
                driverMarker.setLatLng([driverLat, driverLng]);
                map.setView([driverLat, driverLng], map.getZoom());
                speak("Your location has been set to the center of the map.");
            }
        }

        function startListening() {
            db.ref('requests').limitToLast(1).on('child_added', snap => {
                const data = snap.val();
                if(data.status === "pending") {
                    if (!driverLat || !driverLng) return console.log("Waiting for initial location set."); 
                    
                    let dist = getDist(driverLat, driverLng, data.pickupLat, data.pickupLng).toFixed(1);
                    if(dist <= 2.0) {
                        // Request Tune
                        document.getElementById('ringtone').play().catch(e=>{});
                        speak("New Ride Request");
                        showRequest(data, snap.key, dist);
                    }
                }
            });
        }

        function showRequest(data, key, pKM) {
            currentReqKey = key;
            currentReqData = data;
            document.getElementById('reqPopup').style.display = 'block';
            document.getElementById('fareDisplay').innerText = data.price;
            document.getElementById('pickupDist').innerText = pKM + " KM";
            document.getElementById('tripDist').innerText = data.distance;

            var personIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/236/236831.png', iconSize: [35, 35], iconAnchor: [17, 35] });
            L.marker([data.pickupLat, data.pickupLng], {icon: personIcon}).addTo(map).bindPopup("PICKUP").openPopup();
        }

        function tryAcceptRide() {
            document.getElementById('ringtone').pause();
            db.ref('requests/' + currentReqKey).transaction(function(curr) {
                if (curr === null) return curr; 
                if (curr.status === 'pending') {
                    return { ...curr, status: 'accepted', driverMobile: driverMobile };
                } else { return; } 
            }, function(error, committed, snapshot) {
                if (!committed) {
                    speak("Booking missed");
                    alert('‚ö†Ô∏è BOOKING MISSED!');
                    document.getElementById('reqPopup').style.display = 'none';
                } else {
                    speak("Booking Accepted");
                    rideSecured();
                }
            });
        }

        function rideSecured() {
            document.getElementById('reqPopup').style.display = 'none';
            document.getElementById('pickupCard').style.display = 'block';
            document.getElementById('custMobDisp').innerText = currentReqData.customerMobile;
            document.getElementById('callBtn').href = "tel:" + currentReqData.customerMobile;
            
            drawRoute(driverLat, driverLng, currentReqData.pickupLat, currentReqData.pickupLng, '#d4af37');
        }

        function verifyOtp() {
            if(document.getElementById('otpIn').value == currentReqData.otp) {
                // Voice Prompt 2
                speak("Dear partner, please ask the passenger for the drop location."); 
                
                db.ref('requests/' + currentReqKey).update({ status: "started" });
                document.getElementById('pickupCard').style.display = 'none';
                document.getElementById('dropCard').style.display = 'block';
                drawRoute(currentReqData.pickupLat, currentReqData.pickupLng, currentReqData.dropLat, currentReqData.dropLng, '#2ecc71');
                
                var dropIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41] });
                L.marker([currentReqData.dropLat, currentReqData.dropLng], {icon: dropIcon}).addTo(map).bindPopup("DROP");
            } else { alert("‚ùå Wrong OTP!"); }
        }

        function completeRide() {
            db.ref('requests/' + currentReqKey).update({ status: "completed" });
            document.getElementById('dropCard').style.display = 'none';
            document.getElementById('billModal').style.display = 'flex';
            document.getElementById('billAmount').innerText = "‚Çπ" + currentReqData.price;
        }

        function skipRide() {
            document.getElementById('ringtone').pause();
            document.getElementById('reqPopup').style.display = 'none';
        }

        function cancelRide() {
            if(confirm("Cancel?")) {
                db.ref('requests/' + currentReqKey).update({ status: "cancelled" });
                location.reload();
            }
        }

        function openHelp() { document.getElementById('helpModal').style.display = 'flex'; }
        function closeHelp() { document.getElementById('helpModal').style.display = 'none'; }

        function drawRoute(lat1, lng1, lat2, lng2, color) {
            if(routeLine) map.removeLayer(routeLine);
            var latlngs = [[lat1, lng1], [lat2, lng2]];
            routeLine = L.polyline(latlngs, {color: color, weight: 5}).addTo(map);
            map.fitBounds(routeLine.getBounds());
        }

        function getDist(lat1,lon1,lat2,lon2) {
            var R = 6371; var dLat = (lat2-lat1)*(Math.PI/180); var dLon = (lon2-lon1)*(Math.PI/180); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); 
        }
    </script>
</body>
</html>
