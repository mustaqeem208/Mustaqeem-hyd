<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MS PARTNER ‚Äî Driver</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --bg:#07070a; --card:#0f1720; --accent:#d4af37; --muted:#9aa3b2; --ok:#10b981; --danger:#ef4444;
      --radius:12px;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,Segoe UI,Roboto,Arial;color:#fff}
    /* LOGIN */
    #dLoginScreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:20px;z-index:9999}
    .login-card{background:linear-gradient(180deg,#081023,#0b1220);padding:22px;border-radius:14px;width:100%;max-width:420px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
    .logo{font-weight:900;color:var(--accent);font-size:1.6rem;margin-bottom:10px}
    .d-inp{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:#071022;color:#fff;margin-bottom:10px;font-size:1rem;text-align:center}
    .d-btn{width:100%;padding:12px;border-radius:10px;border:none;background:var(--accent);color:#000;font-weight:800;cursor:pointer}
    .small{color:var(--muted);font-size:0.9rem;text-align:center;margin-top:8px}
    /* APP SHELL */
    #dApp{display:none;height:100vh;width:100%;position:relative}
    #topBar{position:fixed;left:12px;right:12px;top:12px;height:56px;background:linear-gradient(90deg,rgba(0,0,0,0.6),rgba(8,8,12,0.6));border-radius:10px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;z-index:2000;border:1px solid rgba(255,255,255,0.04)}
    #driverInfo{display:flex;gap:12px;align-items:center}
    #driverMobile{font-weight:800}
    #vehicleTag{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:8px;font-weight:700}
    #incomeBox{background:linear-gradient(90deg,#071018,#07101a);padding:8px 12px;border-radius:8px;font-weight:900;color:var(--ok);border:1px solid rgba(16,185,129,0.08)}
    #map{position:absolute;inset:80px 12px 12px 12px;border-radius:12px;overflow:hidden}
    .map-btn{position:absolute;right:24px;bottom:120px;background:#fff;color:#000;padding:12px;border-radius:14px;font-weight:800;border:none;box-shadow:0 8px 24px rgba(2,6,23,0.5);z-index:1600;cursor:pointer}
    .map-btn.small{right:24px;bottom:64px;padding:10px;border-radius:12px}
    /* BOTTOM PANEL */
    .panel{position:fixed;left:12px;right:12px;bottom:12px;background:var(--card);padding:12px;border-radius:14px;box-shadow:0 14px 40px rgba(2,6,23,0.6);z-index:1500;border:1px solid rgba(255,255,255,0.03)}
    .panel .row{display:flex;justify-content:space-between;align-items:center}
    .panel .label{color:var(--muted);font-size:0.9rem}
    .panel .val{font-weight:900;font-size:1.2rem}
    .panel .controls{display:flex;gap:8px;align-items:center}
    .btn-accept{background:var(--accent);color:#000;padding:10px 12px;border-radius:10px;border:none;font-weight:900;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer}
    /* REQUEST POPUP (center) */
    #reqPopup{position:fixed;left:50%;transform:translateX(-50%);bottom:160px;width:92%;max-width:480px;background:linear-gradient(180deg,#07101a,#081026);padding:16px;border-radius:12px;display:none;z-index:1700;border:1px solid rgba(255,255,255,0.04)}
    .fare{font-size:2.2rem;color:var(--accent);font-weight:900}
    .info-row{display:flex;justify-content:space-between;margin-top:10px;color:var(--muted)}
    .req-row-buttons{display:flex;gap:10px;margin-top:12px}
    .btn-skip{flex:1;background:#111;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:10px;border-radius:10px;cursor:pointer}
    .btn-accept2{flex:1;background:var(--accent);color:#000;padding:10px;border-radius:10px;border:none;cursor:pointer;font-weight:900}
    /* PICKUP / DROP CARDS */
    .card-large{position:fixed;left:12px;right:12px;bottom:120px;background:linear-gradient(180deg,#06101a,#071018);padding:14px;border-radius:12px;display:none;z-index:1800;border:1px solid rgba(255,255,255,0.03)}
    .otp-input{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;width:100%;text-align:center;font-size:1.2rem}
    /* HISTORY DIALOG */
    #historyModal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;z-index:2500;align-items:center;justify-content:center}
    #historyCard{width:92%;max-width:720px;background:#06111a;padding:12px;border-radius:12px;max-height:80vh;overflow:auto;border:1px solid rgba(255,255,255,0.03)}
    .hist-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.02)}
    /* small helpers */
    .muted{color:var(--muted)}
    .pill{padding:6px 10px;border-radius:10px;background:rgba(255,255,255,0.02);font-weight:800}
    /* vehicle change panel inside topbar */
    #vehiclePanel{display:flex;gap:8px;align-items:center}
    .veh-select{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer}
    .veh-input{padding:6px 8px;border-radius:8px;background:#071022;border:1px solid rgba(255,255,255,0.03);color:#fff;width:120px}
    .logout-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 8px;border-radius:8px;color:var(--muted);cursor:pointer}
    @media(min-width:900px){ #map{inset:80px 40px 12px 40px} }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="dLoginScreen">
    <div class="login-card">
      <div class="logo">MS PARTNER ‚Äî Driver</div>
      <input id="dPhone" class="d-inp" type="tel" placeholder="Mobile number (10 digits)" />
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <input id="vehicleNumberInput" class="d-inp" placeholder="Vehicle Reg. No (KA-01-XXXX)" style="flex:1" />
      </div>
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <button id="pickCab" class="veh-btn" style="flex:1" onclick="toggleVeh('car')">Cab</button>
        <button id="pickAuto" class="veh-btn" style="flex:1" onclick="toggleVeh('auto')">Auto</button>
        <button id="pickBike" class="veh-btn" style="flex:1" onclick="toggleVeh('bike')">Bike</button>
      </div>
      <button class="d-btn" onclick="startDuty()">LOGIN & START DUTY</button>
      <div class="small">You will remain logged in until you logout. Location permission required for receiving requests.</div>
    </div>
  </div>

  <!-- APP -->
  <div id="dApp">
    <div id="topBar">
      <div id="driverInfo">
        <div style="display:flex;flex-direction:column">
          <div id="driverMobile">+91 ‚Äî</div>
          <div class="muted" id="vehicleNumberDisplay">Vehicle: ‚Äî</div>
        </div>
        <div id="vehicleTag" class="pill">Vehicle: ‚Äî</div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;">
        <div id="incomeBox">Today ‚Çπ0</div>
        <div id="vehiclePanel">
          <div class="veh-select" id="curVehicle" onclick="openVehiclePicker()">Change</div>
          <input id="vehNum" class="veh-input" placeholder="Reg no" />
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>
    </div>

    <div id="map"></div>

    <button class="map-btn" onclick="recenterMap()">üìç Center</button>
    <button class="map-btn small" style="right:24px;bottom:64px" onclick="openHistory()">üìú History</button>

    <!-- Bottom panel for quick info -->
    <div class="panel">
      <div class="row">
        <div>
          <div class="label">Status</div>
          <div class="val" id="dutyStatus">ON DUTY</div>
        </div>
        <div style="text-align:right">
          <div class="label">Available Vehicle</div>
          <div class="val" id="selectedVehicleLabel">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- Request popup -->
    <div id="reqPopup">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">New Ride Request</div>
        <div class="muted" id="reqTime">‚Äî</div>
      </div>
      <div style="margin-top:8px" class="fare">‚Çπ<span id="fareDisplay">0</span></div>
      <div class="info-row">
        <div>Pickup <b id="pickupDist">‚Äî</b></div>
        <div>Trip <b id="tripDist">‚Äî</b></div>
      </div>
      <div class="req-row-buttons">
        <button class="btn-skip" onclick="skipRide()">Skip</button>
        <button class="btn-accept2" onclick="tryAcceptRide()">Accept</button>
      </div>
    </div>

    <!-- Pickup card -->
    <div id="pickupCard" class="card-large">
      <div style="font-weight:900;color:var(--accent)">Heading to Pickup</div>
      <div style="margin-top:8px" id="custPhoneDisplay">Customer: ‚Äî</div>
      <div style="margin-top:8px">
        <button class="map-btn small" onclick="openPickupMap()" style="position:static;margin-right:8px">üó∫Ô∏è Navigate</button>
        <a id="callBtn" class="map-btn small" style="position:static;background:#2ecc71;color:#000;padding:10px;border-radius:10px;text-decoration:none">üìû Call</a>
      </div>
      <div style="margin-top:12px">
        <div class="muted">Enter OTP to start trip</div>
        <input id="otpIn" class="otp-input" placeholder="Enter OTP" />
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn-ghost" onclick="cancelRide()">Cancel</button>
          <button class="btn-accept" onclick="verifyOtp()">Start Trip</button>
        </div>
      </div>
    </div>

    <!-- Drop card -->
    <div id="dropCard" class="card-large" style="border-top:3px solid #10b981">
      <div style="font-weight:900;color:#10b981">On Trip</div>
      <div style="margin-top:8px">Navigate to drop and finish trip.</div>
      <div style="margin-top:12px">
        <button class="map-btn small" onclick="openDropMap()" style="position:static">üó∫Ô∏è Navigate to Drop</button>
        <button class="btn-accept" onclick="completeRide()" style="margin-left:8px">End Trip & Bill</button>
      </div>
    </div>

  </div>

  <!-- History modal -->
  <div id="historyModal">
    <div id="historyCard">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">Ride History</h3>
        <div>
          <button class="btn-ghost" onclick="closeHistory()">Close</button>
        </div>
      </div>
      <div id="historyList"></div>
    </div>
  </div>
  <!-- PART 2: Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCJpo25tYCN_fXP8aCckgA4WrD962KCsQ8",
    authDomain: "hyd-texi.firebaseapp.com",
    projectId: "hyd-texi",
    storageBucket: "hyd-texi.firebasestorage.app",
    messagingSenderId: "807048727786",
    appId: "1:807048727786:web:7ef03573876c70b76e1b93",
    databaseURL: "https://hyd-texi-default-rtdb.firebaseio.com"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ---------- state ----------
  let map, driverMarker, driverLat, driverLng, driverMobile;
  let gpsWatchId = null;
  let isRequesting = false;
  let currentReqKey = null, currentReqData = null;
  let pickupMarker = null, dropMarker = null, routeLine = null;

  // vehicle state persisted
  let selectedVehicle = null; // 'car'|'auto'|'bike'
  let vehicleNumber = null;

  // ---------- utilities ----------
  function el(id){ return document.getElementById(id); }
  function fmtTodayUnixRange() {
    // return [startMs, endMs] for local today
    const now = new Date();
    const s = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0,0,0,0).getTime();
    const e = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23,59,59,999).getTime();
    return [s,e];
  }

  // ---------- persist login & vehicle info ----------
  function saveDriverPrefs() {
    if (!driverMobile) return;
    const prefs = { driverMobile, selectedVehicle, vehicleNumber };
    localStorage.setItem('msPartnerPrefs', JSON.stringify(prefs));
  }
  function loadDriverPrefs() {
    const raw = localStorage.getItem('msPartnerPrefs');
    if (!raw) return false;
    try {
      const p = JSON.parse(raw);
      driverMobile = p.driverMobile || null;
      selectedVehicle = p.selectedVehicle || null;
      vehicleNumber = p.vehicleNumber || null;
      return true;
    } catch(e){ return false; }
  }
  function clearDriverPrefs() {
    localStorage.removeItem('msPartnerPrefs');
  }

  // ---------- UI helpers ----------
  function updateTopbar() {
    el('driverMobile').innerText = driverMobile ? `+91 ${driverMobile}` : '+91 ‚Äî';
    el('vehicleTag').innerText = selectedVehicle ? selectedVehicle.toUpperCase() : '‚Äî';
    el('selectedVehicleLabel').innerText = selectedVehicle ? selectedVehicle.toUpperCase() : '‚Äî';
    el('vehicleNumberDisplay').innerText = vehicleNumber ? ('Vehicle: ' + vehicleNumber) : 'Vehicle: ‚Äî';
    el('vehNum').value = vehicleNumber || '';
  }

  // ---------- login / logout ----------
  function startDuty(){
    const num = el('dPhone').value.trim();
    const vnum = el('vehicleNumberInput').value.trim();
    if (!num || num.length < 10) return alert('Enter valid 10-digit mobile number');
    if (!selectedVehicle) return alert('Select at least one vehicle (tap a vehicle).');
    driverMobile = num;
    vehicleNumber = vnum || vehicleNumber || '';
    // persist
    saveDriverPrefs();
    // update DB partner profile
    const partnerInfo = { mobile: driverMobile, vehicle: selectedVehicle, vehicleNumber: vehicleNumber, onDuty: true, lastSeen: Date.now() };
    db.ref('partners/' + driverMobile).update(partnerInfo).catch(()=>{});
    // show app
    el('dLoginScreen').style.display = 'none';
    el('dApp').style.display = 'block';
    el('helpBtn').style.display = 'block';
    updateTopbar();
    initializeMap([17.3850,78.4867],13);
    startGPSCheck();
    startListening();
    refreshTodayIncome();
  }

  function logout(){
    if (!confirm('Logout and stop receiving requests?')) return;
    // update DB
    if (driverMobile) db.ref('partners/' + driverMobile).update({ onDuty: false, lastSeen: Date.now() }).catch(()=>{});
    clearDriverPrefs();
    location.reload();
  }

  // vehicle toggles on login screen
  function toggleVeh(type) {
    // make single selection (user asked ability to change in-app, but on login choose default)
    selectedVehicle = type;
    // UI highlight
    ['car','auto','bike'].forEach(k => {
      const elId = {car:'pickCab',auto:'pickAuto',bike:'pickBike'}[k];
      const node = document.getElementById(elId);
      if (k === type) node.classList.add('active'); else node.classList.remove('active');
    });
    updateTopbar();
    saveDriverPrefs();
  }

  // in-app vehicle picker
  function openVehiclePicker(){
    const choice = prompt('Change vehicle to (car/auto/bike):', selectedVehicle || 'car');
    if (!choice) return;
    const c = choice.toLowerCase().trim();
    if (!['car','auto','bike'].includes(c)) return alert('Invalid. Choose car, auto or bike.');
    selectedVehicle = c;
    // vehicle number optionally saved from vehNum input
    vehicleNumber = el('vehNum').value.trim() || vehicleNumber || '';
    saveDriverPrefs();
    // update DB
    if (driverMobile) db.ref('partners/' + driverMobile).update({ vehicle: selectedVehicle, vehicleNumber }).catch(()=>{});
    updateTopbar();
    alert('Vehicle updated to ' + selectedVehicle.toUpperCase());
  }

  // ---------- map & GPS ----------
  function initializeMap(initial, zoom) {
    if (map) return;
    map = L.map('map', { zoomControl:true }).setView(initial, zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const carHtml = "<div style='background:var(--accent);padding:8px;border-radius:10px;color:#000;font-weight:900'>YOU</div>";
    const carIcon = L.divIcon({ html: carHtml, className:'', iconSize:[56,30], iconAnchor:[28,15] });
    driverMarker = L.marker(initial, { icon: carIcon, draggable:true }).addTo(map);
    driverMarker.on('dragend', () => {
      const p = driverMarker.getLatLng();
      driverLat = p.lat; driverLng = p.lng;
      if (driverMobile) db.ref('partners/' + driverMobile).update({ lat: driverLat, lng: driverLng, lastSeen: Date.now() }).catch(()=>{});
    });
  }

  function startGPSCheck(){
    if (!navigator.geolocation) { alert('GPS unsupported'); return; }
    navigator.geolocation.getCurrentPosition(pos => {
      driverLat = pos.coords.latitude; driverLng = pos.coords.longitude;
      if (driverMarker) driverMarker.setLatLng([driverLat, driverLng]);
      if (map) map.setView([driverLat, driverLng], 15);
      if (driverMobile) db.ref('partners/' + driverMobile).update({ lat: driverLat, lng: driverLng, lastSeen: Date.now(), onDuty:true }).catch(()=>{});
      if (!gpsWatchId) gpsWatchId = navigator.geolocation.watchPosition(onPositionUpdate, onGPSError, { enableHighAccuracy:true, maximumAge:2000 });
    }, err => {
      console.warn('gps err', err);
      if (!gpsWatchId) gpsWatchId = navigator.geolocation.watchPosition(onPositionUpdate, onGPSError, { enableHighAccuracy:true, maximumAge:2000 });
    }, { enableHighAccuracy:true, timeout:8000 });
  }

  function onPositionUpdate(pos){
    driverLat = pos.coords.latitude; driverLng = pos.coords.longitude;
    if (driverMarker) driverMarker.setLatLng([driverLat, driverLng]);
    if (driverMobile) db.ref('partners/' + driverMobile).update({ lat: driverLat, lng: driverLng, lastSeen: Date.now() }).catch(()=>{});
  }
  function onGPSError(e){ console.warn('gps watch error', e); }

  function recenterMap(){ if (driverLat && driverLng && map) map.setView([driverLat, driverLng], 15); }

  // ---------- request listening with vehicle filter ----------
  function requestListener(snap) {
    if (!driverMobile) return;
    if (isRequesting) return;
    const data = snap.val();
    if (!data || data.status !== 'pending') return;
    // match vehicleType
    const reqType = (data.vehicleType || '').toLowerCase();
    const mapType = reqType === 'car' ? 'car' : (reqType === 'auto' ? 'auto' : (reqType === 'bike' ? 'bike' : null));
    if (!mapType) return;
    if (mapType !== selectedVehicle) return; // only matching vehicle
    if (!driverLat || !driverLng) return;
    const pd = getDist(driverLat, driverLng, data.pickupLat, data.pickupLng);
    // radius threshold 6km
    if (pd <= 6.0) {
      isRequesting = true;
      try { document.getElementById('ringtone').play().catch(()=>{}); } catch(e){}
      currentReqData = data; currentReqKey = snap.key;
      showRequest(data, currentReqKey, pd.toFixed(1));
    }
  }

  function startListening(){
    db.ref('requests').limitToLast(50).on('child_added', requestListener);
  }
  function stopListening(){
    db.ref('requests').limitToLast(50).off('child_added', requestListener);
  }

  // ---------- show request ----------
  function showRequest(data, key, pickupKm){
    el('reqPopup').style.display = 'block';
    el('fareDisplay').innerText = data.price;
    el('pickupDist').innerText = pickupKm + ' km';
    el('tripDist').innerText = data.distance || '‚Äî';
    el('reqTime').innerText = new Date(data.timestamp || Date.now()).toLocaleTimeString();
    // add pickup marker
    if (pickupMarker) map.removeLayer(pickupMarker);
    pickupMarker = L.marker([data.pickupLat, data.pickupLng]).addTo(map).bindPopup('Pickup');
    map.setView([data.pickupLat, data.pickupLng], 15);
  }

  function skipRide(){
    try{ document.getElementById('ringtone').pause(); }catch(e){}
    el('reqPopup').style.display = 'none';
    if (pickupMarker) { map.removeLayer(pickupMarker); pickupMarker = null; }
    isRequesting = false;
  }

  // Accept transaction
  function tryAcceptRide(){
    try{ document.getElementById('ringtone').pause(); }catch(e){}
    stopListening(); // pause listeners
    db.ref('requests/' + currentReqKey).transaction(curr => {
      if (curr === null) return curr;
      if (curr.status === 'pending') return Object.assign({}, curr, { status:'accepted', driverMobile: driverMobile, driverVehicle: selectedVehicle, driverVehicleNumber: vehicleNumber, acceptedAt: Date.now() });
      return;
    }, (err, committed, snap) => {
      if (err) {
        alert('Accept failed.');
        isRequesting = false;
        startListening();
      } else if (!committed) {
        alert('Ride already taken.');
        isRequesting = false;
        startListening();
      } else {
        currentReqData = snap.val();
        // save partner history entry
        const h = {
          reqId: currentReqKey,
          customerMobile: currentReqData.customerMobile,
          price: currentReqData.price,
          status: 'accepted',
          vehicle: currentReqData.vehicleType,
          timestamp: Date.now()
        };
        db.ref('partners/' + driverMobile + '/history').push(h).catch(()=>{});
        db.ref('partners/' + driverMobile).update({ onDuty:true, lastRide: Date.now() }).catch(()=>{});
        el('reqPopup').style.display = 'none';
        el('pickupCard').style.display = 'block';
        el('custPhoneDisplay').innerText = 'Customer: ' + (currentReqData.customerMobile || '‚Äî');
        el('callBtn').href = 'tel:' + (currentReqData.customerMobile || '');
        drawRoute(driverLat, driverLng, currentReqData.pickupLat, currentReqData.pickupLng, '#d4af37');
        // update topbar, income maybe
        refreshTodayIncome();
      }
    });
  }

  // verify OTP and start trip
  function verifyOtp(){
    const entered = el('otpIn').value.trim();
    if (!currentReqData) return alert('No request loaded');
    if (entered === String(currentReqData.otp)) {
      db.ref('requests/' + currentReqKey).update({ status:'started', startedAt: Date.now() }).catch(()=>{});
      el('pickupCard').style.display = 'none';
      el('dropCard').style.display = 'block';
      // draw drop route if present
      if (currentReqData.dropLat && currentReqData.dropLng) {
        drawRoute(currentReqData.pickupLat, currentReqData.pickupLng, currentReqData.dropLat, currentReqData.dropLng, '#10b981');
      } else {
        alert('Drop location not available. Ask customer.');
      }
      // update partner history entry
      updatePartnerHistoryStatus(currentReqKey, 'started');
    } else {
      alert('Wrong OTP');
    }
  }

  // complete ride
  function completeRide(){
    if (!currentReqKey || !currentReqData) return alert('No active ride');
    db.ref('requests/' + currentReqKey).update({ status:'completed', completedAt: Date.now() }).then(()=>{
      el('dropCard').style.display = 'none';
      el('billModal').style.display = 'flex';
      el('billAmount').innerText = '‚Çπ' + (currentReqData.price || 0);
      updatePartnerHistoryStatus(currentReqKey, 'completed');
      refreshTodayIncome();
    }).catch(e => alert('Complete failed'));
  }

  function finishAndNext(){
    // cleanup
    el('billModal').style.display = 'none';
    if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
    if (pickupMarker) { map.removeLayer(pickupMarker); pickupMarker = null; }
    if (dropMarker) { map.removeLayer(dropMarker); dropMarker = null; }
    currentReqKey = null; currentReqData = null; isRequesting = false;
    startListening();
  }

  function cancelRide(){
    if (!confirm('Cancel ride?')) return;
    db.ref('requests/' + currentReqKey).update({ status:'cancelled' }).then(()=>{
      isRequesting = false;
      location.reload();
    }).catch(()=>alert('Cancel failed'));
  }

  // ---------- route drawing ----------
  function drawRoute(lat1, lon1, lat2, lon2, color){
    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline([[lat1,lon1],[lat2,lon2]], { color, weight:5 }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding: [40,40] });
  }

  // ---------- helpers ----------
  function getDist(lat1, lon1, lat2, lon2){
    const R = 6371;
    const dLat = (lat2-lat1)*(Math.PI/180);
    const dLon = (lon2-lon1)*(Math.PI/180);
    const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180))*Math.sin(dLon/2)*Math.sin(dLon/2);
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
  }

  // ---------- history & today income ----------
  async function fetchHistory(){
    if (!driverMobile) return;
    const snap = await db.ref('partners/' + driverMobile + '/history').orderByChild('timestamp').once('value');
    const data = snap.val() || {};
    renderHistoryList(data);
  }

  function renderHistoryList(dataObj){
    const container = el('historyList');
    container.innerHTML = '';
    const keys = Object.keys(dataObj || {}).sort((a,b) => (dataObj[b].timestamp||0) - (dataObj[a].timestamp||0));
    if (!keys.length) { container.innerHTML = '<div style="padding:18px;color:#9aa3b2">No rides yet</div>'; return; }
    keys.forEach(k => {
      const it = dataObj[k];
      const t = new Date(it.timestamp||Date.now()).toLocaleString();
      const row = document.createElement('div'); row.className = 'hist-item';
      row.innerHTML = `<div>
          <div style="font-weight:900">‚Çπ${it.price || 0} ‚Ä¢ ${it.vehicle || ''}</div>
          <div class="muted">${t}</div>
        </div>
        <div style="text-align:right">
          <div class="muted">${(it.status||'').toUpperCase()}</div>
        </div>`;
      container.appendChild(row);
    });
  }

  async function refreshTodayIncome(){
    if (!driverMobile) return;
    const [s,e] = fmtTodayUnixRange();
    const snap = await db.ref('partners/' + driverMobile + '/history').orderByChild('timestamp').startAt(s).endAt(e).once('value');
    const data = snap.val() || {};
    let total = 0;
    Object.values(data).forEach(it => { if (it.status === 'completed' || it.status === 'completed') total += Number(it.price || 0); });
    el('incomeBox').innerText = 'Today ‚Çπ' + total;
  }

  async function updatePartnerHistoryStatus(reqId, newStatus){
    if (!driverMobile) return;
    const ref = db.ref('partners/' + driverMobile + '/history');
    const snap = await ref.orderByChild('reqId').equalTo(reqId).once('value');
    const matches = snap.val();
    if (!matches) return;
    Object.keys(matches).forEach(k => ref.child(k).update({ status: newStatus }));
    fetchHistory();
    refreshTodayIncome();
  }

  // ---------- history modal ----------
  function openHistory(){ fetchHistory(); el('historyModal').style.display = 'flex'; }
  function closeHistory(){ el('historyModal').style.display = 'none'; }

  // ---------- app init: restore login if present ----------
  (function init() {
    const ok = loadDriverPrefs();
    if (ok && driverMobile) {
      // auto show app
      el('dLoginScreen').style.display = 'none';
      el('dApp').style.display = 'block';
      el('helpBtn').style.display = 'block';
      updateTopbar();
      initializeMap([17.3850,78.4867],13);
      startGPSCheck();
      startListening();
      refreshTodayIncome();
    }
  })();

  // expose debug
  window.debugRequests = async function(){ const s = await db.ref('requests').orderByChild('timestamp').limitToLast(50).once('value'); console.log(s.val()); alert('Check console'); };

</script>
</body>
</html>
