<!-- PART 1: HTML + CORE UI (Login, Map container, Modal shell, basic placeholders) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MS Partner ‚Äî PART 1</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  :root{
    --gold:#d4af37; --bg:#000; --panel:#0a0f14; --muted:#9aa3b2;
    --card:#0f1619; --accent:#07b
  }
  /* page base */
  html,body{height:100%;margin:0;font-family:Inter,Roboto,Arial;background:var(--bg);color:#fff}
  /* login screen */
  #login{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;background:linear-gradient(180deg,#000,#061018);flex-direction:column;gap:12px;padding:18px}
  .brand{font-size:24px;font-weight:900;color:var(--gold);letter-spacing:1px}
  .inp{width:86%;padding:12px;border-radius:10px;border:1px solid #233;background:#0f1517;color:#fff;text-align:center;font-size:16px}
  .row{display:flex;gap:10px;align-items:center}
  .btn{padding:10px 14px;border-radius:10px;border:none;background:var(--gold);color:#000;font-weight:800;cursor:pointer}
  .btn.ghost{background:#222;color:#fff;border:1px solid #333}
  .hint{font-size:13px;color:var(--muted)}
  /* app shell */
  #app{display:none;position:fixed;inset:0;overflow:hidden}
  #map{height:100%;width:100%}
  /* floating controls */
  .float{position:fixed;z-index:9998;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
  #menuBtn{right:14px;top:14px;padding:9px 12px;border-radius:10px;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.03)}
  #status{left:14px;top:14px;padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.03)}
  #centerBtn{right:14px;bottom:18px;padding:10px;border-radius:10px;background:#fff;color:#000}
  /* mini card (ride popup) */
  .card{position:fixed;left:12px;right:12px;bottom:18px;background:rgba(12,18,20,0.98);padding:12px;border-radius:12px;border:1px solid #111;z-index:9997;display:none}
  .card .title{font-weight:900;color:var(--gold);font-size:18px}
  .col{display:flex;justify-content:space-between;align-items:center}
  .small{font-size:12px;color:var(--muted)}
  .big{font-weight:900;color:var(--gold);font-size:22px}
  /* modal */
  #modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:10000}
  #modal .box{background:var(--panel);padding:14px;border-radius:10px;width:94%;max-width:420px;border:1px solid rgba(255,255,255,0.03)}
  /* tiny helpers */
  .muted{color:var(--muted)}
  .flex{display:flex;gap:8px}
  a.link{color:var(--gold);text-decoration:none;font-weight:700}
  /* responsive */
  @media(min-width:700px){ .inp{width:320px} #modal .box{width:420px} }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login">
  <div class="brand">MS PARTNER</div>
  <input id="phone" class="inp" type="tel" placeholder="Enter mobile number" />
  <div class="row" style="width:86%;justify-content:center">
    <button class="btn" onclick="startFlow()">START DUTY</button>
    <button class="btn ghost" onclick="openVehiclePicker()">VEHICLE</button>
  </div>
  <div style="width:86%;display:flex;justify-content:center;margin-top:6px">
    <button class="btn ghost" onclick="openHelp()">HELP ‚Ä¢ 100 / Mustaqeem</button>
  </div>
  <div class="hint" style="margin-top:10px">Login with mobile number only ‚Äî vehicle pick after login. Vehicle saved until logout.</div>
</div>

<!-- APP (map + UI) -->
<div id="app">
  <div id="map"></div>

  <!-- top controls -->
  <button id="menuBtn" class="float" onclick="toggleMenu()">‚ò∞</button>
  <div id="status" class="float">OFF DUTY</div>

  <!-- center map btn -->
  <button id="centerBtn" style="position:fixed;right:14px;bottom:80px" onclick="recenterMap()">üéØ</button>

  <!-- mini ride card -->
  <div id="miniCard" class="card">
    <div class="title">NEW RIDE REQUEST üîî</div>
    <div style="margin-top:8px" class="col">
      <div>
        <div class="small">PICKUP DIST</div>
        <div id="pdist" class="big">-- KM</div>
      </div>
      <div style="text-align:right">
        <div class="small">FARE</div>
        <div id="fare" class="big">‚Çπ0</div>
      </div>
    </div>

    <div style="margin-top:10px" class="flex">
      <button class="btn" onclick="acceptReq()">ACCEPT</button>
      <button class="btn ghost" onclick="skipReq()">SKIP</button>
    </div>
  </div>
</div>

<!-- MODAL (vehicle picker, history, OTP screens will load here) -->
<div id="modal">
  <div class="box" id="modalBox"></div>
</div>

<!-- AUDIO TONE -->
<audio id="ringtone" src="https://media.geeksforgeeks.org/wp-content/uploads/20190531135120/beep.mp3"></audio>

<!-- libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- PART1: small helpers + firebase init (real logic in Part2/Part3) -->
<script>
/* FIREBASE CONFIG (keep same) */
const firebaseConfig = {
 apiKey: "AIzaSyCJpo25tYCN_fXP8aCckgA4WrD962KCsQ8",
 authDomain: "hyd-texi.firebaseapp.com",
 projectId: "hyd-texi",
 storageBucket: "hyd-texi.firebasestorage.app",
 messagingSenderId: "807048727786",
 appId: "1:807048727786:web:7ef03573876c70b76e1b93",
 databaseURL: "https://hyd-texi-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* DOM helpers */
const $ = id => document.getElementById(id);
function showModal(html){ $('modalBox').innerHTML = html; $('modal').style.display='flex'; }
function closeModal(){ $('modal').style.display='none'; }

/* small UI actions (to be wired in later parts) */
function openHelp(){
  showModal(`<div style="text-align:center">
    <h3 style="color:var(--gold);margin:0">EMERGENCY</h3>
    <div style="margin-top:10px"><a class="link" href="tel:100">üëÆ Police (100)</a></div>
    <div style="margin-top:8px"><a class="link" href="tel:9381667208">üë§ Mustaqeem</a></div>
    <div style="margin-top:12px"><button class="btn" onclick="closeModal()">CLOSE</button></div>
  </div>`);
}

/* vehicle picker (basic shell) */
function openVehiclePicker(){
  showModal(`<div>
    <h3 style="color:var(--gold);margin:0">Choose vehicle</h3>
    <div style="display:flex;gap:8px;margin-top:10px;justify-content:center">
      <button class="btn" onclick="selectVehicle('car')">CAR</button>
      <button class="btn" onclick="selectVehicle('auto')" style="background:#ff9f1c">AUTO</button>
      <button class="btn" onclick="selectVehicle('bike')" style="background:#7ed957">BIKE</button>
    </div>
    <div style="margin-top:10px"><input id="regNo" class="inp" placeholder="Vehicle reg no (optional)"></div>
    <div style="display:flex;gap:8px;margin-top:10px;justify-content:center">
      <button class="btn" onclick="confirmVehicle()">CONFIRM</button>
      <button class="btn ghost" onclick="closeModal()">CANCEL</button>
    </div>
  </div>`);
}

/* placeholders for later wiring */
let driverMobile=null, selectedVehicle=null, vehicleReg=null;
function selectVehicle(t){ selectedVehicle=t; }
function confirmVehicle(){
  vehicleReg = $('regNo').value.trim() || null;
  localStorage.setItem('ms_pref', JSON.stringify({type:selectedVehicle, reg:vehicleReg}));
  closeModal();
  // If already logged in, start app; otherwise user must press START DUTY
  if(driverMobile) startDuty();
}

/* start process */
function startFlow(){
  const no = $('phone').value.trim();
  if(no.length < 10){ alert('Enter valid mobile number'); return; }
  driverMobile = no;
  const pref = localStorage.getItem('ms_pref');
  if(pref){
    const p = JSON.parse(pref); selectedVehicle=p.type; vehicleReg=p.reg;
    startDuty();
  } else {
    openVehiclePicker();
  }
}

/* show app shell */
function startDuty(){
  $('login').style.display='none';
  $('app').style.display='block';
  $('status').innerText = 'ON DUTY (' + (selectedVehicle||'N/A') + ')';
  // map + gps logic will be added in part2
}

/* small UI helpers used by part2/part3 */
function recenterMap(){ /* implemented in Part2 */ }
function acceptReq(){ /* implemented in Part3 */ }
function skipReq(){ /* implemented in Part3 */ }
function toggleMenu(){ /* implemented in Part3 */ }
</script>
<!-- PART 2: Map initialization, GPS, markers, utilities, and startDuty override -->
<script>
/* PART 2: Map + GPS + helpers
   Paste this AFTER Part 1. It overrides startDuty to wire map & GPS,
   and provides utilities used by Part3 (drawRoute, addPickupMarker, etc).
*/

let map = null;
let meMarker = null;
let followMe = true;
let watchId = null;
let myLat = null, myLng = null;
let pickupMarker = null, dropMarker = null, routeLine = null;

/* initMap: creates Leaflet map and adds basic controls */
function initMap(initial = [17.3850, 78.4867], zoom = 13) {
  if (map) return;
  map = L.map('map', { zoomControl: true }).setView(initial, zoom);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  // simple driver marker (custom div icon)
  const carHtml = "<div style='background:var(--gold);border-radius:8px;padding:6px 8px;font-weight:800;color:#000'>YOU</div>";
  const divIcon = L.divIcon({ html: carHtml, className: '', iconSize: [60, 28], iconAnchor: [30, 14] });

  meMarker = L.marker(initial, { icon: divIcon, draggable: true }).addTo(map).bindPopup('You (drag to adjust)');
  meMarker.on('dragend', (e) => {
    const p = e.target.getLatLng();
    myLat = p.lat; myLng = p.lng;
    followMe = false;
    // small feedback popup
    meMarker.bindPopup('Location set manually').openPopup();
  });

  map.on('dragstart', () => { followMe = false; });
}

/* startGPS: request geolocation and begin watchPosition */
function startGPS() {
  if (!navigator.geolocation) {
    alert('GPS not supported. You can drag marker to set location.');
    return;
  }

  // get current position first
  navigator.geolocation.getCurrentPosition((pos) => {
    myLat = pos.coords.latitude; myLng = pos.coords.longitude;
    if (!map) initMap([myLat, myLng], 15);
    meMarker.setLatLng([myLat, myLng]);
    map.setView([myLat, myLng], 15);
    // start watch
    if (!watchId) {
      watchId = navigator.geolocation.watchPosition(onPositionUpdate, onPositionError, {
        enableHighAccuracy: true, maximumAge: 2000, timeout: 10000
      });
    }
  }, (err) => {
    console.warn('Initial GPS error', err);
    // init map with default; allow user to drag the marker
    if (!map) initMap();
    alert('Allow location access or drag the marker to set your location.');
    // still try to watch
    try { if (!watchId) watchId = navigator.geolocation.watchPosition(onPositionUpdate, onPositionError, { enableHighAccuracy:true }); } catch(e){}
  }, { enableHighAccuracy: true, timeout: 7000 });
}

function onPositionUpdate(pos) {
  myLat = pos.coords.latitude; myLng = pos.coords.longitude;
  if (meMarker) meMarker.setLatLng([myLat, myLng]);
  if (followMe && map) map.panTo([myLat, myLng]);
}

function onPositionError(err) {
  console.error('GPS watch error', err);
  // fallback: stop watch so dev can drag marker
  if (watchId) { try { navigator.geolocation.clearWatch(watchId); } catch(e){}; watchId = null; }
  // user will be prompted to drag marker
}

/* recenterMap: center to my current location */
function recenterMap() {
  followMe = true;
  if (myLat && myLng && map) {
    map.setView([myLat, myLng], Math.max(map.getZoom(), 15));
    if (meMarker) meMarker.openPopup();
  } else if (map) {
    // center to map center as fallback
    const c = map.getCenter();
    myLat = c.lat; myLng = c.lng;
    if (meMarker) meMarker.setLatLng(c);
  }
}

/* drawRoute: draw simple straight polyline between two points (lat,lng) */
function drawRoute(lat1, lng1, lat2, lng2, color = '#2ecc71') {
  // remove existing
  if (routeLine) { try { map.removeLayer(routeLine); } catch(e){} routeLine = null; }
  if (!map) return;
  routeLine = L.polyline([[lat1, lng1], [lat2, lng2]], { color: color, weight: 5, opacity: 0.9 }).addTo(map);
  try { map.fitBounds(routeLine.getBounds(), { padding: [40, 40] }); } catch(e){}
}

/* addPickupMarker / addDropMarker */
function addPickupMarker(lat, lng) {
  if (!map) initMap();
  if (pickupMarker) { try { map.removeLayer(pickupMarker); } catch(e){} pickupMarker = null; }
  const ico = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [36, 36], iconAnchor: [18,36] });
  pickupMarker = L.marker([lat, lng], { icon: ico }).addTo(map).bindPopup('Pickup');
  // pan to show both points nicely
  try {
    if (myLat && myLng) {
      drawRoute(myLat, myLng, lat, lng, '#d4af37');
    } else {
      map.setView([lat, lng], 15);
    }
  } catch(e){}
}

function addDropMarker(lat, lng) {
  if (!map) initMap();
  if (dropMarker) { try { map.removeLayer(dropMarker); } catch(e){} dropMarker = null; }
  const ico = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25,41], iconAnchor: [12,41] });
  dropMarker = L.marker([lat, lng], { icon: ico }).addTo(map).bindPopup('Drop');
}

/* clearRouteAndMarkers: cleanup after trip */
function clearRouteAndMarkers() {
  try { if (routeLine) map.removeLayer(routeLine); } catch(e){} routeLine = null;
  try { if (pickupMarker) map.removeLayer(pickupMarker); } catch(e){} pickupMarker = null;
  try { if (dropMarker) map.removeLayer(dropMarker); } catch(e){} dropMarker = null;
}

/* small helper used by Part3 to show mini card quickly */
function showMiniCard(price, pickupDistKm) {
  $('fare').innerText = '‚Çπ' + (price||0);
  $('pdist').innerText = (pickupDistKm!==undefined ? (pickupDistKm.toFixed(1)+' KM') : '-- KM');
  $('miniCard').style.display = 'block';
  try { document.getElementById('ringtone').play().catch(()=>{}); } catch(e){}
}

/* hide mini card */
function hideMiniCard() {
  $('miniCard').style.display = 'none';
  try { const r = document.getElementById('ringtone'); r.pause(); r.currentTime = 0; } catch(e){}
}

/* small distance calc (used maybe by Part3) */
function distanceKm(aLat, aLng, bLat, bLng) {
  const R = 6371;
  const dLat = (bLat - aLat) * Math.PI / 180;
  const dLon = (bLng - aLng) * Math.PI / 180;
  const A = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(aLat * Math.PI / 180) * Math.cos(bLat * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
  return R * (2 * Math.atan2(Math.sqrt(A), Math.sqrt(1 - A)));
}

/* OVERRIDE startDuty (from Part1) to wire everything */
(function overrideStartDuty() {
  // keep original reference if needed (not necessary)
  window.startDuty = function() {
    // show UI (same as part1 had)
    const pref = localStorage.getItem('ms_pref');
    if (pref) {
      try { const p = JSON.parse(pref); selectedVehicle = p.type; vehicleReg = p.reg; } catch(e){}
    }
    $('login').style.display = 'none';
    $('app').style.display = 'block';
    $('status').innerText = 'ON DUTY (' + (selectedVehicle||'N/A') + ')';
    // init map & gps
    initMap();
    startGPS();
    // try starting listener if Part3 provided startListen
    try { if (typeof startListen === 'function') startListen(); } catch(e){ console.warn('startListen not ready'); }
  };
})();

        </script>
  
  <!-- PART 3: Requests, Accept/OTP, History, Menu, Income, and control wiring -->
<script>
/*
 PART 3 for MS PARTNER
 Paste AFTER Part1 and Part2. This wires requests, menu, OTP flow, history, today income.
*/

let currentKey = null;
let currentData = null;
let listeningRef = null;
let isProcessing = false; // prevent multiple accept flows

/* Utility: push local history and (optional) to firebase under partners/<mobile>/history */
function pushHistory(item) {
  try {
    const raw = localStorage.getItem('ms_history') || '[]';
    const arr = JSON.parse(raw);
    arr.push(item);
    localStorage.setItem('ms_history', JSON.stringify(arr));
    // also write to firebase partner node (non-blocking)
    if (driverMobile) {
      try { db.ref('partners/' + driverMobile + '/history').push(item).catch(()=>{}); } catch(e){}
    }
  } catch(e){ console.warn('history push err', e); }
}

/* Compute today income from local history */
function getTodayIncome() {
  try {
    const raw = localStorage.getItem('ms_history') || '[]';
    const arr = JSON.parse(raw);
    const start = new Date(); start.setHours(0,0,0,0);
    let total = 0;
    arr.forEach(r => {
      if (!r.ts) return;
      if (r.status === 'completed' && r.price) {
        if (r.ts >= start.getTime()) total += Number(r.price || 0);
      }
    });
    return total;
  } catch(e){ return 0; }
}

/* Show the right-side menu (toggle) */
function toggleMenu() {
  const existing = document.getElementById('menuPanel');
  if (existing) { existing.remove(); return; }
  const panel = document.createElement('div');
  panel.id = 'menuPanel';
  panel.style = 'position:fixed;right:12px;top:56px;width:240px;background:var(--panel);padding:12px;border-radius:10px;z-index:10020;border:1px solid rgba(255,255,255,0.03)';
  panel.innerHTML = `
    <div style="font-weight:900;color:var(--gold);margin-bottom:8px">${driverMobile||''}</div>
    <div class="small">Vehicle: <b>${(selectedVehicle||'‚Äî').toUpperCase()}</b> ${vehicleReg?('<span class="small"> ‚Ä¢ '+vehicleReg+'</span>'):''}</div>
    <div style="margin-top:10px"><button class="btn" onclick="changeVehicleFromMenu()">Change Vehicle</button></div>
    <div style="margin-top:8px"><button class="btn" onclick="showHistoryModal()">History</button></div>
    <div style="margin-top:8px"><button class="btn" onclick="showTodayIncome()">Today Income</button></div>
    <div style="margin-top:8px"><button class="btn ghost" onclick="toggleDuty()">Toggle Duty</button></div>
    <div style="margin-top:8px"><button class="btn" style="background:#ff6b6b" onclick="logoutAll()">Logout</button></div>
  `;
  document.body.appendChild(panel);
}

/* Change vehicle from menu */
function changeVehicleFromMenu(){
  localStorage.removeItem('ms_pref');
  alert('Vehicle preference cleared. Pick again.');
  location.reload();
}

/* Show history modal */
function showHistoryModal(){
  const raw = localStorage.getItem('ms_history') || '[]';
  const arr = JSON.parse(raw);
  let html = `<h3 style="color:var(--gold);margin:0">History</h3><div style="max-height:50vh;overflow:auto;margin-top:8px">`;
  if (!arr.length) html += '<div class="small muted">No rides yet</div>';
  arr.slice().reverse().forEach(it => {
    html += `<div style="padding:8px;border-bottom:1px solid #111">
      <div style="font-weight:800">‚Çπ${it.price||0} ‚Ä¢ ${it.status||''}</div>
      <div class="small muted">${new Date(it.ts).toLocaleString()}</div>
    </div>`;
  });
  html += `</div><div style="margin-top:10px"><button class="btn" onclick="closeModal()">CLOSE</button></div>`;
  showModal(html);
}

/* Show today's income */
function showTodayIncome(){
  const income = getTodayIncome();
  showModal(`<div style="text-align:center">
    <h3 style="color:var(--gold);margin:0">Today Income</h3>
    <div style="font-size:28px;font-weight:900;margin-top:10px">‚Çπ${income}</div>
    <div style="margin-top:12px"><button class="btn" onclick="closeModal()">CLOSE</button></div>
  </div>`);
}

/* Toggle ON/OFF duty */
function toggleDuty(){
  const st = $('status').innerText || '';
  if (st.includes('ON')) {
    $('status').innerText = 'OFF DUTY';
    // stop listening
    stopListen();
  } else {
    $('status').innerText = 'ON DUTY (' + (selectedVehicle||'N/A') + ')';
    // start listening
    startListen();
  }
}

/* START listening for requests (filtered by vehicle type if present) */
function startListen(){
  try {
    if (!db) return console.warn('DB not ready');
    // ensure we don't attach multiple listeners
    if (listeningRef) listeningRef.off();
    listeningRef = db.ref('requests');
    // listen to last 30 to reduce load
    listeningRef.limitToLast(30).on('child_added', handleRequestSnapshot);
    // also listen for child_changed for updates (optional)
    listeningRef.limitToLast(30).on('child_changed', handleRequestSnapshot);
  } catch(e){ console.warn('startListen err', e); }
}

/* stop listening */
function stopListen(){
  try {
    if (listeningRef) { listeningRef.off(); listeningRef = null; }
  } catch(e){}
}

/* Handle incoming request snapshot */
function handleRequestSnapshot(snap){
  try{
    const d = snap.val();
    const key = snap.key;
    if (!d || d.status !== 'pending') return;
    // vehicle filter: if request has vehicleType and driver has selectedVehicle, ensure match
    if (d.vehicleType && selectedVehicle && d.vehicleType.toLowerCase() !== selectedVehicle) return;
    // ensure we have location to compare
    if (!myLat || !myLng) return;
    const km = distanceKm(myLat, myLng, d.pickupLat, d.pickupLng);
    // only notify if within radius (tweakable)
    const radius = 6.0; // km
    if (km <= radius && !isProcessing) {
      currentKey = key;
      currentData = d;
      isProcessing = true;
      showMiniCard(d.price, km);
    }
  } catch(e){ console.warn('handleRequest err', e); }
}

/* ACCEPT request (transaction-safe) */
function acceptReq(){
  if (!currentKey) return alert('No active request');
  try {
    // pause listening while attempting transaction
    stopListen();
    db.ref('requests/' + currentKey).transaction(curr => {
      if (!curr) return; // already removed
      if (curr.status === 'pending') {
        curr.status = 'accepted';
        curr.driverMobile = driverMobile || null;
        curr.driverVehicle = selectedVehicle || null;
        curr.driverReg = vehicleReg || null;
        curr.acceptedAt = Date.now();
        return curr;
      }
      return; // abort if not pending
    }, (err, committed, snapshot) => {
      if (err) {
        console.warn('tx err', err);
        alert('Accept failed');
        isProcessing = false;
        startListen();
      } else if (!committed) {
        alert('Booking missed or already taken');
        hideMiniCard();
        currentKey = null; currentData = null; isProcessing = false;
        startListen();
      } else {
        // accepted successfully
        const acceptedData = snapshot.val();
        pushHistory({reqId: currentKey, price: acceptedData.price || 0, status: 'accepted', ts: Date.now(), vehicle: selectedVehicle});
        // open pickup modal with OTP displayed and start trip flow
        showModal(`<div>
          <h3 style="color:var(--gold);margin:0">Heading to Pickup</h3>
          <div style="margin-top:8px">Customer: <b>${acceptedData.customerMobile||'--'}</b></div>
          <div style="margin-top:8px">OTP: <b>${acceptedData.otp||'----'}</b></div>
          <div style="margin-top:10px"><input id="otpInput" class="inp" placeholder="Enter OTP to start"></div>
          <div style="display:flex;gap:8px;margin-top:10px;justify-content:center">
            <button class="btn" onclick="verifyOtpStart()">START TRIP</button>
            <button class="btn ghost" onclick="cancelAccepted()">CANCEL</button>
          </div>
        </div>`);
        hideMiniCard();
      }
    });
  } catch(e){
    console.warn('accept err', e);
    isProcessing = false;
    startListen();
  }
}

/* Skip request (ignore) */
function skipReq(){
  hideMiniCard();
  currentKey = null; currentData = null; isProcessing = false;
  // continue listening
  startListen();
}

/* Cancel after accept (driver cancels) */
function cancelAccepted(){
  if (!currentKey) { closeModal(); isProcessing=false; startListen(); return; }
  db.ref('requests/' + currentKey).update({ status:'cancelled' }).then(()=>{
    pushHistory({reqId: currentKey, price: currentData?.price||0, status:'cancelled', ts: Date.now(), vehicle: selectedVehicle});
    closeModal();
    currentKey = null; currentData = null; isProcessing = false;
    startListen();
  }).catch(err=>{ alert('Cancel failed'); console.warn(err); });
}

/* Verify OTP and start trip */
function verifyOtpStart(){
  const v = (document.getElementById('otpInput') || {}).value || '';
  if (!currentKey || !currentData) { alert('No data'); closeModal(); startListen(); return; }
  if (String(currentData.otp) !== String(v)) { alert('Wrong OTP'); return; }
  // update status to started
  db.ref('requests/' + currentKey).update({ status: 'started', startedAt: Date.now() }).then(()=>{
    pushHistory({reqId: currentKey, price: currentData.price||0, status:'started', ts: Date.now(), vehicle: selectedVehicle});
    closeModal();
    // show drop screen & draw route if available
    if (currentData.dropLat && currentData.dropLng) {
      addDropMarker(currentData.dropLat, currentData.dropLng);
      drawRoute(myLat||currentData.pickupLat, myLng||currentData.pickupLng, currentData.dropLat, currentData.dropLng, '#2ecc71');
    }
    showModal(`<div style="text-align:center">
      <h3 style="color:var(--gold);margin:0">Trip Started</h3>
      <div style="margin-top:10px">Navigate to drop and press End Trip when done.</div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:center">
        <button class="btn" onclick="openNavigationToDrop()">OPEN NAV</button>
        <button class="btn ghost" onclick="endTrip()">END TRIP</button>
      </div>
    </div>`);
  }).catch(err=>{ alert('Start failed'); console.warn(err); });
}

/* open external maps for drop */
function openNavigationToDrop(){
  if (!currentData || !currentData.dropLat) return alert('Drop missing');
  const origin = (myLat && myLng) ? `${myLat},${myLng}` : `${currentData.pickupLat},${currentData.pickupLng}`;
  const dest = `${currentData.dropLat},${currentData.dropLng}`;
  const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(dest)}&travelmode=driving`;
  window.open(url, '_blank');
}

/* End trip and mark completed */
function endTrip(){
  if (!currentKey || !currentData) { alert('No trip active'); closeModal(); startListen(); return; }
  db.ref('requests/' + currentKey).update({ status: 'completed', completedAt: Date.now() }).then(()=>{
    pushHistory({reqId: currentKey, price: currentData.price||0, status:'completed', ts: Date.now(), vehicle: selectedVehicle});
    closeModal();
    alert('Trip completed. Collect ‚Çπ' + (currentData.price||0));
    // cleanup
    clearRouteAndMarkers();
    currentKey = null; currentData = null; isProcessing = false;
    // update Today income display if menu open
    startListen();
  }).catch(err => { alert('Complete failed'); console.warn(err); });
}

/* Logout: clear prefs and reload */
function logoutAll(){
  localStorage.removeItem('ms_pref');
  // do not clear history, but you can clear if needed
  // localStorage.removeItem('ms_history');
  location.reload();
}

/* Boot: if already on duty & pref available, start listening (handles page refresh) */
(function bootListenOnLoad(){
  try {
    const pref = localStorage.getItem('ms_pref');
    if (pref && driverMobile) {
      // short delay to allow Part2 to initialize map overrideStartDuty
      setTimeout(()=>{ if ($('app').style.display !== 'block') { /* user not started; do nothing */ } else { startListen(); } }, 1000);
    }
  } catch(e){}
})();

</script>
```Ó®Å0Ó®Ç
</body>
</html>
