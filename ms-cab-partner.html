<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MS Partner - Professional Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin:0; font-family: 'Segoe UI', Roboto, Arial, sans-serif; height:100vh; overflow:hidden; background:#000; color:#fff; }

        /* General UI Styles */
        #dLoginScreen, #dVehicleSetup, #dMenu { position:fixed; inset:0; background:#000; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; text-align:center; }
        .logo { font-size: 2.2rem; color: #d4af37; font-weight: bold; margin-bottom: 20px; letter-spacing: 2px; }
        .d-inp { width:80%; padding:15px; border-radius:8px; border:1px solid #333; background:#111; color:#fff; text-align:center; margin-bottom:15px; font-size:1.1rem; }
        .d-btn { width:85%; padding:15px; border-radius:8px; border:none; background:#d4af37; color:#000; font-weight:bold; cursor:pointer; font-size:1.1rem; }
        #dApp { display:none; height:100vh; width:100%; flex-direction:column; }
        #map { height:100%; width:100%; background: #ffffff; }

        /* Vehicle Selection Styles */
        .vehicle-type-select { display: flex; justify-content: space-around; width: 85%; margin-bottom: 25px; }
        .v-opt { padding: 20px 10px; background: #222; border: 2px solid #333; border-radius: 10px; width: 45%; color: #888; cursor: pointer; transition: all 0.2s; }
        .v-opt.selected { background: #d4af37; color: #000; border-color: #fff; box-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
        .v-opt span { display: block; font-size: 2.5rem; margin-bottom: 5px; }

        /* Header and Duty Toggle */
        #appHeader { position: absolute; top: 0; left: 0; right: 0; height: 60px; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        #dutyStatus { font-weight: bold; font-size: 1rem; }
        .duty-on { color: #2ecc71; }
        .duty-off { color: #f39c12; }
        .menu-btn { font-size: 1.5rem; color: #d4af37; cursor: pointer; }

        /* Menu Modal */
        #dMenu { justify-content: flex-start; align-items: flex-start; background: rgba(0,0,0,0.95); padding: 50px 20px; transform: translateX(100%); transition: transform 0.3s ease-out; }
        #dMenu.active { transform: translateX(0); }
        .menu-item { width: 100%; padding: 15px 0; border-bottom: 1px solid #333; text-align: left; font-size: 1.2rem; cursor: pointer; color: white; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item span { display: block; font-size: 0.8rem; color: #888; }
        .close-menu { position: absolute; top: 15px; right: 15px; font-size: 2rem; color: white; cursor: pointer; }
        #incomeDisplay { font-size: 1.8rem; font-weight: bold; color: #2ecc71; margin-top: 5px; }

        /* Existing styles for card, buttons, etc. remain here... */
        .recenter-btn { position: absolute; bottom: 150px; right: 20px; width: 45px; height: 45px; /* ... */ z-index: 1000; }
        .card { position: absolute; left:10px; right:10px; bottom:20px; z-index:1001; }
        .contact-btn, .map-nav-btn { /* ... */ margin-bottom:10px; }
    </style>
</head>
<body>

    <audio id="ringtone" src="https://media.geeksforgeeks.org/wp-content/uploads/20190531135120/beep.mp3" loop></audio>

    <div id="helpBtn" class="help-btn" onclick="openHelp()">üÜò HELP</div>
    <div id="helpModal">
        <div class="help-box">
            <h2 style="color:red; margin-top:0;">EMERGENCY HELP</h2>
            <a href="tel:100" class="call-opt" style="border-color:red;">üëÆ POLICE (100)</a>
            <a href="tel:9381667208" class="call-opt" style="border-color:#d4af37; color:#d4af37;">üë§ MUSTAQEEM (Founder)</a>
            <button onclick="closeHelp()" style="margin-top:15px; padding:10px 30px; background:#333; color:white; border:none; border-radius:5px;">CLOSE</button>
        </div>
    </div>

    <div id="dLoginScreen">
        <div class="logo">MS PARTNER</div>
        <input id="dPhone" class="d-inp" type="tel" placeholder="Enter Mobile Number">
        <button class="d-btn" onclick="tryLogin()">LOGIN & CONTINUE</button>
    </div>

    <div id="dVehicleSetup" style="display:none;">
        <div class="logo">SETUP VEHICLE</div>
        <p style="color:#aaa; margin-bottom: 20px;">Please select your vehicle and enter the number.</p>
        
        <div class="vehicle-type-select">
            <div id="vCar" class="v-opt" onclick="selectVehicle('Car')"><span>üöó</span> Car</div>
            <div id="vBike" class="v-opt" onclick="selectVehicle('Bike')"><span>üèçÔ∏è</span> Bike</div>
        </div>
        
        <input id="dVehNumber" class="d-inp" type="text" placeholder="Vehicle Number (e.g., TS09AB1234)">
        <button class="d-btn" onclick="saveVehicleDetails()">CONTINUE</button>
    </div>

    <div id="dMenu">
        <div class="close-menu" onclick="closeMenu()">‚úï</div>
        <div class="logo" style="margin-bottom: 40px;">DASHBOARD</div>
        
        <div class="menu-item">Today's Earnings: <span id="incomeDisplay">‚Çπ0</span></div>
        <div class="menu-item" onclick="viewHistory()">Trip History <span>(Past Rides)</span></div>
        <div class="menu-item" onclick="showCustomConfirm('Logout', 'Are you sure you want to log out and go offline?', logout)">
            <span style="color:red; font-weight:bold;">LOGOUT</span>
            <span>(Stop receiving requests)</span>
        </div>
    </div>

    <div id="dApp">
        <div id="appHeader">
            <div style="display:flex; align-items:center;">
                <label class="switch" style="margin-right: 15px;">
                    <input type="checkbox" id="dutyToggle" onchange="toggleDuty()">
                    <span class="slider round"></span>
                </label>
                <div id="dutyStatus" class="duty-off">OFF DUTY</div>
            </div>
            <div id="menuBtn" class="menu-btn" onclick="openMenu()">‚ò∞</div>
        </div>

        <div id="map"></div>
        <div class="recenter-btn" onclick="recenterMap()">üéØ</div>

        <div id="reqPopup" class="card">
            <div style="color:#fff; font-weight:bold; margin-bottom:5px;">NEW RIDE REQUEST üîî</div>
            <div class="fare-txt">‚Çπ<span id="fareDisplay">0</span></div>
            
            <div class="info-row">
                <div class="info-col"><div class="lbl">PICKUP DIST</div><div class="val" id="pickupDist">...</div></div>
                <div class="info-col"><div class="lbl">TRIP DIST</div><div class="val" id="tripDist">...</div></div>
            </div>
            
            <div class="btn-row">
                <button class="skip-btn" onclick="skipRide()">SKIP ‚úï</button>
                <button class="accept-btn" onclick="tryAcceptRide()">ACCEPT ‚úì</button>
            </div>
        </div>

        <div id="pickupCard" class="card" style="border-top: 4px solid yellow;">
            <div style="color:yellow; font-weight:bold; margin-bottom:5px;">HEADING TO PICKUP üü°</div>
            
            <div style="color:#aaa; font-size:0.8rem;">CUSTOMER MOBILE</div>
            <div id="custMobDisp" style="font-size:1.4rem; font-weight:bold; color:white; margin-bottom:10px;">...</div>
            
            <button id="mapNavBtnPickup" class="map-nav-btn" onclick="openPickupMap()">üó∫Ô∏è GO TO PICKUP</button>

            <a id="callBtn" href="#" class="contact-btn">üìû CALL CUSTOMER</a>

            <div class="otp-box">
                <div style="color:#888; font-size:0.7rem;">ENTER OTP TO START TRIP</div>
                <div class="otp-row">
                    <input type="number" id="otpIn" class="otp-inp" placeholder="XXXX">
                    <button class="go-btn" onclick="verifyOtp()">START</button>
                </div>
            </div>

            <button onclick="cancelRide()" style="width:100%; margin-top:10px; background:red; color:white; border:none; padding:10px; font-weight:bold; border-radius:8px;">CANCEL RIDE</button>
        </div>

        <div id="dropCard" class="card" style="border-top: 4px solid green;">
            <div style="color:green; font-weight:bold; margin-bottom:5px;">ON TRIP üü¢</div>
            <p style="color:#ccc;">Navigating to Drop Location...</p>
            <h2 style="color:#d4af37; margin:10px 0;">Follow Map Route</h2>
            
            <button id="mapNavBtnDrop" class="map-nav-btn" onclick="openDropMap()">üó∫Ô∏è GO TO DROP</button>
            
            <button class="finish-btn" onclick="completeRide()">END TRIP & GET BILL</button>
        </div>
    </div>
    <div id="billModal" style="display:none;">
    <div class="bill-box">
        <h2>TRIP COMPLETED ‚úÖ</h2>
        <p style="color:#555;">Collect Cash from Customer</p>
        <div class="total-fare" id="billAmount">‚Çπ0</div>
        <button class="accept-btn" onclick="location.reload()">COMPLETE & NEXT</button>
    </div>
</div>

<div id="customDialog" style="display:none; position:fixed; inset:0; z-index:6000; background: rgba(0,0,0,0.45); align-items:center; justify-content:center;">
  <div id="customDialogCard" style="width:90%; max-width:420px; background:#fff; padding:18px; border-radius:12px; box-shadow:0 15px 40px rgba(0,0,0,0.6); color:#000;">
    <div id="customDialogTitle" style="font-weight:800; color:#222; margin-bottom:8px; font-size:16px;">Message</div>
    <div id="customDialogMessage" style="color:#333; line-height:1.4; white-space:pre-wrap; margin-bottom:18px;">Body</div>
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button id="customDialogCancel" style="background:transparent; border:none; color:#007bff; font-weight:700; padding:8px 12px; border-radius:6px;">CANCEL</button>
      <button id="customDialogOk" style="background:#007bff; border:none; color:#fff; font-weight:800; padding:8px 12px; border-radius:6px;">OK</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCJpo25tYCN_fXP8aCckgA4WrD962KCsQ8",
        authDomain: "hyd-texi.firebaseapp.com",
        projectId: "hyd-texi",
        storageBucket: "hyd-texi.firebasestorage.app",
        messagingSenderId: "807048727786",
        appId: "1:807048727786:web:7ef03573876c70b76e1b93",
        databaseURL: "https://hyd-texi-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let map, driverMarker, driverLat, driverLng, driverMobile, driverVehicle, driverVehicleNum;
    let currentReqKey, currentReqData, routeLine, pickupMarker, dropMarker;
    let followDriver = true;
    let gpsWatchId = null;
    let isRequesting = false;
    let isOnDuty = false;
    let todayIncome = parseFloat(localStorage.getItem('msPartnerIncome') || '0');

    // --- NEW: App State Management ---

    window.onload = function() {
        driverMobile = localStorage.getItem('msPartnerMobile');
        driverVehicle = localStorage.getItem('msPartnerVehicle');
        driverVehicleNum = localStorage.getItem('msPartnerVehicleNum');

        if (driverMobile) {
            if (driverVehicle && driverVehicleNum) {
                // If all details exist, go straight to duty screen
                document.getElementById('dLoginScreen').style.display = 'none';
                startApp();
            } else {
                // Logged in, but vehicle setup pending
                document.getElementById('dLoginScreen').style.display = 'none';
                document.getElementById('dVehicleSetup').style.display = 'flex';
            }
        }
        updateIncomeDisplay();
    }

    function tryLogin() {
        const num = document.getElementById('dPhone').value;
        if(num.length < 10) return showCustomAlert('Invalid', 'Enter a valid mobile number');
        
        localStorage.setItem('msPartnerMobile', num);
        driverMobile = num;

        // Check if vehicle details are already set
        if (localStorage.getItem('msPartnerVehicle')) {
            startApp();
        } else {
            document.getElementById('dLoginScreen').style.display = 'none';
            document.getElementById('dVehicleSetup').style.display = 'flex';
        }
    }

    function selectVehicle(type) {
        document.querySelectorAll('.v-opt').forEach(el => el.classList.remove('selected'));
        document.getElementById(`v${type}`).classList.add('selected');
        driverVehicle = type;
    }

    function saveVehicleDetails() {
        const vehNum = document.getElementById('dVehNumber').value;
        if (!driverVehicle) return showCustomAlert('Error', 'Please select a vehicle type.');
        if (vehNum.length < 5) return showCustomAlert('Error', 'Please enter a valid vehicle number.');
        
        localStorage.setItem('msPartnerVehicle', driverVehicle);
        localStorage.setItem('msPartnerVehicleNum', vehNum);
        driverVehicleNum = vehNum;
        
        startApp();
    }

    function startApp() {
        document.getElementById('dLoginScreen').style.display = 'none';
        document.getElementById('dVehicleSetup').style.display = 'none';
        document.getElementById('dApp').style.display = 'flex';
        document.getElementById('helpBtn').style.display = 'block';
        initializeMap([17.3850, 78.4867], 13);
        startGPSCheck();
        toggleDuty(true); // Start ON DUTY by default

        speak("Welcome. You are now on duty.");
    }

    // --- NEW: Menu and History Functions ---
    function updateIncomeDisplay() {
        document.getElementById('incomeDisplay').innerText = `‚Çπ${todayIncome.toFixed(2)}`;
        localStorage.setItem('msPartnerIncome', todayIncome.toFixed(2));
    }

    function openMenu() {
        document.getElementById('dMenu').classList.add('active');
    }

    function closeMenu() {
        document.getElementById('dMenu').classList.remove('active');
    }

    function viewHistory() {
        closeMenu();
        showCustomAlert('Trip History', 'This feature is under development! Current Income: ‚Çπ' + todayIncome.toFixed(2));
    }

    function logout() {
        localStorage.removeItem('msPartnerMobile');
        localStorage.removeItem('msPartnerVehicle');
        localStorage.removeItem('msPartnerVehicleNum');
        localStorage.removeItem('msPartnerIncome');
        location.reload(); // Go back to login screen
    }

    function toggleDuty(initial = false) {
        const toggle = document.getElementById('dutyToggle');
        const statusDiv = document.getElementById('dutyStatus');

        if (initial) {
            toggle.checked = true;
        }

        isOnDuty = toggle.checked;

        if (isOnDuty) {
            statusDiv.innerText = 'ON DUTY';
            statusDiv.className = 'duty-on';
            startListening(); // Resume listening
            speak("You are now online.");
        } else {
            statusDiv.innerText = 'OFF DUTY';
            statusDiv.className = 'duty-off';
            stopListening(); // Stop listening
            document.getElementById('reqPopup').style.display = 'none'; // Hide if a request was active
            isRequesting = false;
            speak("You are now offline.");
        }
    }


    // --- Existing Core App Logic (Updated Maps and Income) ---

    // (Code for initializeMap, startGPSCheck, onPositionUpdate, onGPSError, recenterMap remains same)

    function startListening() {
        if (isOnDuty) {
            db.ref('requests').limitToLast(1).on('child_added', requestListener);
        }
    }

    function stopListening() {
        db.ref('requests').limitToLast(1).off('child_added', requestListener);
    }
    
    function requestListener(snap) {
        if (!isOnDuty || isRequesting) return; // Check if on duty
        
        const data = snap.val();
        if(!data) return;
        if(data.status === "pending") {
            if (!driverLat || !driverLng) return console.log("Waiting for location.");
            let dist = getDist(driverLat, driverLng, data.pickupLat, data.pickupLng).toFixed(1);
            if(dist <= 2.0) {
                isRequesting = true; 
                try { document.getElementById('ringtone').play().catch(()=>{}); } catch(e){}
                speak("A new request has arrived. The fare is " + data.price + " rupees. Pickup distance " + dist + " kilometers.");
                showRequest(data, snap.key, dist);
            }
        }
    }

    // ... (showRequest, tryAcceptRide, rideSecured functions remain mostly same)

    // FINAL FIX: Geo Scheme + Anchor Click
    function openPickupMap() {
        if (!currentReqData) return showCustomAlert('Error', 'No pickup location data.');
        const pLat = currentReqData.pickupLat;
        const pLng = currentReqData.pickupLng;
        
        const navUrl = `geo:${pLat},${pLng}?q=${pLat},${pLng}(Pickup Location)`;
        
        // Anchor Tag Trick: Attempt to bypass webview security like tel: links
        const a = document.createElement('a');
        a.href = navUrl;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a); 
        
        speak("Opening navigation to customer pickup location.");
    }
    
    // FINAL FIX: Geo Scheme + Anchor Click
    function openDropMap() {
        if (!currentReqData || !currentReqData.dropLat || !currentReqData.dropLng) return showCustomAlert('Error', 'Drop location is missing.');
        const dLat = currentReqData.dropLat;
        const dLng = currentReqData.dropLng;
        
        const navUrl = `geo:${dLat},${dLng}?q=${dLat},${dLng}(Drop Location)`;
        
        // Anchor Tag Trick
        const a = document.createElement('a');
        a.href = navUrl;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a); 
        
        speak("Opening navigation to drop location.");
    }

    function completeRide() {
        db.ref('requests/' + currentReqKey).update({ status: "completed" });
        
        // Update Income
        const fare = parseFloat(currentReqData.price);
        if (!isNaN(fare)) {
            todayIncome += fare;
            updateIncomeDisplay();
        }

        document.getElementById('dropCard').style.display = 'none';
        document.getElementById('billModal').style.display = 'flex';
        document.getElementById('billAmount').innerText = "‚Çπ" + currentReqData.price;
        speak("Trip complete. Cash collect and move to next ride.");
        
        // Cleanup and reset state
        if(routeLine) map.removeLayer(routeLine); 
        if(pickupMarker) map.removeLayer(pickupMarker);
        if(dropMarker) map.removeLayer(dropMarker);
        currentReqData = null; currentReqKey = null; 
        isRequesting = false;
        if (isOnDuty) startListening(); // Resume listening only if still on duty
    }

    function skipRide() { 
        try{ document.getElementById('ringtone').pause(); }catch(e){} 
        document.getElementById('reqPopup').style.display = 'none'; 
        if (pickupMarker) map.removeLayer(pickupMarker); 
        isRequesting = false; 
        speak("Request skipped."); 
        if (isOnDuty) startListening();
    }

    // ... (rest of the helper functions: cancelRide, openHelp, closeHelp, drawRoute, getDist remain same) ...

</script>
</body>
</html>
