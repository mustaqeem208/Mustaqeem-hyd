<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>MS PARTNER ‚Äî Driver (Pro)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{
      --bg:#04050a; --panel:#0c1116; --accent:#d4af37; --muted:#9aa3b2; --ok:#10b981; --danger:#ef4444;
      --radius:12px; --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#020205,var(--bg));font-family:Inter,Segoe UI,Roboto,Arial;color:#fff}
    /* TOP BAR: left big duty + income, right menu */
    #topBar{position:fixed;left:12px;right:12px;top:12px;height:74px;border-radius:14px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;z-index:3000;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(90deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005))}
    #leftTop{display:flex;align-items:center;gap:14px}
    .logo{font-weight:900;color:var(--accent);font-size:1.1rem}
    .duty-block{display:flex;flex-direction:column;gap:6px}
    .duty-btn{padding:12px 18px;border-radius:12px;border:none;font-weight:900;cursor:pointer;font-size:1rem}
    .duty-on{background:var(--ok);color:#021;box-shadow:0 8px 30px rgba(16,185,129,0.08)}
    .duty-off{background:#111;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .income-small{font-size:0.9rem;color:var(--muted);margin-top:2px}
    .income-big{font-weight:900;color:var(--accent);font-size:1.05rem}
    /* Right menu button */
    #rightTop{display:flex;align-items:center;gap:10px}
    .menu-btn{padding:10px 12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted)}
    /* Map container always visible */
    #mapContainer{position:fixed;left:12px;right:12px;top:98px;bottom:84px;border-radius:14px;overflow:hidden;z-index:1000;border:1px solid rgba(255,255,255,0.02)}
    #map{width:100%;height:100%}
    /* Floating buttons */
    .float-btn{position:fixed;right:24px;bottom:120px;background:#fff;color:#000;padding:12px;border-radius:14px;font-weight:800;border:none;box-shadow:0 12px 30px rgba(2,6,23,0.6);cursor:pointer;z-index:2000}
    .float-small{right:24px;bottom:64px;padding:10px;border-radius:12px}
    /* Bottom small status */
    #bottomBar{position:fixed;left:12px;right:12px;bottom:12px;height:64px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.3));display:flex;align-items:center;justify-content:space-between;padding:8px 12px;z-index:2500;border:1px solid rgba(255,255,255,0.02)}
    .status-pill{padding:8px 10px;border-radius:8px;background:var(--glass);font-weight:800}
    /* Request popup (center bottom) */
    #reqPopup{position:fixed;left:50%;transform:translateX(-50%);bottom:160px;width:92%;max-width:520px;background:linear-gradient(180deg,#07101a,#081026);padding:14px;border-radius:12px;display:none;z-index:2600;border:1px solid rgba(255,255,255,0.03)}
    .fare{font-size:2rem;color:var(--accent);font-weight:900}
    .info-row{display:flex;justify-content:space-between;color:var(--muted);margin-top:8px}
    .req-actions{display:flex;gap:10px;margin-top:12px}
    .btn-skip{flex:1;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);cursor:pointer}
    .btn-accept{flex:1;padding:10px;border-radius:10px;background:var(--accent);color:#000;border:none;font-weight:900;cursor:pointer}
    /* Cards for pickup/drop */
    .card-panel{position:fixed;left:12px;right:12px;bottom:120px;border-radius:12px;padding:14px;background:linear-gradient(180deg,#061018,#071018);display:none;z-index:2700;border:1px solid rgba(255,255,255,0.03)}
    .otp-input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;margin-top:8px}
    /* Drawer menu on right */
    #drawer{position:fixed;top:0;right:-360px;width:320px;height:100%;background:#07101a;z-index:4000;box-shadow:-8px 0 40px rgba(0,0,0,0.6);transition:right .22s;border-left:1px solid rgba(255,255,255,0.03);padding:16px}
    #drawer.show{right:0}
    .drawer-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .drawer-item{padding:12px;border-radius:8px;margin-bottom:8px;background:transparent;border:1px solid rgba(255,255,255,0.02);cursor:pointer}
    .small-muted{color:var(--muted);font-size:0.9rem}
    /* History modal */
    #historyModal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:5000}
    #historyCard{width:92%;max-width:700px;background:#07111a;padding:12px;border-radius:12px;max-height:80vh;overflow:auto;border:1px solid rgba(255,255,255,0.03)}
    .hist-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.02)}
    @media(min-width:900px){ #mapContainer{left:40px;right:40px;top:120px;bottom:96px} #topBar{left:40px;right:40px} #bottomBar{left:40px;right:40px} #drawer{width:360px} }
  </style>
</head>
<body>

  <!-- TOP BAR -->
  <div id="topBar">
    <div id="leftTop">
      <div class="logo">MS PARTNER PRO</div>
      <div class="duty-block">
        <button id="dutyToggle" class="duty-btn duty-off" onclick="toggleDuty()">START DUTY</button>
        <div class="income-small">Today income <span id="incomeBox" class="income-big">‚Çπ0</span></div>
      </div>
    </div>

    <div id="rightTop">
      <button class="menu-btn" onclick="openDrawer()">‚ò∞ MENU</button>
    </div>
  </div>

  <!-- MAP -->
  <div id="mapContainer">
    <div id="map"></div>
  </div>

  <!-- floating buttons -->
  <button class="float-btn" onclick="recenterMap()">üìç Center</button>
  <button class="float-btn float-small" style="right:24px;bottom:64px" onclick="openHistory()">üìú History</button>

  <!-- bottom status -->
  <div id="bottomBar">
    <div class="status-pill">Status: <span id="dutyStatusLabel" style="font-weight:900;margin-left:8px">OFF</span></div>
    <div class="status-pill">Selected: <span id="selectedVehicleLabel" style="font-weight:900;margin-left:8px">‚Äî</span></div>
  </div>

  <!-- Request popup -->
  <div id="reqPopup">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900">New Ride Request</div>
      <div id="reqTime" class="muted">‚Äî</div>
    </div>
    <div style="margin-top:8px" class="fare">‚Çπ<span id="fareDisplay">0</span></div>
    <div class="info-row"><div>Pickup <b id="pickupDist">‚Äî</b></div><div>Trip <b id="tripDist">‚Äî</b></div></div>
    <div class="req-actions">
      <button class="btn-skip" onclick="skipRide()">Skip</button>
      <button class="btn-accept" onclick="tryAcceptRide()">Accept</button>
    </div>
  </div>

  <!-- Pickup Card -->
  <div id="pickupCard" class="card-panel">
    <div style="font-weight:900;color:var(--accent)">Heading to Pickup</div>
    <div id="custPhoneDisplay" style="margin-top:8px" class="muted">Customer: ‚Äî</div>
    <div style="margin-top:12px">
      <a id="callBtn" class="drawer-item" href="#">üìû Call Customer</a>
      <div style="margin-top:8px" class="small-muted">Enter OTP to start trip</div>
      <input id="otpIn" class="otp-input" placeholder="Enter OTP"/>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="menu-btn" onclick="cancelRide()">Cancel</button>
        <button class="duty-btn duty-on" onclick="verifyOtp()" style="background:var(--accent);color:#000">Start Trip</button>
      </div>
    </div>
  </div>

  <!-- Drop Card -->
  <div id="dropCard" class="card-panel" style="border-top:3px solid var(--ok)">
    <div style="font-weight:900;color:var(--ok)">On Trip</div>
    <div style="margin-top:8px" class="muted">Navigate to drop and complete trip</div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <button class="btn-skip" onclick="openDropMap()">Navigate</button>
      <button class="btn-accept" onclick="completeRide()">End Trip & Bill</button>
    </div>
  </div>

  <!-- Drawer (right) -->
  <div id="drawer">
    <div class="drawer-head">
      <div style="font-weight:900">Menu</div>
      <button class="menu-btn" onclick="closeDrawer()">‚úï</button>
    </div>

    <div style="margin-bottom:8px">
      <div class="small-muted">Logged as</div>
      <div style="font-weight:900;margin-top:6px" id="drawerMobile">+91 ‚Äî</div>
      <div class="muted" id="drawerVehicle">Vehicle: ‚Äî</div>
    </div>

    <div class="drawer-item" onclick="openVehicleDialog()">Change Vehicle / Reg No</div>
    <div class="drawer-item" onclick="openHistory()">Ride History</div>
    <div class="drawer-item" onclick="logout()">Logout</div>
    <div class="drawer-item" onclick="openHelp()">Help & Emergency</div>

    <div style="margin-top:20px" class="small-muted">Tips: keep GPS ON & allow location in browser</div>
  </div>

  <!-- Help modal (simple) -->
  <div id="helpModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:6000;align-items:center;justify-content:center">
    <div style="width:90%;max-width:360px;background:#08121a;padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-weight:900">Help & Emergency</div><button class="menu-btn" onclick="closeHelp()">‚úï</button></div>
      <div style="margin:8px 0;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)">üìû Police: <a href="tel:100" style="color:var(--accent);text-decoration:none">100</a></div>
      <div style="margin:8px 0;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)">üë§ Mustaqeem: <a href="tel:9381667208" style="color:var(--accent);text-decoration:none">9381667208</a></div>
      <div style="margin-top:12px;text-align:right"><button class="menu-btn" onclick="closeHelp()">CLOSE</button></div>
    </div>
  </div>

  <!-- History modal -->
  <div id="historyModal">
    <div id="historyCard">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">Ride History</h3>
        <div><button class="menu-btn" onclick="closeHistory()">Close</button></div>
      </div>
      <div id="historyList"></div>
    </div>
  </div>
  <!-- PART 2: Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
  // ---------- Firebase ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCJpo25tYCN_fXP8aCckgA4WrD962KCsQ8",
    authDomain: "hyd-texi.firebaseapp.com",
    projectId: "hyd-texi",
    storageBucket: "hyd-texi.firebasestorage.app",
    messagingSenderId: "807048727786",
    appId: "1:807048727786:web:7ef03573876c70b76e1b93",
    databaseURL: "https://hyd-texi-default-rtdb.firebaseio.com"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ---------- state ----------
  let map, driverMarker, driverLat=null, driverLng=null;
  let driverMobile = null;
  let gpsWatchId = null;
  let selectedVehicle = null; // 'car'|'auto'|'bike'
  let vehicleNumber = null;
  let isOnDuty = false;
  let isRequesting = false;
  let currentReqKey = null, currentReqData = null;
  let pickupMarker=null, dropMarker=null, routeLine=null;

  // ---------- helpers ----------
  const $ = id => document.getElementById(id);
  function savePrefs(){ if(!driverMobile) return; localStorage.setItem('msPartnerProV2', JSON.stringify({ driverMobile, selectedVehicle, vehicleNumber, isOnDuty })); updateUI(); }
  function loadPrefs(){
    try{ const raw = localStorage.getItem('msPartnerProV2'); if(!raw) return false; const p=JSON.parse(raw); driverMobile=p.driverMobile||null; selectedVehicle=p.selectedVehicle||null; vehicleNumber=p.vehicleNumber||null; isOnDuty=!!p.isOnDuty; return !!driverMobile; } catch(e){ return false; }
  }
  function clearPrefs(){ localStorage.removeItem('msPartnerProV2'); }

  function updateUI(){
    $('driverMobile').innerText = driverMobile ? ('+91 ' + driverMobile) : '+91 ‚Äî';
    $('drawerMobile').innerText = driverMobile ? ('+91 ' + driverMobile) : '+91 ‚Äî';
    $('drawerVehicle').innerText = vehicleNumber ? ('Vehicle: ' + vehicleNumber) : (selectedVehicle ? ('Vehicle: ' + selectedVehicle.toUpperCase()) : 'Vehicle: ‚Äî');
    $('selectedVehicleLabel').innerText = selectedVehicle ? selectedVehicle.toUpperCase() : '‚Äî';
    $('dutyStatusLabel').innerText = isOnDuty ? 'ON' : 'OFF';
    $('dutyToggle').className = isOnDuty ? 'duty-btn duty-on' : 'duty-btn duty-off';
    $('dutyToggle').innerText = isOnDuty ? 'GO OFF DUTY' : 'START DUTY';
  }

  // ---------- Map & GPS ----------
  function initMap(){
    if(map) return;
    map = L.map('map', { zoomControl:true }).setView([17.3850,78.4867], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const you = L.divIcon({ html: "<div style='background:var(--accent);padding:6px 8px;border-radius:8px;color:#000;font-weight:900'>YOU</div>", className:'', iconSize:[60,30], iconAnchor:[30,15] });
    driverMarker = L.marker([17.3850,78.4867], { icon: you, draggable:true }).addTo(map);
    driverMarker.on('dragend', e => {
      const p = e.target.getLatLng(); driverLat = p.lat; driverLng = p.lng;
      if (driverMobile) db.ref('partners/' + driverMobile).update({ lat: driverLat, lng: driverLng, lastSeen: Date.now() }).catch(()=>{});
    });
  }

  function startGPS(){
    if (!navigator.geolocation) { alert('GPS not supported'); return; }
    navigator.geolocation.getCurrentPosition(pos => {
      driverLat = pos.coords.latitude; driverLng = pos.coords.longitude;
      if (driverMarker) driverMarker.setLatLng([driverLat, driverLng]);
      if (map) map.setView([driverLat, driverLng], 15);
      if (driverMobile) db.ref('partners/' + driverMobile).update({ lat: driverLat, lng: driverLng, lastSeen: Date.now(), onDuty: isOnDuty }).catch(()=>{});
      if (!gpsWatchId) gpsWatchId = navigator.geolocation.watchPosition(pos => {
        driverLat = pos.coords.latitude; driverLng = pos.coords.longitude;
        if (driverMarker) driverMarker.setLatLng([driverLat, driverLng]);
        if (isOnDuty && driverMobile) db.ref('partners/' + driverMobile).update({ lat: driverLat, lng: driverLng, lastSeen: Date.now() }).catch(()=>{});
      }, err => { console.warn('gpswatch err', err); }, { enableHighAccuracy:true, maximumAge:2000, timeout:8000 });
    }, err => { console.warn('gps init err', err); }, { enableHighAccuracy:true, timeout:8000 });
  }

  function recenterMap(){ if(driverLat && driverLng && map) map.setView([driverLat, driverLng], 15); }

  // ---------- Drawer ----------
  function openDrawer(){ $('drawer').classList.add('show'); }
  function closeDrawer(){ $('drawer').classList.remove('show'); }

  // ---------- Login / Vehicle / Duty ----------
  function openVehicleDialog(){
    const v = prompt('Vehicle (car/auto/bike):', selectedVehicle || 'car');
    if (!v) return;
    const vv = v.toLowerCase().trim();
    if (!['car','auto','bike'].includes(vv)) return alert('Invalid vehicle');
    selectedVehicle = vv;
    const reg = prompt('Vehicle reg. no (optional):', vehicleNumber || '');
    if (reg !== null) vehicleNumber = reg.trim();
    saveAndUpdateProfile();
  }

  function saveAndUpdateProfile(){
    if (!driverMobile) return alert('Login first');
    savePrefs();
    updateUI();
    db.ref('partners/' + driverMobile).update({ mobile: driverMobile, vehicle: selectedVehicle, vehicleNumber: vehicleNumber, onDuty: isOnDuty, lastSeen: Date.now(), lat: driverLat || null, lng: driverLng || null }).catch(()=>{});
    alert('Profile saved');
  }

  function startOrStopDuty(){
    if (!driverMobile) {
      const num = prompt('Enter your mobile number (10 digits):');
      if (!num || num.trim().length < 10) return alert('Valid number required');
      driverMobile = num.trim();
      // ask vehicle if not set
      if (!selectedVehicle) {
        const v = prompt('Vehicle (car/auto/bike):','car');
        if (!v) return alert('Vehicle required');
        selectedVehicle = v.toLowerCase().trim();
      }
      const reg = prompt('Vehicle reg. no (optional):', vehicleNumber || '');
      if (reg !== null) vehicleNumber = reg.trim();
    }
    isOnDuty = !isOnDuty;
    savePrefs();
    updateUI();
    db.ref('partners/' + driverMobile).update({ onDuty: isOnDuty, vehicle: selectedVehicle, vehicleNumber: vehicleNumber, lastSeen: Date.now(), lat: driverLat || null, lng: driverLng || null }).catch(()=>{});
    if (isOnDuty) {
      initMap(); startGPS(); startListening(); alert('You are ON DUTY');
    } else {
      stopListening(); alert('You are OFF DUTY');
    }
    updateUI();
  }

  function toggleDuty(){ startOrStopDuty(); }

  function logout(){
    if (!confirm('Logout and stop receiving requests?')) return;
    if (driverMobile) db.ref('partners/' + driverMobile).update({ onDuty: false, lastSeen: Date.now() }).catch(()=>{});
    clearPrefs();
    location.reload();
  }

  // ---------- Help ----------
  function openHelp(){ $('helpModal').style.display='flex'; }
  function closeHelp(){ $('helpModal').style.display='none'; }

  // ---------- Requests: listen & filter ----------
  async function requestListener(snap){
    if (!isOnDuty) return;
    if (isRequesting) return;
    const data = snap.val();
    if (!data || data.status !== 'pending') return;
    const reqType = (data.vehicleType || '').toLowerCase();
    if (!selectedVehicle || reqType !== selectedVehicle) return;
    if (!driverLat || !driverLng) return;
    const pd = getDist(driverLat, driverLng, data.pickupLat, data.pickupLng);
    if (pd <= 6.0) {
      isRequesting = true;
      currentReqData = data; currentReqKey = snap.key;
      $('reqPopup').style.display='block';
      $('fareDisplay').innerText = data.price;
      $('pickupDist').innerText = pd.toFixed(1) + ' km';
      $('tripDist').innerText = (data.distance || '‚Äî');
      $('reqTime').innerText = new Date(data.timestamp || Date.now()).toLocaleTimeString();
      if (pickupMarker) map.removeLayer(pickupMarker);
      pickupMarker = L.marker([data.pickupLat, data.pickupLng]).addTo(map).bindPopup('Pickup');
      map.setView([data.pickupLat, data.pickupLng], 15);
      try{ document.getElementById('ringtone') && document.getElementById('ringtone').play().catch(()=>{}); }catch(e){}
    }
  }

  function startListening(){ db.ref('requests').limitToLast(40).on('child_added', requestListener); }
  function stopListening(){ db.ref('requests').limitToLast(40).off('child_added', requestListener); }

  function skipRide(){ $('reqPopup').style.display='none'; if (pickupMarker){ map.removeLayer(pickupMarker); pickupMarker=null;} isRequesting=false; try{ document.getElementById('ringtone') && document.getElementById('ringtone').pause(); }catch(e){} }

  // Accept with transaction (race-safe)
  function tryAcceptRide(){
    if (!currentReqKey) return alert('No request');
    stopListening();
    db.ref('requests/' + currentReqKey).transaction(curr=>{
      if (curr === null) return curr;
      if (curr.status === 'pending') return Object.assign({}, curr, { status:'accepted', driverMobile: driverMobile, driverVehicle: selectedVehicle, driverVehicleNumber: vehicleNumber, acceptedAt: Date.now() });
      return;
    }, (err, committed, snap) => {
      if (err) { alert('Accept failed'); isRequesting=false; startListening(); }
      else if (!committed) { alert('Request already taken'); isRequesting=false; startListening(); }
      else {
        currentReqData = snap.val();
        $('reqPopup').style.display='none';
        $('pickupCard').style.display='block';
        $('custPhoneDisplay').innerText = 'Customer: ' + (currentReqData.customerMobile || '‚Äî');
        $('callBtn').href = 'tel:' + (currentReqData.customerMobile || '');
        drawRoute(driverLat, driverLng, currentReqData.pickupLat, currentReqData.pickupLng, '#d4af37');
        const hist = { reqId: currentReqKey, customerMobile: currentReqData.customerMobile, price: currentReqData.price, status:'accepted', vehicle: currentReqData.vehicleType, timestamp: Date.now() };
        db.ref('partners/' + driverMobile + '/history').push(hist).catch(()=>{});
        refreshTodayIncome();
      }
    });
  }

  function verifyOtp(){
    const code = $('otpIn').value.trim();
    if (!currentReqData) return alert('No request loaded');
    if (String(currentReqData.otp) === code) {
      db.ref('requests/' + currentReqKey).update({ status:'started', startedAt: Date.now() }).catch(()=>{});
      $('pickupCard').style.display='none';
      $('dropCard').style.display='block';
      if (currentReqData.dropLat && currentReqData.dropLng) drawRoute(currentReqData.pickupLat, currentReqData.pickupLng, currentReqData.dropLat, currentReqData.dropLng, '#10b981');
      updatePartnerHistoryStatus(currentReqKey, 'started');
    } else alert('Wrong OTP');
  }

  function completeRide(){
    if (!currentReqKey || !currentReqData) return alert('No active ride');
    db.ref('requests/' + currentReqKey).update({ status:'completed', completedAt: Date.now() }).then(()=>{
      $('dropCard').style.display='none';
      alert('Trip completed. Collect cash ‚Çπ' + (currentReqData.price || 0));
      updatePartnerHistoryStatus(currentReqKey, 'completed');
      refreshTodayIncome();
      if (routeLine) { map.removeLayer(routeLine); routeLine=null; }
      if (pickupMarker) { map.removeLayer(pickupMarker); pickupMarker=null; }
      if (dropMarker) { map.removeLayer(dropMarker); dropMarker=null; }
      currentReqKey = null; currentReqData = null; isRequesting=false;
      startListening();
    }).catch(e=>alert('Complete failed'));
  }

  function cancelRide(){
    if (!confirm('Cancel this ride?')) return;
    db.ref('requests/' + currentReqKey).update({ status:'cancelled' }).then(()=>{
      isRequesting=false; location.reload();
    }).catch(()=>alert('Cancel failed'));
  }

  // ---------- route draw ----------
  function drawRoute(lat1, lon1, lat2, lon2, color){
    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline([[lat1,lon1],[lat2,lon2]], { color, weight:5 }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding:[40,40] });
  }

  // ---------- history & income ----------
  async function fetchHistory(){
    if (!driverMobile) return;
    const snap = await db.ref('partners/' + driverMobile + '/history').orderByChild('timestamp').once('value');
    const data = snap.val() || {};
    renderHistory(data);
  }
  function renderHistory(data){
    const container = $('historyList'); container.innerHTML='';
    const keys = Object.keys(data||{}).sort((a,b)=> (data[b].timestamp||0)-(data[a].timestamp||0));
    if (!keys.length) { container.innerHTML = '<div style="padding:12px;color:var(--muted)">No rides yet</div>'; return; }
    keys.forEach(k=>{
      const it = data[k];
      const t = new Date(it.timestamp||Date.now()).toLocaleString();
      const div = document.createElement('div'); div.className='hist-item';
      div.innerHTML = `<div><div style="font-weight:900">‚Çπ${it.price||0} ‚Ä¢ ${it.vehicle||''}</div><div class="muted">${t}</div></div><div style="text-align:right"><div class="muted">${(it.status||'').toUpperCase()}</div></div>`;
      container.appendChild(div);
    });
  }

  async function refreshTodayIncome(){
    if (!driverMobile) return;
    const start = new Date(); start.setHours(0,0,0,0);
    const end = new Date(); end.setHours(23,59,59,999);
    const snap = await db.ref('partners/' + driverMobile + '/history').orderByChild('timestamp').startAt(start.getTime()).endAt(end.getTime()).once('value');
    const data = snap.val() || {};
    let total = 0;
    Object.values(data).forEach(it => { if (it.status === 'completed') total += Number(it.price || 0); });
    $('incomeBox').innerText = '‚Çπ' + total;
  }

  async function updatePartnerHistoryStatus(reqId, newStatus){
    if (!driverMobile) return;
    const ref = db.ref('partners/' + driverMobile + '/history');
    const snap = await ref.orderByChild('reqId').equalTo(reqId).once('value'); const matches = snap.val();
    if (!matches) return;
    Object.keys(matches).forEach(k => ref.child(k).update({ status: newStatus }));
    fetchHistory(); refreshTodayIncome();
  }

  // ---------- misc UI ----------
  function openHistory(){ fetchHistory(); $('historyModal').style.display='flex'; }
  function closeHistory(){ $('historyModal').style.display='none'; }
  function openHelp(){ $('helpModal').style.display='flex'; }
  function closeHelp(){ $('helpModal').style.display='none'; }

  function getDist(lat1,lon1,lat2,lon2){
    const R=6371; const dLat=(lat2-lat1)*(Math.PI/180); const dLon=(lon2-lon1)*(Math.PI/180);
    const a = Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180))*Math.sin(dLon/2)*Math.sin(dLon/2);
    return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
  }

  // ---------- init ----------
  (function init(){
    initMap();
    // ring audio
    const a = document.createElement('audio'); a.id='ringtone'; a.src='https://media.geeksforgeeks.org/wp-content/uploads/20190531135120/beep.mp3'; a.loop=true; document.body.appendChild(a);
    const ok = loadPrefs();
    if (ok && driverMobile) {
      updateUI();
      // show app (no overlay files ‚Äî app UI already visible)
      startGPS();
      if (isOnDuty) startListening();
      refreshTodayIncome();
    } else {
      // nothing: user presses START DUTY to login & start
    }
    // attach duty button guard: newer browsers might not let programmatically play audio
    $('dutyToggle').addEventListener('click', function(){ if (!driverMobile) { /* prompts handled in toggleDuty */ } });
  })();

  // expose some methods for inline onclicks
  window.openDrawer = openDrawer;
  window.closeDrawer = closeDrawer;
  window.openVehicleDialog = openVehicleDialog;
  window.recenterMap = recenterMap;
  window.openHistory = openHistory;
  window.closeHistory = closeHistory;
  window.toggleDuty = toggleDuty;
  window.logout = logout;
  window.tryAcceptRide = tryAcceptRide;
  window.skipRide = skipRide;
  window.verifyOtp = verifyOtp;
  window.completeRide = completeRide;
  window.cancelRide = cancelRide;

</script>
</body>
</html>
