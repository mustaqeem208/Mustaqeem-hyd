<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MS CABS â€” Partner</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#d4af37;
      --muted:#9aa3b2;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071022,#0b1220);color:var(--accent);font-family:Inter,system-ui,Roboto,Arial;}
    .center{max-width:460px;margin:36px auto;padding:18px;background:var(--card);border-radius:14px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 12px;font-size:1.5rem}
    .inp, select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--accent);margin-bottom:10px;font-size:1rem}
    .btn{width:100%;padding:12px;border-radius:10px;border:none;background:linear-gradient(90deg,#111,#222);color:var(--accent);font-weight:800;cursor:pointer}
    .small{font-size:0.9rem;color:var(--muted)}
    .row{display:flex;gap:8px}
    .half{flex:1}
    .chip{display:inline-block;padding:8px 10px;border-radius:10px;background:var(--glass);color:var(--muted);margin-right:6px;cursor:pointer}
    #onlineToggle{display:flex;align-items:center;gap:10px;margin-top:10px}
    .pill{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);font-weight:700}
    #incomingReq{margin-top:12px;padding:12px;border-radius:10px;background:rgba(0,0,0,0.25);display:none}
    .muted{color:var(--muted)}
    .success{color:#7af27a}
    .danger{color:#ff7b7b}
    .smallBtn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent);cursor:pointer}
  </style>
</head>
<body>
  <div class="center" id="loginCard">
    <h1>MS CABS â€” Partner</h1>

    <!-- Login -->
    <div id="loginBox">
      <input id="mobileInput" class="inp" type="tel" placeholder="Enter mobile number (10 digits)" />
      <button class="btn" onclick="partnerLogin()">Continue (Login)</button>
      <p class="small muted">One-time mobile login. If first time, you'll be asked to complete partner details.</p>
    </div>

    <!-- Registration / Profile -->
    <div id="profileBox" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small muted">Logged in as</div>
          <div id="pMobile" style="font-weight:800;font-size:1.1rem"></div>
        </div>
        <div>
          <button class="smallBtn" onclick="logoutPartner()">Logout</button>
        </div>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:12px 0;border-radius:2px">

      <div id="regForm">
        <input id="pName" class="inp" type="text" placeholder="Full name (as on licence)" />
        <input id="pLicence" class="inp" type="text" placeholder="Driving licence number" />
        <select id="pVehicle" class="inp">
          <option value="">Select vehicle type</option>
          <option value="car">Car</option>
          <option value="auto">Auto</option>
          <option value="bike">Bike</option>
        </select>
        <input id="pVehicleNo" class="inp" type="text" placeholder="Vehicle reg. no. (optional)" />
        <button class="btn" onclick="saveProfile()">Save & Activate</button>
        <p class="small muted">As soon as licence + vehicle selected, you will get a confirmation and your partner id will activate.</p>
      </div>

      <!-- Congratulation banner -->
      <div id="congrats" style="display:none;margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg,#072,#0b6);color:#031; font-weight:800">
        ðŸŽ‰ Congratulations â€” Partner activated! Your Partner ID: <span id="partnerIdDisplay"></span>
      </div>

      <!-- Online/Offline + Incoming Request -->
      <div id="onlineArea" style="margin-top:12px;display:none">
        <div id="onlineToggle">
          <div>
            <label class="pill">Status:</label>
            <span id="statusText" class="pill muted">OFFLINE</span>
          </div>
          <div style="margin-left:auto">
            <button class="smallBtn" id="goOnlineBtn" onclick="setOnline(true)">Go ONLINE</button>
            <button class="smallBtn" id="goOfflineBtn" onclick="setOnline(false)" style="display:none">Go OFFLINE</button>
          </div>
        </div>

        <div id="incomingReq">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:900" id="reqFare">â‚¹0</div>
              <div class="muted" id="reqVehicle">â€”</div>
              <div class="muted" id="reqDistance">â€”</div>
            </div>
            <div style="text-align:right">
              <div class="muted">From</div>
              <div id="reqPickup" style="font-weight:800">â€”</div>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn" onclick="acceptRequest()" id="acceptBtn">Accept</button>
            <button class="smallBtn" onclick="rejectRequest()">Reject</button>
          </div>
          <div style="margin-top:8px" class="muted">OTP: <span id="reqOTP">0000</span></div>
          <div style="margin-top:6px" class="small muted">Customer: <span id="reqCustomerMobile">â€”</span></div>
        </div>

        <div id="assignedInfo" style="margin-top:12px;display:none">
          <div style="font-weight:800">Assigned Request: <span id="assignedReqId"></span></div>
          <div class="muted">Trip status: <span id="assignedStatus">â€”</span></div>
          <div style="margin-top:8px"><button class="smallBtn" onclick="completeTrip()">Mark Completed</button></div>
        </div>
      </div>

      <div style="margin-top:14px">
        <button class="smallBtn" onclick="openPartnerHistory()">My accepted rides (debug)</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // ---------- CONFIG (same as customer panel) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCJpo25tYCN_fXP8aCckgA4WrD962KCsQ8",
      authDomain: "hyd-texi.firebaseapp.com",
      projectId: "hyd-texi",
      storageBucket: "hyd-texi.firebasestorage.app",
      messagingSenderId: "807048727786",
      appId: "1:807048727786:web:7ef03573876e1b93",
      databaseURL: "https://hyd-texi-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ---------- GLOBALS ----------
    let partnerMobile = null;
    let partnerObj = null; // saved profile
    let listening = false;
    let currentIncoming = null; // request id currently showing to driver
    let assignedRequest = null; // request id assigned to this driver

    // Auto-login if saved
    if (localStorage.getItem('msPartnerMobile')) {
      partnerMobile = localStorage.getItem('msPartnerMobile');
      showProfilePanel();
      loadPartnerProfile().then(()=>{});
    }

    // ---------- AUTH / PROFILE ----------
    function partnerLogin(){
      const num = document.getElementById('mobileInput').value.trim();
      if (!num || num.length < 10) return alert('Enter valid 10-digit mobile.');
      partnerMobile = num;
      localStorage.setItem('msPartnerMobile', partnerMobile);
      showProfilePanel();
      loadPartnerProfile();
    }

    function logoutPartner(){
      if (confirm('Logout?')) {
        stopListeningRequests();
        localStorage.removeItem('msPartnerMobile');
        location.reload();
      }
    }

    function showProfilePanel(){
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('profileBox').style.display = 'block';
      document.getElementById('pMobile').innerText = '+91 ' + (partnerMobile || '');
    }

    async function loadPartnerProfile(){
      if (!partnerMobile) return;
      const snap = await db.ref('partners/' + partnerMobile).once('value');
      const data = snap.val();
      if (!data) {
        // new partner -> keep reg form visible
        document.getElementById('regForm').style.display = 'block';
        document.getElementById('onlineArea').style.display = 'none';
        return;
      }
      partnerObj = data;
      // fill form hidden, show info
      document.getElementById('regForm').style.display = 'none';
      document.getElementById('congrats').style.display = 'block';
      document.getElementById('partnerIdDisplay').innerText = data.partnerId || partnerMobile;
      document.getElementById('onlineArea').style.display = 'block';
      // show online status
      updateStatusUI(data.isOnline);
      // if already accepted request â€” show assigned
      if (data.assignedReqId) {
        assignedRequest = data.assignedReqId;
        showAssignedInfo();
      }
    }

    function generatePartnerId(){
      // simple partner id
      return 'P' + (Math.floor(100000 + Math.random()*900000));
    }

    async function saveProfile(){
      const name = document.getElementById('pName').value.trim();
      const licence = document.getElementById('pLicence').value.trim();
      const vehicle = document.getElementById('pVehicle').value;
      const vehicleNo = document.getElementById('pVehicleNo').value.trim();

      if (!name || !licence || !vehicle) return alert('Please fill name, licence and select vehicle.');

      const partnerId = generatePartnerId();
      const payload = {
        partnerId,
        mobile: partnerMobile,
        name,
        licence,
        vehicleType: vehicle,
        vehicleNo: vehicleNo || '',
        isOnline: false,
        createdAt: Date.now()
      };

      await db.ref('partners/' + partnerMobile).set(payload);
      partnerObj = payload;

      // show congrats and activate
      document.getElementById('regForm').style.display = 'none';
      document.getElementById('congrats').style.display = 'block';
      document.getElementById('partnerIdDisplay').innerText = partnerId;
      document.getElementById('onlineArea').style.display = 'block';

      // small UX: auto-open online
      setTimeout(()=>{ setOnline(true); }, 800);
    }

    // ---------- ONLINE / OFFLINE ----------
    function updateStatusUI(isOnline){
      const txt = document.getElementById('statusText');
      if (isOnline) {
        txt.innerText = 'ONLINE';
        txt.classList.remove('muted');
        txt.classList.add('success');
        document.getElementById('goOnlineBtn').style.display = 'none';
        document.getElementById('goOfflineBtn').style.display = 'inline-block';
      } else {
        txt.innerText = 'OFFLINE';
        txt.classList.remove('success');
        txt.classList.add('muted');
        document.getElementById('goOnlineBtn').style.display = 'inline-block';
        document.getElementById('goOfflineBtn').style.display = 'none';
      }
    }

    async function setOnline(yes){
      if (!partnerObj) {
        // try load partnerObj
        const snap = await db.ref('partners/' + partnerMobile).once('value');
        partnerObj = snap.val();
        if (!partnerObj) return alert('Please complete profile first.');
      }
      partnerObj.isOnline = !!yes;
      await db.ref('partners/' + partnerMobile + '/isOnline').set(!!yes);
      updateStatusUI(!!yes);
      if (yes) startListeningRequests();
      else stopListeningRequests();
    }

    // ---------- REQUEST LISTENING (only when online) ----------
    let reqListenerRef = null;
    function startListeningRequests(){
      if (listening) return;
      listening = true;
      // Listen for new requests (child_added) and changes
      reqListenerRef = db.ref('requests');
      reqListenerRef.on('child_added', handleRequestSnapshot);
      reqListenerRef.on('child_changed', handleRequestSnapshot);
      console.log('Started listening to requests.');
    }

    function stopListeningRequests(){
      if (!listening) return;
      listening = false;
      if (reqListenerRef) {
        reqListenerRef.off('child_added', handleRequestSnapshot);
        reqListenerRef.off('child_changed', handleRequestSnapshot);
        reqListenerRef = null;
      }
      // hide incoming
      hideIncoming();
      console.log('Stopped listening.');
    }

    function handleRequestSnapshot(snap){
      const data = snap.val();
      const id = snap.key;
      if (!data) return;
      // Ignore if already assigned or not pending
      if (data.status !== 'pending') return;
      if (!partnerObj || !partnerObj.vehicleType) return;
      // Match vehicle types: customer panel stored label (Car/Auto/Bike) â€” we used cfg.label earlier.
      // Normalize both to lowercase for matching.
      const reqVehicle = (data.vehicleType || '').toString().toLowerCase();
      const myVehicle = (partnerObj.vehicleType || '').toString().toLowerCase();

      if (reqVehicle !== myVehicle) return; // not for this partner

      // If partner already has an assigned request, don't show new incoming
      if (assignedRequest) return;

      // Show incoming request to partner
      currentIncoming = { id, data };
      showIncoming(data, id);
    }

    // UI helpers
    function showIncoming(data, id){
      document.getElementById('incomingReq').style.display = 'block';
      document.getElementById('reqFare').innerText = 'â‚¹' + (data.price || '0');
      document.getElementById('reqVehicle').innerText = data.vehicleType || '';
      document.getElementById('reqDistance').innerText = data.distance || '';
      document.getElementById('reqPickup').innerText = (data.pickupLat && data.pickupLng) ? (Number(data.pickupLat).toFixed(3)+', '+Number(data.pickupLng).toFixed(3)) : 'â€”';
      document.getElementById('reqOTP').innerText = data.otp || '0000';
      document.getElementById('reqCustomerMobile').innerText = data.customerMobile || 'â€”';
    }

    function hideIncoming(){
      currentIncoming = null;
      document.getElementById('incomingReq').style.display = 'none';
    }

    // ---------- ACCEPT / REJECT ----------
    async function acceptRequest(){
      if (!currentIncoming || !currentIncoming.id) return;
      const id = currentIncoming.id;
      // Double-check request is still pending
      const snap = await db.ref('requests/' + id).once('value');
      const req = snap.val();
      if (!req || req.status !== 'pending') {
        alert('Request no longer available.');
        hideIncoming();
        return;
      }

      // Write assignment atomically (simple approach)
      await db.ref('requests/' + id).update({
        status: 'accepted',
        driverMobile: partnerMobile,
        driverId: partnerObj.partnerId || partnerMobile,
        acceptedAt: Date.now()
      });

      // Update partner record: assignedReqId
      await db.ref('partners/' + partnerMobile + '/assignedReqId').set(id);
      assignedRequest = id;
      showAssignedInfo();

      hideIncoming();
      alert('Accepted â€” request assigned. OTP: ' + (req.otp || '0000'));
    }

    async function rejectRequest(){
      // just hide and allow other requests
      hideIncoming();
    }

    function showAssignedInfo(){
      document.getElementById('assignedInfo').style.display = 'block';
      document.getElementById('assignedReqId').innerText = assignedRequest || 'â€”';
      document.getElementById('assignedStatus').innerText = 'ACCEPTED';
      // start listening to status changes for this specific request
      db.ref('requests/' + assignedRequest).on('value', snap => {
        const d = snap.val();
        if (!d) return;
        document.getElementById('assignedStatus').innerText = (d.status || 'â€”').toUpperCase();
        if (d.status === 'completed') {
          alert('Trip completed and closed.');
          clearAssignment();
        } else if (d.status === 'cancelled') {
          alert('Trip cancelled by customer.');
          clearAssignment();
        }
      });
    }

    async function clearAssignment(){
      if (!assignedRequest) return;
      try {
        await db.ref('partners/' + partnerMobile + '/assignedReqId').remove();
      } catch(e){}
      // turn offline optionally
      assignedRequest = null;
      document.getElementById('assignedInfo').style.display = 'none';
      document.getElementById('assignedReqId').innerText = '';
      document.getElementById('assignedStatus').innerText = '';
    }

    // Driver can mark completed â€” updates request status to completed
    async function completeTrip(){
      if (!assignedRequest) return alert('No assigned trip.');
      // update request status
      await db.ref('requests/' + assignedRequest).update({
        status: 'completed',
        completedAt: Date.now()
      });
      // update partner history node
      await db.ref('partners/' + partnerMobile + '/history').push({
        reqId: assignedRequest,
        completedAt: Date.now()
      });
      clearAssignment();
      alert('Trip marked completed.');
    }

    // Debug: show recent accepted rides for this partner
    async function openPartnerHistory(){
      const snap = await db.ref('requests').orderByChild('driverMobile').equalTo(partnerMobile).limitToLast(50).once('value');
      console.log('Your assigned requests:', snap.val());
      alert('Check console for your assigned requests (debug).');
    }

    // ---------- small helpers ----------
    function stopListeningRequests(){
      if (reqListenerRef) {
        reqListenerRef.off('child_added', handleRequestSnapshot);
        reqListenerRef.off('child_changed', handleRequestSnapshot);
        reqListenerRef = null;
      }
      listening = false;
      hideIncoming();
    }

    // Clean up on unload
    window.addEventListener('beforeunload', ()=> {
      if (partnerMobile) db.ref('partners/' + partnerMobile + '/isOnline').set(false);
      stopListeningRequests();
    });

    // End
  </script>
</body>
</html>
