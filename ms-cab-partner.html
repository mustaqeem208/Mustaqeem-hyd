<!-- PART 1: Paste/replace your existing top HTML/CSS block with this -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MS Partner - Premium</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* ---------- Professional dark theme ---------- */
        :root{
          --bg: #05060a;
          --card: #071024;
          --muted: #95a0ad;
          --accent: #d4af37;
          --success: #2ecc71;
          --danger: #ff6b6b;
          --glass: rgba(255,255,255,0.03);
          --radius: 12px;
        }
        html,body{height:100%;margin:0;background:linear-gradient(180deg,#02030a,#071026);color:var(--accent);font-family:Inter,system-ui,Roboto,Arial;}
        a{color:inherit}

        /* login screen */
        #dLoginScreen { position:fixed; inset:0; background:linear-gradient(180deg,#041024,#071026); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:12px; padding:20px; }
        .logo { font-size: 2rem; color: var(--accent); font-weight: 800; letter-spacing: 2px; }
        .d-inp { width:86%; padding:14px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--accent); text-align:center; margin-bottom:6px; font-size:1.05rem; }
        .d-btn { width:86%; padding:13px; border-radius:10px; border:none; background:var(--accent); color:#041022; font-weight:800; cursor:pointer; font-size:1.05rem; box-shadow:0 8px 30px rgba(0,0,0,0.6); }

        /* app layout */
        #dApp { display:none; height:100vh; width:100%; position:relative; }
        #map { height:100%; width:100%; }

        /* top controls */
        #mainMenuBtn { position: absolute; top: 14px; left: 14px; z-index: 2200; background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); padding:10px 12px; border-radius:12px; cursor:pointer; color:var(--accent); font-weight:800; }
        #onlinePill { position:absolute; top:14px; right:14px; z-index:2200; display:flex; gap:8px; align-items:center; }
        .pill { padding:8px 10px; border-radius:999px; background:var(--glass); border:1px solid rgba(255,255,255,0.03); font-weight:800; color:var(--muted); }
        .pill.online { background: linear-gradient(90deg,#012b12,#013f1c); color:var(--success); border:1px solid rgba(46,204,113,0.12); }
        .pill.offline { background: linear-gradient(90deg,#20070a,#2a0810); color:var(--danger); border:1px solid rgba(255,107,107,0.08); }

        #menuBox { position: absolute; top: 64px; left: 14px; z-index: 2200; display:none; background:rgba(8,10,18,0.95); border:1px solid rgba(255,255,255,0.03); padding:10px; border-radius:12px; width:230px; box-shadow:0 12px 40px rgba(2,6,23,0.7); }
        .menu-item { padding:10px 12px; border-radius:8px; cursor:pointer; color:var(--accent); font-weight:800; margin-bottom:8px; background:transparent; display:flex; justify-content:space-between; align-items:center; }
        .menu-item .muted { font-weight:600; color:var(--muted); font-size:0.9rem; }

        /* cards */
        .card { position: absolute; left:12px; right:12px; bottom:18px; background: rgba(8,10,18,0.9); border-radius:14px; padding:18px; z-index:2100; border:1px solid rgba(255,255,255,0.03); display:none; box-shadow: 0 10px 38px rgba(0,0,0,0.7); }
        .fare-txt { font-size: 2.6rem; font-weight: 900; color: var(--accent); margin-bottom:6px; }
        .info-row { display:flex; justify-content:space-between; gap:10px; margin-bottom:12px; }
        .info-col { text-align:center; width:48%; background:rgba(255,255,255,0.02); padding:8px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }
        .lbl { font-size:0.75rem; color:var(--muted); }
        .val { font-size:1.1rem; font-weight:900; color:#fff; }

        .btn-row { display:flex; gap:10px; margin-top:12px; }
        .accept-btn { flex:1; padding:12px; background:var(--accent); color:#041022; font-weight:900; border:none; border-radius:10px; cursor:pointer; }
        .skip-btn { flex:1; padding:12px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); border-radius:10px; cursor:pointer; }

        .contact-btn{ display:block; background:var(--success); color:#041022; padding:12px; border-radius:10px; font-weight:800; text-decoration:none; margin-bottom:8px; text-align:center; }
        .map-nav-btn{ display:block; background:#0b76ff; color:white; padding:12px; border-radius:10px; font-weight:800; text-align:center; margin-bottom:8px; text-decoration:none; }

        /* small controls */
        .recenter-btn { position: absolute; bottom: 300px; right: 16px; width: 46px; height: 46px; background: rgba(255,255,255,0.95); color:black; border-radius: 12px; display:flex; align-items:center; justify-content:center; font-size:20px; z-index:2100; box-shadow:0 8px 24px rgba(0,0,0,0.6); cursor:pointer; }

        /* footer signature */
        #signature { position: absolute; bottom: 8px; left:0; right:0; text-align:center; font-size:0.85rem; color:var(--muted); z-index:2200; pointer-events:none; font-weight:700; }
        #signature span { color:var(--accent); font-family:monospace; letter-spacing:2px; }

        /* modals */
        .modal { position: fixed; inset: 0; display:none; align-items:center; justify-content:center; z-index:3000; background: rgba(0,0,0,0.6); }
        .modal-card { background:var(--card); padding:16px; border-radius:12px; width:92%; max-width:520px; border:1px solid rgba(255,255,255,0.03); color:var(--accent); }

        /* responsive */
        @media(min-width:780px){ #menuBox{ width:260px } .d-inp { width:420px } .d-btn { width:420px } }
    </style>
</head>
<body>

    <audio id="ringtone" src="https://media.geeksforgeeks.org/wp-content/uploads/20190531135120/beep.mp3" loop></audio>

    <div id="dLoginScreen">
        <div class="logo">MS PARTNER</div>
        <input id="dPhone" class="d-inp" type="tel" placeholder="Enter Mobile Number">
        <button class="d-btn" onclick="startDuty()">START DUTY</button>
        <p style="color:var(--muted); font-size:0.9rem; margin-top:8px;">One-time login ‚Äî your number will be remembered locally.</p>
    </div>

    <div id="dApp">
        <div id="mainMenuBtn" onclick="toggleMenu()">‚ò∞ MENU</div>

        <div id="onlinePill">
            <div id="statusPill" class="pill offline">OFFLINE</div>
            <button id="goToggleBtn" class="pill" style="cursor:pointer" onclick="toggleOnline()">Go Online</button>
        </div>

        <div id="menuBox">
            <div class="menu-item" onclick="showTodayEarnings()">Today Earnings <div class="muted" id="earnTodaySub">‚Çπ0</div></div>
            <div class="menu-item" onclick="showPartnerHistory()">History <div class="muted">Recent</div></div>
            <div class="menu-item" onclick="openVehicleModal()">Change Vehicle <div class="muted" id="currVehicle">‚Äî</div></div>
            <div class="menu-item" onclick="logoutAndClear()">Logout <div class="muted">Clear</div></div>
        </div>

        <div id="map"></div>
        <div class="recenter-btn" onclick="recenterMap()">üéØ</div>

        <!-- request card -->
        <div id="reqPopup" class="card">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
                <div id="reqIcon" style="width:46px;height:46px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;font-size:22px">üöó</div>
                <div style="flex:1">
                    <div style="font-weight:900;color:#fff">NEW RIDE REQUEST</div>
                    <div style="color:var(--muted);font-size:0.9rem">Match vehicle & nearby</div>
                </div>
            </div>
            <div class="fare-txt">‚Çπ<span id="fareDisplay">0</span></div>
            <div class="info-row">
                <div class="info-col"><div class="lbl">PICKUP DIST</div><div class="val" id="pickupDist">...</div></div>
                <div class="info-col"><div class="lbl">TRIP DIST</div><div class="val" id="tripDist">...</div></div>
            </div>
            <div class="btn-row">
                <button class="skip-btn" onclick="skipRide()">SKIP ‚úï</button>
                <button class="accept-btn" onclick="tryAcceptRide()">ACCEPT ‚úì</button>
            </div>
        </div>

        <!-- pickup card -->
        <div id="pickupCard" class="card" style="border-top:3px solid rgba(212,175,55,0.12);">
            <div style="font-weight:900;color:var(--accent)">HEADING TO PICKUP</div>
            <div style="color:var(--muted);font-size:0.85rem;margin-top:8px">CUSTOMER</div>
            <div id="custMobDisp" style="font-weight:900;font-size:1.3rem;margin-top:6px">‚Äî</div>
            <button id="mapNavBtnPickup" class="map-nav-btn" onclick="openPickupMap()">üó∫Ô∏è GO TO PICKUP</button>
            <a id="callBtn" class="contact-btn" href="#">üìû CALL CUSTOMER</a>
            <div class="otp-box">
                <div style="color:var(--muted); font-size:0.75rem">ENTER OTP TO START TRIP</div>
                <div class="otp-row" style="display:flex;gap:10px;margin-top:8px">
                    <input type="number" id="otpIn" class="otp-inp" placeholder="XXXX" style="flex:1;padding:10px;border-radius:8px;background:#000;border:1px solid rgba(212,175,55,0.12);color:var(--accent)">
                    <button class="go-btn" onclick="verifyOtp()" style="padding:10px 14px;border-radius:8px;border:none;background:var(--accent);font-weight:900;color:#041022">START</button>
                </div>
            </div>
            <button onclick="cancelRide()" style="width:100%; margin-top:10px; background:var(--danger); color:#fff; border:none; padding:10px; font-weight:800; border-radius:8px;">CANCEL RIDE</button>
        </div>

        <!-- drop card -->
        <div id="dropCard" class="card" style="border-top:3px solid rgba(46,204,113,0.12);">
            <div style="font-weight:900;color:var(--success)">ON TRIP</div>
            <p style="color:var(--muted)">Navigating to Drop Location...</p>
            <h2 style="color:var(--accent); margin:8px 0">Follow Map Route</h2>
            <button id="mapNavBtnDrop" class="map-nav-btn" onclick="openDropMap()">üó∫Ô∏è GO TO DROP</button>
            <button class="finish-btn" onclick="completeRide()" style="border:1px solid rgba(255,255,255,0.04);">END TRIP & GET BILL</button>
        </div>

        <!-- vehicle modal -->
        <div id="vehicleModal" class="modal">
            <div class="modal-card">
                <h3 style="margin:0 0 10px 0;color:var(--accent)">Select Vehicle</h3>
                <div style="display:flex;gap:10px;justify-content:space-between">
                    <button class="accept-btn" onclick="chooseVehicle('car')" style="flex:1">üöó Car</button>
                    <button class="accept-btn" onclick="chooseVehicle('auto')" style="flex:1">üõ∫ Auto</button>
                    <button class="accept-btn" onclick="chooseVehicle('bike')" style="flex:1">üèçÔ∏è Bike</button>
                </div>
                <div style="margin-top:12px;text-align:right"><button onclick="closeVehicleModal()" class="skip-btn">CANCEL</button></div>
            </div>
        </div>

        <!-- earn modal -->
        <div id="earnModal" class="modal"><div class="modal-card"><h3 style="color:var(--accent);margin:0">Today's Earnings</h3><div id="earnContent" style="font-size:1.6rem;font-weight:900;margin-top:12px;color:#fff">‚Çπ0</div><div style="margin-top:12px;text-align:right"><button onclick="closeEarnModal()" class="skip-btn">CLOSE</button></div></div></div>

        <!-- history modal -->
        <div id="histModal" class="modal"><div class="modal-card"><h3 style="color:var(--accent);margin:0">My Rides</h3><div id="histList" style="max-height:60vh;overflow:auto;margin-top:10px"></div><div style="margin-top:12px;text-align:right"><button onclick="closeHistModal()" class="skip-btn">CLOSE</button></div></div></div>

        <!-- signature footer -->
        <div id="signature">design by <span>·ó∞·ëå·îñT·ó©·ë´EE·ó∞</span></div>
    </div>

<!-- End of PART 1 -->
    <!-- PART 2A: paste this first (external libs + first half script) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCJpo25tYCN_fXP8aCckgA4WrD962KCsQ8",
        authDomain: "hyd-texi.firebaseapp.com",
        projectId: "hyd-texi",
        storageBucket: "hyd-texi.firebasestorage.app",
        messagingSenderId: "807048727786",
        appId: "1:807048727786:web:7ef03573876c70b76e1b93",
        databaseURL: "https://hyd-texi-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let map, driverMarker, driverLat, driverLng, driverMobile;
    let currentReqKey, currentReqData, routeLine, pickupMarker, dropMarker;
    let followDriver = true;
    let gpsWatchId = null;
    let isRequesting = false;
    let partnerObj = null;

    // vehicle -> icon mapping (emoji + marker color)
    const VEHICLE_ICONS = {
        car: { emoji: 'üöó', color: '#d4af37' },
        auto: { emoji: 'üõ∫', color: '#00aaff' },
        bike: { emoji: 'üèçÔ∏è', color: '#ff8c42' },
        unknown: { emoji: 'üöô', color: '#888' }
    };

    // auto-fill phone if saved
    if (localStorage.getItem('msPartnerMobile')) {
        const saved = localStorage.getItem('msPartnerMobile');
        if (saved) document.getElementById('dPhone').value = saved;
    }

    // small dialog helpers (kept)
    const customDialog = document.getElementById('customDialog');
    const customDialogTitle = document.getElementById('customDialogTitle');
    const customDialogMessage = document.getElementById('customDialogMessage');
    const customDialogOk = document.getElementById('customDialogOk');
    const customDialogCancel = document.getElementById('customDialogCancel');

    function showCustomConfirm(title, message, onOk, onCancel) {
        customDialogTitle.innerText = title || 'Confirm';
        customDialogMessage.innerText = message || '';
        customDialog.style.display = 'flex';
        customDialogOk.style.display = 'inline-block';
        customDialogCancel.style.display = 'inline-block';
        function cleanup(){ customDialog.style.display='none'; customDialogOk.removeEventListener('click',okHandler); customDialogCancel.removeEventListener('click',cancelHandler); }
        function okHandler(){ cleanup(); if(onOk) onOk(); }
        function cancelHandler(){ cleanup(); if(onCancel) onCancel(); }
        customDialogOk.addEventListener('click', okHandler);
        customDialogCancel.addEventListener('click', cancelHandler);
    }
    function showCustomAlert(title, message, onOk){ customDialogTitle.innerText=title||'Alert'; customDialogMessage.innerText=message||''; customDialog.style.display='flex'; customDialogCancel.style.display='none'; customDialogOk.style.display='inline-block'; function cleanup(){ customDialog.style.display='none'; customDialogOk.removeEventListener('click',okHandler); } function okHandler(){ cleanup(); if(onOk) onOk(); } customDialogOk.addEventListener('click', okHandler); }

    function speak(text) {
        try { if (window.Android && typeof window.Android.speak === 'function') { window.Android.speak(text); return; } } catch(e){}
        if ('speechSynthesis' in window) { try{ window.speechSynthesis.cancel(); const ut=new SpeechSynthesisUtterance(text); ut.lang='en-US'; window.speechSynthesis.speak(ut); return;} catch(e){} }
        try { const r=document.getElementById('ringtone'); if(r){ r.play().catch(()=>{}); setTimeout(()=>{ try{ r.pause(); r.currentTime=0; }catch(e){} },1400); } } catch(e){}
    }

    // START DUTY
    function startDuty(){
        const num = document.getElementById('dPhone').value.trim();
        if(num.length<10) return showCustomAlert('Invalid','Enter a valid mobile number');
        driverMobile = num;
        localStorage.setItem('msPartnerMobile', driverMobile);

        // hide login
        document.getElementById('dLoginScreen').style.display='none';
        document.getElementById('dApp').style.display='block';
        document.getElementById('helpBtn').style.display='block';

        initializeMap([17.3850,78.4867],13);
        startGPSCheck();

        // load partner profile and update UI
        db.ref('partners/' + driverMobile).once('value').then(snap=>{
            const data = snap.val();
            if (data) {
                partnerObj = data;
                document.getElementById('currVehicle').innerText = (partnerObj.vehicleType || '‚Äî').toUpperCase();
                updateOnlinePill(!!partnerObj.isOnline);
                // set marker icon to chosen vehicle
                setDriverMarkerIcon(partnerObj.vehicleType || 'car');
            } else {
                // ask to choose vehicle
                openVehicleModal();
            }
        }).catch(err=>{ console.warn(err); openVehicleModal(); });

        startListening();
        speak("Service started. Welcome partner.");
    }

    // map init with dynamic driver marker creation
    function initializeMap(initialLatlng, initialZoom){
        if(map) return;
        map = L.map('map', {zoomControl:false}).setView(initialLatlng, initialZoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        // default marker
        createDriverMarker(initialLatlng);
    }

    function createDriverMarker(latlng){
        const v = partnerObj && partnerObj.vehicleType ? partnerObj.vehicleType : 'car';
        const cfg = VEHICLE_ICONS[v] || VEHICLE_ICONS.unknown;
        const html = `<div style="width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:${cfg.color};color:#081018;font-size:26px;border:3px solid rgba(0,0,0,0.25)">${cfg.emoji}</div>`;
        const icon = L.divIcon({ html, className:'', iconSize:[56,56], iconAnchor:[28,56] });
        driverMarker = L.marker(latlng, {icon, draggable:true}).addTo(map).bindPopup("You ‚Ä¢ " + (partnerObj? partnerObj.vehicleType : 'partner'));
        driverMarker.on('dragend', (e)=>{ const p=driverMarker.getLatLng(); driverLat=p.lat; driverLng=p.lng; followDriver=false; if(driverMobile) db.ref('partners/' + driverMobile + '/lastSeen').set({lat:driverLat,lng:driverLng,ts:Date.now()}); });
    }

    function setDriverMarkerIcon(vehicleKey){
        if (!driverMarker) return;
        const cfg = VEHICLE_ICONS[vehicleKey] || VEHICLE_ICONS.unknown;
        const html = `<div style="width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:${cfg.color};color:#081018;font-size:26px;border:3px solid rgba(0,0,0,0.25)">${cfg.emoji}</div>`;
        const icon = L.divIcon({ html, className:'', iconSize:[56,56], iconAnchor:[28,56] });
        driverMarker.setIcon(icon);
    }

    const GPS_HELP_TEXT = "GPS not available ‚Äî drag the car icon to your location to receive bookings.";

    function startGPSCheck(){
        if(!navigator.geolocation){ showCustomAlert('GPS Not Supported', GPS_HELP_TEXT); speak(GPS_HELP_TEXT); return; }
        navigator.geolocation.getCurrentPosition(pos=>{
            driverLat = pos.coords.latitude; driverLng = pos.coords.longitude;
            if(driverMarker) driverMarker.setLatLng([driverLat,driverLng]);
            map.setView([driverLat,driverLng],15);
            if(!gpsWatchId) gpsWatchId = navigator.geolocation.watchPosition(onPositionUpdate, onGPSError, {enableHighAccuracy:true,maximumAge:3000});
        }, err=>{
            console.warn('gps err',err); showCustomAlert('GPS Unavailable',GPS_HELP_TEXT); speak(GPS_HELP_TEXT);
            if(!gpsWatchId) gpsWatchId = navigator.geolocation.watchPosition(onPositionUpdate, onGPSError, {enableHighAccuracy:true,maximumAge:3000});
        }, {enableHighAccuracy:true,timeout:6000});
    }

    function onPositionUpdate(pos){
        driverLat = pos.coords.latitude; driverLng = pos.coords.longitude;
        if(driverMarker) driverMarker.setLatLng([driverLat,driverLng]);
        if(followDriver && map) map.panTo([driverLat,driverLng]);
        if(driverMobile) db.ref('partners/' + driverMobile + '/lastSeen').set({lat:driverLat,lng:driverLng,ts:Date.now()});
    }

    function onGPSError(err){
        console.error('gps err',err); followDriver=false; if(gpsWatchId){ navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId=null; }
        showCustomAlert('GPS Error', GPS_HELP_TEXT); speak(GPS_HELP_TEXT);
    }

    function recenterMap(){ followDriver=true; if(driverLat && driverLng){ map.setView([driverLat,driverLng], map.getZoom()<14?16:map.getZoom()); speak('Centered'); } else { const c=map.getCenter(); driverLat=c.lat; driverLng=c.lng; if(driverMarker) driverMarker.setLatLng([driverLat,driverLng]); map.setView([driverLat,driverLng],map.getZoom()); speak('Location set'); } }

    // ---------------- request listening & vehicle matching ----------------
    function requestListener(snap){
        if(isRequesting) return;
        const data = snap.val();
        if(!data) return;
        if(data.status !== 'pending') return;
        if(!driverLat || !driverLng) return;
        // vehicle match
        const reqV = (data.vehicleType||'').toLowerCase();
        const myV = (partnerObj && partnerObj.vehicleType) ? partnerObj.vehicleType.toLowerCase() : null;
        if(myV && reqV !== myV) return;
        const dist = getDist(driverLat, driverLng, data.pickupLat, data.pickupLng);
        if(dist <= 2.2){ // small radius
            isRequesting = true;
            try{ document.getElementById('ringtone').play().catch(()=>{}); }catch(e){}
            speak(`New ${reqV} request. Fare ${data.price}. Pickup ${dist.toFixed(1)} km`);
            showRequest(data, snap.key, dist.toFixed(1));
        }
    }

    function startListening(){
        db.ref('requests').limitToLast(20).on('child_added', requestListener);
        db.ref('requests').limitToLast(20).on('child_changed', requestListener);
    }
    function stopListening(){ db.ref('requests').limitToLast(20).off('child_added', requestListener); db.ref('requests').limitToLast(20).off('child_changed', requestListener); }

    function showRequest(data, key, pKM){
        currentReqKey = key; currentReqData = data;
        // set vehicle icon in request card
        const vkey = (data.vehicleType || 'unknown').toLowerCase();
        const cfg = VEHICLE_ICONS[vkey] || VEHICLE_ICONS.unknown;
        document.getElementById('reqIcon').innerText = cfg.emoji;
        document.getElementById('reqIcon').style.background = 'rgba(255,255,255,0.02)';
        document.getElementById('fareDisplay').innerText = data.price || 0;
        document.getElementById('pickupDist').innerText = pKM + ' KM';
        document.getElementById('tripDist').innerText = data.distance || '‚Äî';
        if(pickupMarker) map.removeLayer(pickupMarker);
        const personIcon = L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/236/236831.png', iconSize:[36,36], iconAnchor:[18,36] });
        pickupMarker = L.marker([data.pickupLat, data.pickupLng], {icon:personIcon}).addTo(map).bindPopup("Pickup ‚Ä¢ " + (data.customerMobile||''));
        map.setView([data.pickupLat, data.pickupLng], 15);
        document.getElementById('reqPopup').style.display='block';
    }

    // accept w/ transaction + driverVehicle written
    function tryAcceptRide(){
        try{ document.getElementById('ringtone').pause(); }catch(e){}
        stopListening();
        if(!partnerObj || !partnerObj.vehicleType){ speak('Please choose vehicle.'); openVehicleModal(); isRequesting=false; startListening(); return; }

        db.ref('requests/' + currentReqKey).transaction(curr=>{
            if(curr === null) return curr;
            if(curr.status === 'pending'){
                return {
                    ...curr,
                    status:'accepted',
                    driverMobile: driverMobile,
                    driverVehicle: partnerObj.vehicleType || 'unknown',
                    driverId: partnerObj.partnerId || driverMobile,
                    acceptedAt: Date.now()
                };
            } else return;
        }, function(error, committed, snapshot){
            if(!committed){
                showCustomAlert('Missed','Booking missed by another driver or cancelled.');
                document.getElementById('reqPopup').style.display='none';
                if(pickupMarker) map.removeLayer(pickupMarker);
                isRequesting=false; startListening();
            } else {
                currentReqData = snapshot.val();
                // update partner history
                db.ref('partners/' + driverMobile + '/history').push({ reqId: currentReqKey, price: currentReqData.price||0, status:'accepted', ts:Date.now() });
                // ensure partner saved
                if(!partnerObj.partnerId){
                    partnerObj.partnerId = 'P' + (Math.floor(100000 + Math.random()*900000));
                    partnerObj.mobile = driverMobile;
                    db.ref('partners/' + driverMobile).set(partnerObj);
                }
                // set partner online flag true
                db.ref('partners/' + driverMobile + '/isOnline').set(true);
                updateOnlinePill(true);
                rideSecured();
            }
        });
    }
           </script>
           <!-- PART 2B: continuation -->
<script>
    function rideSecured(){
        document.getElementById('reqPopup').style.display='none';
        document.getElementById('pickupCard').style.display='block';
        document.getElementById('custMobDisp').innerText = currentReqData.customerMobile || '‚Äî';
        document.getElementById('callBtn').href = 'tel:' + (currentReqData.customerMobile || '');
        drawRoute(driverLat, driverLng, currentReqData.pickupLat, currentReqData.pickupLng, VEHICLE_ICONS[(currentReqData.vehicleType||'unknown').toLowerCase()].color || '#d4af37');
        if(pickupMarker) pickupMarker.openPopup();
    }

    function openPickupMap(){
        if(!currentReqData) return showCustomAlert('Error','No pickup data');
        const pLat=currentReqData.pickupLat, pLng=currentReqData.pickupLng;
        const url=`https://www.google.com/maps/dir/?api=1&origin=${driverLat},${driverLng}&destination=${pLat},${pLng}&travelmode=driving`;
        window.open(url,'_blank'); speak('Opening navigation');
    }

    function openDropMap(){
        if(!currentReqData || !currentReqData.dropLat || !currentReqData.dropLng) return showCustomAlert('Error','Drop missing');
        const dLat=currentReqData.dropLat, dLng=currentReqData.dropLng;
        const url=`https://www.google.com/maps/dir/?api=1&origin=${currentReqData.pickupLat},${currentReqData.pickupLng}&destination=${dLat},${dLng}&travelmode=driving`;
        window.open(url,'_blank'); speak('Opening navigation to drop');
    }

    function verifyOtp(){
        const entered=document.getElementById('otpIn').value;
        if(!currentReqData) return showCustomAlert('Error','No request data');
        if(entered == currentReqData.otp){
            speak('OTP verified. Trip started.');
            db.ref('requests/' + currentReqKey).update({ status:'started', startedAt:Date.now() });
            document.getElementById('pickupCard').style.display='none';
            document.getElementById('dropCard').style.display='block';
            if(pickupMarker) map.removeLayer(pickupMarker);
            if(currentReqData.dropLat && currentReqData.dropLng){
                drawRoute(currentReqData.pickupLat,currentReqData.pickupLng,currentReqData.dropLat,currentReqData.dropLng,'#2ecc71');
                if(dropMarker) map.removeLayer(dropMarker);
                dropMarker = L.marker([currentReqData.dropLat,currentReqData.dropLng]).addTo(map).bindPopup('Drop');
            } else {
                showCustomAlert('No Drop','Drop coords not provided. Ask passenger.');
            }
        } else {
            speak('Wrong OTP'); showCustomAlert('Wrong OTP','Please check the OTP with passenger.');
        }
    }

    function completeRide(){
        if(!currentReqKey || !currentReqData) return;
        db.ref('requests/' + currentReqKey).update({ status:'completed', completedAt:Date.now() }).then(()=>{
            document.getElementById('dropCard').style.display='none';
            document.getElementById('billModal').style.display='flex';
            document.getElementById('billAmount').innerText = '‚Çπ' + (currentReqData.price || 0);
            speak('Trip complete. Collect cash.');
            // update partner history node as completed
            if(driverMobile) db.ref('partners/' + driverMobile + '/history').push({ reqId: currentReqKey, price: currentReqData.price||0, status:'completed', ts:Date.now() });
            // cleanup
            if(routeLine) map.removeLayer(routeLine);
            if(pickupMarker) map.removeLayer(pickupMarker);
            if(dropMarker) map.removeLayer(dropMarker);
            currentReqData=null; currentReqKey=null; isRequesting=false;
            startListening();
        }).catch(err=>{ console.warn(err); showCustomAlert('Error','Could not mark completed'); });
    }

    function closeBillAndNext(){ document.getElementById('billModal').style.display='none'; isRequesting=false; startListening(); }

    function skipRide(){ try{ document.getElementById('ringtone').pause(); }catch(e){} document.getElementById('reqPopup').style.display='none'; if(pickupMarker) map.removeLayer(pickupMarker); isRequesting=false; speak('Skipped'); startListening(); }

    function cancelRide(){
        showCustomConfirm('Cancel Ride','Are you sure?', function ok(){
            if(!currentReqKey) return showCustomAlert('No ride','No active ride to cancel.');
            db.ref('requests/' + currentReqKey).update({ status:'cancelled' }).then(()=>{ isRequesting=false; location.reload(); }).catch(()=> showCustomAlert('Error','Cancel failed'));
        }, function cancel(){});
    }

    function drawRoute(lat1,lng1,lat2,lng2,color){
        if(routeLine) map.removeLayer(routeLine);
        var latlngs = [[lat1,lng1],[lat2,lng2]];
        routeLine = L.polyline(latlngs,{color:color||'#d4af37', weight:5}).addTo(map);
        map.fitBounds(routeLine.getBounds(), {padding:[40,40]});
    }

    function getDist(lat1,lon1,lat2,lon2){
        var R=6371; var dLat=(lat2-lat1)*(Math.PI/180); var dLon=(lon2-lon1)*(Math.PI/180);
        var a=Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180))*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
    }

    // vehicle modal actions
    function openVehicleModal(){ document.getElementById('vehicleModal').style.display='flex'; }
    function closeVehicleModal(){ document.getElementById('vehicleModal').style.display='none'; }

    function chooseVehicle(v){
        partnerObj = partnerObj || {};
        partnerObj.vehicleType = v;
        partnerObj.mobile = driverMobile;
        partnerObj.partnerId = partnerObj.partnerId || ('P' + (Math.floor(100000 + Math.random()*900000)));
        db.ref('partners/' + driverMobile).update({ vehicleType:v, partnerId:partnerObj.partnerId, mobile:driverMobile, updatedAt:Date.now(), isOnline:true }).then(()=>{
            showCustomAlert('Saved','Vehicle set to '+v.toUpperCase());
            document.getElementById('currVehicle').innerText = v.toUpperCase();
            setDriverMarkerIcon(v);
            closeVehicleModal();
            startListening();
            updateOnlinePill(true);
        }).catch(err=>{ console.warn(err); showCustomAlert('Error','Could not save vehicle'); });
    }

    function setDriverMarkerIcon(vehicleKey){
        if(!driverMarker) { createDriverMarker([driverLat||17.3850, driverLng||78.4867]); return; }
        const cfg = VEHICLE_ICONS[vehicleKey] || VEHICLE_ICONS.unknown;
        const html = `<div style="width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:${cfg.color};color:#081018;font-size:26px;border:3px solid rgba(0,0,0,0.25)">${cfg.emoji}</div>`;
        const icon = L.divIcon({ html, className:'', iconSize:[56,56], iconAnchor:[28,56] });
        driverMarker.setIcon(icon);
    }

    // online/offline toggle and pill UI
    function toggleOnline(){
        if(!driverMobile) return showCustomAlert('Login','Please login first.');
        const currently = partnerObj && partnerObj.isOnline;
        const next = !currently;
        partnerObj = partnerObj || {};
        partnerObj.isOnline = next;
        db.ref('partners/' + driverMobile + '/isOnline').set(next).then(()=>{
            updateOnlinePill(next);
            speak(next ? 'You are online' : 'You are offline');
        }).catch(err=>{ console.warn(err); showCustomAlert('Error','Could not change status'); });
    }

    function updateOnlinePill(isOnline){
        const pill = document.getElementById('statusPill');
        const btn = document.getElementById('goToggleBtn');
        if(isOnline){
            pill.classList.remove('offline'); pill.classList.add('online'); pill.innerText='ONLINE';
            btn.innerText='Go Offline';
        } else {
            pill.classList.remove('online'); pill.classList.add('offline'); pill.innerText='OFFLINE';
            btn.innerText='Go Online';
        }
    }

    // earnings & history
    async function showTodayEarnings(){
        if(!driverMobile) return showCustomAlert('Login','Please login first.');
        const now=new Date(); const start=new Date(now.getFullYear(),now.getMonth(),now.getDate()).getTime();
        const snap = await db.ref('requests').orderByChild('driverMobile').equalTo(driverMobile).once('value');
        const data = snap.val() || {};
        let total=0;
        Object.values(data).forEach(r=>{ if(r.status==='completed' && r.completedAt && r.completedAt>=start) total += Number(r.price||0); });
        document.getElementById('earnContent').innerText = '‚Çπ' + total;
        document.getElementById('earnModal').style.display='flex';
        document.getElementById('earnTodaySub').innerText = '‚Çπ' + total;
    }
    function closeEarnModal(){ document.getElementById('earnModal').style.display='none'; }

    async function showPartnerHistory(){
        if(!driverMobile) return showCustomAlert('Login','Please login first.');
        const snap = await db.ref('requests').orderByChild('driverMobile').equalTo(driverMobile).limitToLast(80).once('value');
        const data = snap.val() || {};
        const listDom = document.getElementById('histList'); listDom.innerHTML='';
        const items = Object.keys(data).map(k=>({id:k,val:data[k]})).sort((a,b)=>(b.val.completedAt||b.val.timestamp||0)-(a.val.completedAt||a.val.timestamp||0));
        if(items.length===0) listDom.innerHTML='<div style="padding:12px;color:#aaa">No rides yet</div>';
        items.forEach(it=>{
            const v=it.val;
            const row=document.createElement('div'); row.style.padding='10px'; row.style.borderBottom='1px solid rgba(255,255,255,0.03)';
            row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
                <div><div style="font-weight:900">‚Çπ${v.price||0} ‚Ä¢ ${v.vehicleType||''}</div><div style="color:var(--muted)">${v.status||''}</div></div>
                <div style="text-align:right"><div style="font-size:0.8rem;color:var(--muted)">${v.completedAt? new Date(v.completedAt).toLocaleString(): (v.timestamp? new Date(v.timestamp).toLocaleString():'‚Äî')}</div><div style="margin-top:6px;color:var(--muted)">${v.customerMobile||''}</div></div>
            </div>`;
            listDom.appendChild(row);
        });
        document.getElementById('histModal').style.display='flex';
    }
    function closeHistModal(){ document.getElementById('histModal').style.display='none'; }

    function logoutAndClear(){
        showCustomConfirm('Logout','Clear saved mobile and logout?', function ok(){
            localStorage.removeItem('msPartnerMobile');
            if(driverMobile) db.ref('partners/' + driverMobile + '/isOnline').set(false);
            location.reload();
        }, function cancel(){});
    }

    // cleanup on unload
    window.addEventListener('beforeunload', ()=>{ if(driverMobile) db.ref('partners/' + driverMobile + '/isOnline').set(false); stopListening(); });

    // expose functions globally for buttons
    window.startDuty = startDuty; window.toggleMenu = function(){ const m=document.getElementById('menuBox'); m.style.display=(m.style.display==='block')?'none':'block'; };
    window.openVehicleModal = openVehicleModal; window.chooseVehicle = chooseVehicle; window.showTodayEarnings = showTodayEarnings;
    window.showPartnerHistory = showPartnerHistory; window.openHelp = function(){ document.getElementById('helpModal').style.display='flex'; speak('Help opened'); };
    window.closeHelp = function(){ document.getElementById('helpModal').style.display='none'; speak('Help closed'); };
</script>
</body>
</html>
